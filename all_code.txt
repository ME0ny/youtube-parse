
=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\.gitignore ===

node_modules/
*.csv

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\.gitignore ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\manifest.json ===

{
    "manifest_version": 3,
    "name": "YouTube –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ü–∞—Ä—Å–µ—Ä OS",
    "version": "1.0.0",
    "description": "–ù–æ–≤—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ YouTube.",
    "icons": {
        "16": "icons/icon16.png"
    },
    "action": {
        "default_popup": "popup/popup.html",
        "default_icon": {
            "16": "icons/icon16.png"
        }
    },
    "background": {
        "service_worker": "background/background.js",
        "type": "module"
    },
    "content_scripts": [
        {
            "matches": [
                "*://*.youtube.com/*"
            ],
            "js": [
                "content/modules/scroller.js",
                "content/modules/parser.js",
                "content/modules/scraper.js",
                "content/modules/video-checker.js",
                "content/content.js"
            ],
            "run_at": "document_idle"
        }
    ],
    "permissions": [
        "activeTab",
        "scripting",
        "storage",
        "tabs"
    ],
    "host_permissions": [
        "*://*.youtube.com/*"
    ]
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\manifest.json ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\package-lock.json ===

{
  "name": "youtube-parser-os",
  "lockfileVersion": 3,
  "requires": true,
  "packages": {
    "": {
      "dependencies": {
        "dexie": "^4.2.0"
      }
    },
    "node_modules/dexie": {
      "version": "4.2.0",
      "resolved": "https://registry.npmjs.org/dexie/-/dexie-4.2.0.tgz",
      "integrity": "sha512-OSeyyWOUetDy9oFWeddJgi83OnRA3hSFh3RrbltmPgqHszE9f24eUCVLI4mPg0ifsWk0lQTdnS+jyGNrPMvhDA==",
      "license": "Apache-2.0"
    }
  }
}


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\package-lock.json ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\package.json ===

{
  "dependencies": {
    "dexie": "^4.2.0"
  }
}


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\package.json ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageLogAdapter.js ===

// adapters/ChromeStorageLogAdapter.js
import { Logger } from '../core/logger.js'; // –î–ª—è —Ç–∏–ø–æ–≤

/**
 * @typedef {import('../core/types/log.types.js').LogEntry} LogEntry
 * @typedef {import('../core/types/log.types.js').LogAdapter} LogAdapter
 */

export class ChromeStorageLogAdapter {
    /** @type {string} */
    #storageKey;
    /** @type {number} */
    #maxSize;

    /**
     * @param {Object} options
     * @param {string} [options.storageKey='appLogs']
     * @param {number} [options.maxSize=500]
     */
    constructor(options = {}) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å chrome.storage.local
        if (typeof chrome === 'undefined' || !chrome.storage || !chrome.storage.local) {
            throw new Error('ChromeStorageLogAdapter: chrome.storage.local is not available.');
        }

        this.#storageKey = options.storageKey ?? 'appLogs';
        this.#maxSize = options.maxSize ?? 500;
    }

    /**
     * @param {LogEntry} entry
     * @returns {Promise<void>}
     */
    async write(entry) {
        try {
            const logs = await this.read();
            logs.push(entry);
            if (logs.length > this.#maxSize) {
                logs.splice(0, logs.length - this.#maxSize);
            }
            await chrome.storage.local.set({ [this.#storageKey]: logs });
        } catch (e) {
            console.error("[ChromeStorageLogAdapter] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:", e);
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –∞–¥–∞–ø—Ç–µ—Ä–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É –∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ
            // throw e;
        }
    }

    /**
     * @returns {Promise<LogEntry[]>}
     */
    async read() {
        try {
            const result = await chrome.storage.local.get([this.#storageKey]);
            return result[this.#storageKey] || [];
        } catch (e) {
            console.error("[ChromeStorageLogAdapter] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:", e);
            return [];
        }
    }

    /**
     * @returns {Promise<void>}
     */
    async clear() {
        try {
            await chrome.storage.local.remove([this.#storageKey]);
        } catch (e) {
            console.error("[ChromeStorageLogAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:", e);
        }
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageLogAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageTableAdapter.js ===

// adapters/ChromeStorageTableAdapter.js

/**
 * @typedef {import('../core/types/table.types.js').VideoData} VideoData
 * @typedef {import('../core/types/table.types.js').TableAdapter} TableAdapter
 */

export class ChromeStorageTableAdapter {
    /** @type {string} */
    #storageKey;
    /** @type {number} */
    #maxSize;

    /**
     * @param {Object} options
     * @param {string} [options.storageKey='parsedVideos']
     * @param {number} [options.maxSize=100000]
     */
    constructor(options = {}) {
        if (typeof chrome === 'undefined' || !chrome.storage || !chrome.storage.local) {
            throw new Error('ChromeStorageTableAdapter: chrome.storage.local is not available.');
        }

        this.#storageKey = options.storageKey ?? 'parsedVideos';
        this.#maxSize = options.maxSize ?? 100000; // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    }

    /**
     * @param {VideoData} videoData
     * @returns {Promise<void>}
     */
    async add(videoData) {
        try {
            const allData = await this.getAll();
            allData.push(videoData);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä, —É–¥–∞–ª—è—è —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å –Ω–∞—á–∞–ª–∞
            if (allData.length > this.#maxSize) {
                allData.splice(0, allData.length - this.#maxSize);
            }

            await chrome.storage.local.set({ [this.#storageKey]: allData });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º popup'–∞–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            this.#broadcastDataUpdate();
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏:", e);
            throw e;
        }
    }

    /**
     * @param {VideoData[]} videoDataArray
     * @returns {Promise<void>}
     */
    async addBatch(videoDataArray) {
        if (!Array.isArray(videoDataArray) || videoDataArray.length === 0) {
            return;
        }

        try {
            const allData = await this.getAll();
            allData.push(...videoDataArray);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            if (allData.length > this.#maxSize) {
                allData.splice(0, allData.length - this.#maxSize);
            }

            await chrome.storage.local.set({ [this.#storageKey]: allData });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            this.#broadcastDataUpdate();
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π:", e);
            throw e;
        }
    }

    /**
     * @returns {Promise<VideoData[]>}
     */
    async getAll() {
        try {
            const result = await chrome.storage.local.get([this.#storageKey]);
            return result[this.#storageKey] || [];
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π:", e);
            return [];
        }
    }

    /**
     * @returns {Promise<void>}
     */
    async clear() {
        try {
            await chrome.storage.local.remove([this.#storageKey]);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö
            this.#broadcastDataCleared();
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:", e);
            throw e;
        }
    }

    /**
     * @returns {Promise<number>}
     */
    async getCount() {
        try {
            const data = await this.getAll();
            return data.length;
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π:", e);
            return 0;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI.
     * @returns {Promise<import('../core/types/table.types.js').VideoData[]>}
     */
    async getFreshData() {
        try {
            const allData = await this.getAll();
            // –§–∏–ª—å—Ç—Ä—É–µ–º, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" –∑–∞–ø–∏—Å–∏
            return allData.filter(item => !item.isImported);
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
            return [];
        }
    }

    /**
     * –û—á–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (isImported: true).
     * @returns {Promise<void>}
     */
    async clearImported() {
        try {
            console.log("[ChromeStorageTableAdapter] –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
            // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            const allData = await this.getAll();
            console.log(`[ChromeStorageTableAdapter] –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –¥–æ –æ—á–∏—Å—Ç–∫–∏: ${allData.length}`);

            // 2. –§–∏–ª—å—Ç—Ä—É–µ–º, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const freshData = allData.filter(item => !item.isImported);
            console.log(`[ChromeStorageTableAdapter] –û—Å—Ç–∞–Ω–µ—Ç—Å—è –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: ${freshData.length}`);

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (freshData.length > this.#maxSize) {
                freshData.splice(0, freshData.length - this.#maxSize);
            }

            await chrome.storage.local.set({ [this.#storageKey]: freshData });
            console.log("[ChromeStorageTableAdapter] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.");

            // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ —Å–æ—Å—Ç–∞–≤ –∏–∑–º–µ–Ω–∏–ª—Å—è
            // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç popup –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å "—Å–≤–µ–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ
            this.#broadcastDataUpdate();

        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
            throw e;
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å.
     * @private
     */
    #broadcastDataUpdate() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ type: "dataUpdated" }).catch(err => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ popup –∑–∞–∫—Ä—ã—Ç
                if (!chrome.runtime.lastError) {
                    console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ dataUpdated:", err);
                }
            });
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.
     * @private
     */
    #broadcastDataCleared() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ type: "dataCleared" }).catch(err => {
                if (!chrome.runtime.lastError) {
                    console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ dataCleared:", err);
                }
            });
        }
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageTableAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ConsoleLogAdapter.js ===

// adapters/ConsoleLogAdapter.js

/**
 * @typedef {import('../core/types/log.types.js').LogEntry} LogEntry
 * @typedef {import('../core/types/log.types.js').LogAdapter} LogAdapter
 */

export class ConsoleLogAdapter {
    /**
     * @param {LogEntry} entry
     * @returns {Promise<void>}
     */
    async write(entry) {
        // –õ–æ–≥–∏–∫–∞ —É–∂–µ –µ—Å—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–ª–∞—Å—Å–µ, –Ω–æ –º–æ–∂–Ω–æ –∏ –∑–¥–µ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        // –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º, —Ç–∞–∫ –∫–∞–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ Logger
    }

    /**
     * @returns {Promise<LogEntry[]>}
     */
    async read() {
        console.warn("[ConsoleLogAdapter] –ß—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ");
        return [];
    }

    /**
     * @returns {Promise<void>}
     */
    async clear() {
        console.clear(); // –§–∏–∑–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ConsoleLogAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\DexieTableAdapter.js ===

// adapters/DexieTableAdapter.js
import Dexie from '../lib/dexie.min.js';

console.log("[DexieTableAdapter] Dexie –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω:", typeof Dexie);
/**
 * @typedef {import('../core/types/table.types.js').VideoData} VideoData
 * @typedef {import('../core/types/table.types.js').TableAdapter} TableAdapter
 */

/**
 * –ê–¥–∞–ø—Ç–µ—Ä —Ç–∞–±–ª–∏—Ü—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–π IndexedDB —á–µ—Ä–µ–∑ Dexie.js –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±–æ–ª—å—à–∏—Ö –æ–±—ä–µ–º–æ–≤ –¥–∞–Ω–Ω—ã—Ö.
 * @implements {TableAdapter}
 */
export class DexieTableAdapter {
    /** @type {Dexie} */
    #db;
    /** @type {string} */
    #tableName;

    /**
     * @param {Object} options
     * @param {string} [options.dbName='YouTubeParserOS_DB']
     * @param {string} [options.tableName='parsedVideos']
     * @param {number} [options.version=1]
     */
    constructor(options = {}) {
        const dbName = options.dbName ?? 'YouTubeParserOS_DB';
        this.#tableName = options.tableName ?? 'parsedVideos';
        const version = options.version ?? 2;

        // –°–æ–∑–¥–∞–µ–º/–æ—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö Dexie
        this.#db = new Dexie(dbName);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã
        // –í–µ—Ä—Å–∏—è 1
        this.#db.version(version).stores({
            // –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã: –∏–Ω–¥–µ–∫—Å—ã. –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á - auto-incrementing id.
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ –ø–æ–ª—è, –ø–æ –∫–æ—Ç–æ—Ä—ã–º –±—É–¥–µ–º —á–∞—Å—Ç–æ –∏—Å–∫–∞—Ç—å/—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å.
            [this.#tableName]: '++id, &videoId, sourceVideoId, channelName, isImported, timestamp'
            // ++id - –∞–≤—Ç–æ–∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–Ω—ã–π –ø–µ—Ä–≤–∏—á–Ω—ã–π –∫–ª—é—á
            // &videoId - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –Ω–∞ videoId
            // sourceVideoId, channelName, isImported, timestamp - –æ–±—ã—á–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã
        });

        console.log(`[DexieTableAdapter] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ë–î: ${dbName}, –¢–∞–±–ª–∏—Ü–∞: ${this.#tableName}`);
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å.
     * @param {VideoData} videoData
     * @returns {Promise<void>}
     */
    async add(videoData) {
        try {
            // Dexie –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç id, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            await this.#db.table(this.#tableName).add(videoData);
            this.#broadcastDataUpdate(); // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏:", e);
            throw e;
        }
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ –∑–∞–ø–∏—Å–µ–π.
     * @param {VideoData[]} videoDataArray
     * @returns {Promise<void>}
     */
    async addBatch(videoDataArray) {
        if (!Array.isArray(videoDataArray) || videoDataArray.length === 0) {
            console.warn("[DexieTableAdapter] addBatch: –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∏–ª–∏ –Ω–µ –º–∞—Å—Å–∏–≤.");
            return;
        }
        try {
            await this.#db.table(this.#tableName).bulkAdd(videoDataArray);
            console.log(`[DexieTableAdapter] –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${videoDataArray.length} –∑–∞–ø–∏—Å–µ–π.`);
            this.#broadcastDataUpdate(); // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        } catch (e) {
            // bulkAdd –º–æ–∂–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∂–µ –æ—à–∏–±–∫–µ –∏–ª–∏ –≤—Å—Ç–∞–≤–∏—Ç—å –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ
            // –ü—Ä–æ–≤–µ—Ä–∏–º, –±—ã–ª–∞ –ª–∏ –æ—à–∏–±–∫–∞ –∏–∑-–∑–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, videoId —É–∂–µ –µ—Å—Ç—å)
            if (e.name === 'ConstraintError' || e.name === 'BulkError') {
                console.warn("[DexieTableAdapter] –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ bulkAdd (–≤–æ–∑–º–æ–∂–Ω–æ, –¥—É–±–ª–∏–∫–∞—Ç—ã):", e);
                // –ú–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —Å bulkPut –∏–ª–∏ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å BulkError –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ —É—Å–ø–µ—Ö–∞
                // –î–ª—è MVP –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
            } else {
                console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π:", e);
                throw e;
            }
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏.
     * @returns {Promise<VideoData[]>}
     */
    async getAll() {
        try {
            // –î–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –ø–æ—Å—Ç—Ä–∞–Ω–∏—á–Ω–æ–µ —á—Ç–µ–Ω–∏–µ
            return await this.#db.table(this.#tableName).toArray();
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π:", e);
            return [];
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç "—Å–≤–µ–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ).
     * @returns {Promise<VideoData[]>}
     */
    async getFreshData() {
        try {
            const table = this.#db.table(this.#tableName);

            // –í Dexie, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –∑–∞–ø–∏—Å–∏, –≥–¥–µ –ø–æ–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (undefined),
            // –º—ã –Ω–µ –º–æ–∂–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å equals(undefined) –Ω–∞–ø—Ä—è–º—É—é –≤ where/or.
            // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ, –ø–æ–ª—É—á–∏–º –≤—Å–µ –∑–∞–ø–∏—Å–∏ –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é.
            // –≠—Ç–æ –º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –Ω–æ –Ω–∞–¥–µ–∂–Ω–æ.

            // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–ø–∏—Å–∏
            const allData = await table.toArray();
            console.log(`[DexieTableAdapter] –ü–æ–ª—É—á–µ–Ω–æ ${allData.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ "—Å–≤–µ–∂–∏—Ö".`, { module: 'DexieTableAdapter' });

            // 2. –§–∏–ª—å—Ç—Ä—É–µ–º "—Å–≤–µ–∂–∏–µ" –∑–∞–ø–∏—Å–∏: isImported === false –∏–ª–∏ isImported === undefined
            const freshData = allData.filter(item =>
                item.isImported === false || item.isImported === undefined
            );

            console.log(`[DexieTableAdapter] –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ "—Å–≤–µ–∂–∏—Ö" –∑–∞–ø–∏—Å–µ–π: ${freshData.length}.`, { module: 'DexieTableAdapter' });
            return freshData;
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π:", e);
            return [];
        }
    }

    /**
     * –û—á–∏—â–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ.
     * @returns {Promise<void>}
     */
    async clear() {
        try {
            await this.#db.table(this.#tableName).clear();
            console.log("[DexieTableAdapter] –¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞.");
            this.#broadcastDataCleared(); // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ—á–∏—Å—Ç–∫–µ
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã:", e);
            throw e;
        }
    }

    /**
     * –û—á–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
     * @returns {Promise<void>}
     */
    async clearImported() {
        try {
            console.log("[DexieTableAdapter] –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
            const deleteCount = await this.#db.table(this.#tableName).where('isImported').equals(true).delete();
            console.log(`[DexieTableAdapter] –£–¥–∞–ª–µ–Ω–æ ${deleteCount} –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π.`);
            this.#broadcastDataUpdate(); // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
            throw e;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π.
     * @returns {Promise<number>}
     */
    async getCount() {
        try {
            return await this.#db.table(this.#tableName).count();
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π:", e);
            return 0;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ "—Å–≤–µ–∂–∏—Ö" –∑–∞–ø–∏—Å–µ–π.
     * @returns {Promise<number>}
     */
    async getFreshCount() {
        try {
            const table = this.#db.table(this.#tableName);

            // –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ getFreshData, –Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º count()
            const allData = await table.toArray();
            const freshData = allData.filter(item =>
                item.isImported === false || item.isImported === undefined
            );

            const count = freshData.length;

            console.log(`[DexieTableAdapter] –ü–æ–ª—É—á–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π: ${count}`, { module: 'DexieTableAdapter' });
            return count;
        } catch (e) {
            console.error("[DexieTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π:", e);
            return 0;
        }
    }

    // --- Private Methods ---

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å.
     * @private
     */
    #broadcastDataUpdate() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ type: "dataUpdated" }).catch(err => {
                if (!chrome.runtime.lastError) {
                    console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ dataUpdated:", err);
                }
            });
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.
     * @private
     */
    #broadcastDataCleared() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ type: "dataCleared" }).catch(err => {
                if (!chrome.runtime.lastError) {
                    console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ dataCleared:", err);
                }
            });
        }
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\DexieTableAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\background\background.js ===

// background/background.js
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
import { Logger } from '../core/logger.js';
import { ChromeStorageLogAdapter } from '../adapters/ChromeStorageLogAdapter.js';
import { ScenarioEngine } from '../core/scenario-engine.js';
import { testCountdownScenario } from '../scenarios/test-countdown.js';
import { DexieTableAdapter } from '../adapters/DexieTableAdapter.js';
import { prepareImportedDataIndices } from '../core/data-processor.js';
import { parseRecommendationScenario } from '../scenarios/parse-recommendation.js';
import {
    initialize as initIndexManager,
    reset as resetIndexManager,
    getStateSnapshot,
    addScrapedData as updateIndexManagerWithData
} from '../core/index-manager.js';

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ ---
// 1. –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ª–æ–≥–≥–µ—Ä–∞
export const logger = new Logger({
    maxSize: 1000,
    enableConsole: true,
    defaultLevel: 'info'
});

export const tableAdapter = new DexieTableAdapter({
    dbName: 'YouTubeParserOS_DB', // –ò–º—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö IndexedDB
    tableName: 'parsedVideos',   // –ò–º—è —Ç–∞–±–ª–∏—Ü—ã –≤–Ω—É—Ç—Ä–∏ –ë–î
    version: 1                     // –í–µ—Ä—Å–∏—è —Å—Ö–µ–º—ã (—É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å—Ö–µ–º—ã)
});

export async function getImportedDataIndices() {
    try {
        const allData = await tableAdapter.getAll();
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const importedData = allData.filter(item => item.isImported === true);
        logger.debug(`[Background] –ü–æ–ª—É—á–µ–Ω–æ ${importedData.length} –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.`, { module: 'Background' });
        return prepareImportedDataIndices(importedData);
    } catch (error) {
        logger.error(`[Background] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏/–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, { module: 'Background' });
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        return {
            visitedVideoIds: new Set(),
            channelVideoCounts: new Map(),
            channelToVideoIds: new Map()
        };
    }
}
// logger –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –¥–æ–±–∞–≤–∏–ª ChromeStorageLogAdapter, –Ω–æ –º—ã –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë

// 2. –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–≤–∏–∂–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
export const scenarioEngine = new ScenarioEngine();

// 3. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
scenarioEngine.registerScenario(testCountdownScenario);
scenarioEngine.registerScenario(parseRecommendationScenario);

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexManager ---
// –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ background script
async function initializeBackgroundState() {
    logger.info("üöÄ Background service worker –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.", { module: 'Background' });

    try {
        // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º IndexManager –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ tableAdapter
        logger.info("üîÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è IndexManager...", { module: 'Background' });
        const allStoredData = await tableAdapter.getAll();
        await initIndexManager(allStoredData);
        logger.info(`‚úÖ IndexManager –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω. –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${allStoredData.length} –∑–∞–ø–∏—Å–µ–π.`, { module: 'Background' });

        // 2. –ú–æ–∂–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ —á–∞—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã...

    } catch (initErr) {
        logger.error(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ background: ${initErr.message}`, { module: 'Background' });
        // –í–∞–∂–Ω–æ: –Ω–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–µ—Å—å background –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        // –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –∫—Ä–∏—Ç–∏—á–Ω–æ
    }
}

// –í—ã–∑—ã–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
initializeBackgroundState().catch(err => {
    console.error("[Background] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", err);
    // logger –º–æ–∂–µ—Ç –±—ã—Ç—å –µ—â–µ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω, –ø–æ—ç—Ç–æ–º—É console.error —Ç–æ–∂–µ –≤–∞–∂–µ–Ω
});

// --- –ö–æ–Ω–µ—Ü –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ ---

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç popup ---
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {

    if (request.type === "contentLog") {
        console.log("[Background] –ü–æ–ª—É—á–µ–Ω –ª–æ–≥ –æ—Ç content script:", request);
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ –≤ –Ω–∞—à logger
        logger.log(
            request.message,
            request.level || 'info',
            {
                module: request.module || 'ContentScript',
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ID –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                // tabId: sender.tab?.id
            }
        );
        // –ù–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º sendResponse, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        return false; // –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    }

    if (request.action === "stopAllScenarios") {
        logger.info("üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤", { module: 'Background' });
        (async () => {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
                const runningScenarios = scenarioEngine.getRunningScenarios();
                if (runningScenarios.length === 0) {
                    logger.info("üì≠ –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏", { module: 'Background' });
                    sendResponse({ status: "success", message: "–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤" });
                    return;
                }

                logger.info(`‚èπÔ∏è –ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ ${runningScenarios.length} —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤`, { module: 'Background' });

                let stoppedCount = 0;
                let errorCount = 0;

                const stopPromises = runningScenarios.map(async (scenario) => {
                    try {
                        // ScenarioEngine.stop –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                        const wasStopped = scenarioEngine.stop(scenario.id);
                        if (wasStopped) {
                            stoppedCount++;
                            logger.info(`‚èπÔ∏è –°—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}" (ID: ${scenario.id}) –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`, { module: 'Background' });
                        } else {
                            // –≠—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö
                            logger.warn(`‚ö†Ô∏è –°—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}" (ID: ${scenario.id}) –Ω–µ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω?)`, { module: 'Background' });
                        }
                    } catch (err) {
                        errorCount++;
                        logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenario.name}" (ID: ${scenario.id}): ${err.message}`, { module: 'Background' });
                    }
                });

                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                await Promise.allSettled(stopPromises);

                const resultMessage = `–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${stoppedCount}. –û—à–∏–±–æ–∫: ${errorCount}.`;
                logger.info(`üèÅ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${resultMessage}`, { module: 'Background' });

                sendResponse({ status: "success", message: resultMessage });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "getScenarioStatus") {
        logger.debug("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤", { module: 'Background' });
        try {
            const runningScenarios = scenarioEngine.getRunningScenarios();
            const isRunning = runningScenarios.length > 0;
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            sendResponse({ status: "success", isRunning: isRunning, runningScenarios: runningScenarios });
            logger.debug(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: isRunning=${isRunning}`, { module: 'Background' });
        } catch (err) {
            logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${err.message}`, { module: 'Background' });
            sendResponse({ status: "error", message: err.message });
        }
        return true; // keep channel open for async response (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ getRunningScenarios —Å—Ç–∞–Ω–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –≤ –±—É–¥—É—â–µ–º)
    }

    if (request.action === "runScenario") {
        const { scenarioId, params = {} } = request;
        logger.info(`üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –∑–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioId}"`, { module: 'Background', meta: params });

        (async () => {
            try {
                let activeTabId = null;
                logger.debug("–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É...", { module: 'Background' });

                try {
                    // –ü–æ–ø—ã—Ç–∫–∞ 1: –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ
                    const activeTabsCurrentWindow = await chrome.tabs.query({ active: true, currentWindow: true });
                    logger.debug(`–†–µ–∑—É–ª—å—Ç–∞—Ç query({active: true, currentWindow: true}):`, activeTabsCurrentWindow, { module: 'Background' });
                    if (activeTabsCurrentWindow.length > 0) {
                        activeTabId = activeTabsCurrentWindow[0].id;
                        logger.debug(`–ù–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ: ID=${activeTabId}`, { module: 'Background' });
                    } else {
                        logger.warn("–ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", { module: 'Background' });
                    }
                } catch (queryErr1) {
                    logger.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ 1 –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏: ${queryErr1.message}`, { module: 'Background' });
                }

                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –ø–æ–ø—Ä–æ–±—É–µ–º –±–æ–ª–µ–µ –æ–±—â–∏–π –∑–∞–ø—Ä–æ—Å
                if (activeTabId === null) {
                    logger.debug("–ü–æ–ø—ã—Ç–∫–∞ 2: –ü–æ–ª—É—á–∏—Ç—å –ª—é–±—É—é –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É...", { module: 'Background' });
                    try {
                        const activeTabsAnyWindow = await chrome.tabs.query({ active: true });
                        logger.debug(`–†–µ–∑—É–ª—å—Ç–∞—Ç query({active: true}):`, activeTabsAnyWindow, { module: 'Background' });
                        if (activeTabsAnyWindow.length > 0) {
                            // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—É—é, –æ–±—ã—á–Ω–æ —ç—Ç–æ —Ç–∞, —á—Ç–æ –≤ —Ç–µ–∫—É—â–µ–º –æ–∫–Ω–µ
                            activeTabId = activeTabsAnyWindow[0].id;
                            logger.debug(`–ù–∞–π–¥–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ (–ª—é–±–∞—è): ID=${activeTabId}`, { module: 'Background' });
                        } else {
                            logger.warn("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∏ –æ–¥–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏.", { module: 'Background' });
                        }
                    } catch (queryErr2) {
                        logger.warn(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ 2 –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏: ${queryErr2.message}`, { module: 'Background' });
                    }
                }

                // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ null, –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º (—Å—Ü–µ–Ω–∞—Ä–∏–π –º–æ–∂–µ—Ç —Å–∞–º —Ä–µ—à–∏—Ç—å, —á—Ç–æ –¥–µ–ª–∞—Ç—å)
                if (activeTabId === null) {
                    logger.warn("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É. tabId –±—É–¥–µ—Ç null. –°—Ü–µ–Ω–∞—Ä–∏–π –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–æ–Ω—Ç–µ–Ω—Ç–æ–º —Å—Ç—Ä–∞–Ω–∏—Ü—ã.", { module: 'Background' });
                    // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É –∑–¥–µ—Å—å, –ø—É—Å—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π —Å–∞–º —Ä–µ—à–∞–µ—Ç, –∫—Ä–∏—Ç–∏—á–Ω–æ –ª–∏ —ç—Ç–æ.
                    // –ù–æ –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø–æ—ç—Ç–æ–º—É —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–æ–ª–∂–µ–Ω —ç—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å.
                } else {
                    logger.info(`‚úÖ –ê–∫—Ç–∏–≤–Ω–∞—è –≤–∫–ª–∞–¥–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞: ID=${activeTabId}`, { module: 'Background' });
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—Å–∫–∞—Ç—å
                let scenarioToRun;
                if (scenarioId === 'parse-recommendation') {
                    scenarioToRun = parseRecommendationScenario;
                } else if (scenarioId === 'test-countdown') {
                    scenarioToRun = testCountdownScenario;
                    // } else if (scenarioId === '...') {
                    //     scenarioToRun = ...;
                } else {
                    throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ID —Å—Ü–µ–Ω–∞—Ä–∏—è: ${scenarioId}`);
                }

                // –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ tabId –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ—Ä–µ–∑ context.params –∏ context.tabId
                const instanceId = await scenarioEngine.run(scenarioToRun, params, activeTabId);
                logger.info(`üèÅ –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioId}" –∑–∞–ø—É—â–µ–Ω —Å ID: ${instanceId}`, { module: 'Background' });

                sendResponse({ status: "started", instanceId: instanceId });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioId}": ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();

        return true; // keep channel open for async response
    }

    if (request.action === "clearImportedTableData") {
        (async () => {
            try {
                logger.info("üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", { module: 'Background' });

                // –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –∞–¥–∞–ø—Ç–µ—Ä–∞
                await tableAdapter.clearImported();

                logger.info("‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã", { module: 'Background' });
                sendResponse({ status: "success" });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "getTableFreshData") {
        (async () => {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –∞–¥–∞–ø—Ç–µ—Ä–∞
                const data = await tableAdapter.getFreshData();
                sendResponse({ status: "success", data });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
    }

    if (request.action === "DEBUG_getImportedDataIndices") {
        (async () => {
            try {
                console.log("[DEBUG] –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏–∑ popup/console...");
                const indices = await getImportedDataIndices(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è

                // Maps –∏ Sets –Ω—É–∂–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const serializableData = {
                    visitedVideoIds_size: indices.visitedVideoIds.size,
                    channelVideoCounts_size: indices.channelVideoCounts.size,
                    channelToVideoIds_size: indices.channelToVideoIds.size,

                    // –î–æ–±–∞–≤–∏–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                    visitedVideoIds_sample: Array.from(indices.visitedVideoIds).slice(0, 5),
                    channelVideoCounts_sample: Object.fromEntries(
                        Array.from(indices.channelVideoCounts).slice(0, 5)
                    ),
                    channelToVideoIds_sample: Object.fromEntries(
                        Array.from(indices.channelToVideoIds, ([k, v]) => [k, Array.from(v).slice(0, 3)]).slice(0, 3)
                    )
                };

                console.log("[DEBUG] –ò–Ω–¥–µ–∫—Å—ã –ø–æ–ª—É—á–µ–Ω—ã:", serializableData);
                sendResponse({ status: "success", data: serializableData });
            } catch (err) {
                console.error("[DEBUG] –û—à–∏–±–∫–∞ –≤ getImportedDataIndices:", err);
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "importTableData") {
        (async () => {
            try {
                if (!request.data || !Array.isArray(request.data)) {
                    const errorMsg = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞";
                    logger.warn(`[Background] ${errorMsg}`, { module: 'Background' });
                    sendResponse({ status: "error", message: errorMsg });
                    return;
                }

                const dataToImport = request.data;
                logger.info(`üì• –ù–∞—á–∏–Ω–∞–µ–º –∏–º–ø–æ—Ä—Ç ${dataToImport.length} –∑–∞–ø–∏—Å–µ–π...`, { module: 'Background' });

                // 1. –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ tableAdapter (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ tableAdapter.addBatch —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
                if (typeof tableAdapter.addBatch === 'function') {
                    await tableAdapter.addBatch(dataToImport);
                } else if (typeof tableAdapter.add === 'function') {
                    // –ï—Å–ª–∏ addBatch –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–π (–º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
                    logger.warn("[Background] tableAdapter.addBatch –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º add –¥–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏...", { module: 'Background' });
                    for (const item of dataToImport) {
                        await tableAdapter.add(item);
                    }
                } else {
                    throw new Error("–ê–¥–∞–ø—Ç–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ç–æ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (add/addBatch)");
                }

                logger.info(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${dataToImport.length} –∑–∞–ø–∏—Å–µ–π –≤ tableAdapter`, { module: 'Background' });

                // üëá –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º IndexManager –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –ë–ï–ó –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ scrapedDataBuffer
                try {
                    logger.info(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IndexManager ${dataToImport.length} –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–∞–ø–∏—Å—è–º–∏ (addToBuffer=false)...`, { module: 'Background' });
                    // –í—ã–∑—ã–≤–∞–µ–º addScrapedData —Å —Ñ–ª–∞–≥–æ–º addToBuffer = false
                    updateIndexManagerWithData(dataToImport, false);
                    logger.info(`‚úÖ IndexManager —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (–±–µ–∑ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –±—É—Ñ–µ—Ä).`, { module: 'Background' });
                } catch (indexUpdateErr) {
                    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É, –Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∏–º–ø–æ—Ä—Ç–∞
                    logger.error(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IndexManager –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞: ${indexUpdateErr.message}`, { module: 'Background' });
                }

                sendResponse({ status: "success", count: dataToImport.length });

                // üëá –ù–û–í–û–ï: –û–ø–æ–≤–µ—â–∞–µ–º popup –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                // chrome.runtime.sendMessage({ type: "dataUpdated" }).catch(err => { /* ignore */ });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "getImportedDataIndices") {
        (async () => {
            try {
                const indices = await getImportedDataIndices();
                // Maps –∏ Sets –Ω–µ–ª—å–∑—è –Ω–∞–ø—Ä—è–º—É—é —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ JSON, –ø–æ—ç—Ç–æ–º—É –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º
                const serializableIndices = {
                    visitedVideoIds: Array.from(indices.visitedVideoIds),
                    channelVideoCounts: Object.fromEntries(indices.channelVideoCounts),
                    channelToVideoIds: {} // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map<channel, Set<id>> –≤ –æ–±—ä–µ–∫—Ç
                };
                for (const [channel, idSet] of indices.channelToVideoIds) {
                    serializableIndices.channelToVideoIds[channel] = Array.from(idSet);
                }
                sendResponse({ status: "success", data: serializableIndices });
            } catch (err) {
                logger.error(`[Background] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // –î–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
    }

    if (request.action === "getTableData") {
        (async () => {
            try {
                const data = await tableAdapter.getAll();
                sendResponse({ status: "success", data });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
    }

    // üëá –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü—ã
    if (request.action === "clearTableData") {
        (async () => {
            try {
                await tableAdapter.clear();
                sendResponse({ status: "success" });
                logger.info("‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞", { module: 'Background' });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true;
    }

    // üëá –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ TSV)
    if (request.action === "copyTableData") {
        (async () => {
            try {
                const data = await tableAdapter.getAll();
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const freshData = data.filter(v => !v.isImported);

                const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', 'ID', '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', '–ö–∞–Ω–∞–ª', '–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ', '–ú–∏–Ω–∏–∞—Ç—é—Ä–∞'];
                const rows = freshData.map(v => [
                    v.title || '', v.videoId || '', v.views || '', v.channelName || '', v.sourceVideoId || '', v.thumbnailUrl || ''
                ]);

                const tsvContent = [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
                sendResponse({ status: "success", data: tsvContent });
                logger.info(`üìã –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (${freshData.length} —Å—Ç—Ä–æ–∫)`, { module: 'Background' });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true;
    }

    if (request.action === "importTableDataChunk") {
        (async () => {
            try {
                const { data, isLastChunk, fileName, chunkIndex, totalChunks } = request;

                if (!Array.isArray(data) || data.length === 0) {
                    throw new Error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞");
                }

                logger.info(`üì• –ò–º–ø–æ—Ä—Ç —á–∞–Ω–∫–∞ ${chunkIndex}/${totalChunks} –∏–∑ —Ñ–∞–π–ª–∞ "${fileName}"...`, { module: 'Background' });

                // –î–æ–±–∞–≤–ª—è–µ–º —á–∞–Ω–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                await tableAdapter.addBatch(data);

                logger.info(`‚úÖ –ß–∞–Ω–∫ ${chunkIndex}/${totalChunks} —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω.`, { module: 'Background' });

                // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞–Ω–∫, –æ–±–Ω–æ–≤–ª—è–µ–º IndexManager
                if (isLastChunk) {
                    logger.info(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ IndexManager –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —á–∞–Ω–∫–∞...`, { module: 'Background' });
                    try {
                        const importedData = await tableAdapter.getAll();
                        const importedOnly = importedData.filter(item => item.isImported);
                        const indices = prepareImportedDataIndices(importedOnly);
                        // üëá –û–ë–ù–û–í–õ–Ø–ï–ú IndexManager
                        await initIndexManager(importedOnly); // –∏–ª–∏ updateIndexManagerWithData, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                        logger.info(`‚úÖ IndexManager —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞ "${fileName}".`, { module: 'Background' });
                    } catch (indexUpdateErr) {
                        logger.error(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è IndexManager: ${indexUpdateErr.message}`, { module: 'Background' });
                    }
                }

                sendResponse({ status: "success" });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —á–∞–Ω–∫–∞: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "copyTableDataAsCSV") {
        (async () => {
            try {
                logger.info("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV (;)", { module: 'Background' });

                // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ tableAdapter
                const data = await tableAdapter.getAll();
                logger.info(`üì• –ü–æ–ª—É—á–µ–Ω–æ ${data.length} –∑–∞–ø–∏—Å–µ–π –∏–∑ tableAdapter –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è`, { module: 'Background' });

                // 2. –§–∏–ª—å—Ç—Ä—É–µ–º, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
                const freshData = data.filter(v => !v.isImported);
                logger.info(`üìã –û—Ç–æ–±—Ä–∞–Ω–æ ${freshData.length} —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è`, { module: 'Background' });

                if (freshData.length === 0) {
                    logger.warn("üìã –ù–µ—Ç —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è", { module: 'Background' });
                    sendResponse({ status: "success", data: "" });
                    return;
                }

                // 3. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ (–≤—Å–µ–≥–¥–∞ –≤ –∫–∞–≤—ã—á–∫–∞—Ö, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ)
                const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', 'ID', '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', '–ö–∞–Ω–∞–ª', '–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ', '–ú–∏–Ω–∏–∞—Ç—é—Ä–∞'];
                const escapeHeader = (header) => {
                    // –í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≤ –∫–∞–≤—ã—á–∫–∏ –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ "
                    return `"${String(header).replace(/"/g, '""')}"`;
                };
                const csvHeader = headers.map(escapeHeader).join(';');

                // 4. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                const escapeCSVField = (str) => {
                    if (str == null) return '""'; // –ü—É—Å—Ç–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ -> ""
                    const s = String(str);
                    // –í—Å–µ–≥–¥–∞ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–∞–≤—ã—á–∫–∏ –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ "
                    return `"${s.replace(/"/g, '""')}"`;
                };

                const csvRows = freshData.map(v => [
                    escapeCSVField(v.title || ''),
                    escapeCSVField(v.videoId || ''),
                    escapeCSVField(v.views || ''),
                    escapeCSVField(v.channelName || ''), // –ö–∞–Ω–∞–ª –Ω–µ –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç—Å—è –≤ –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –Ω–µ—Ç —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª–æ–≤
                    escapeCSVField(v.sourceVideoId || ''),
                    escapeCSVField(v.thumbnailUrl || '')
                ].join(';'));

                // 5. –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ CSV —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º ";"
                const csvContent = [csvHeader, ...csvRows].join('\n');

                logger.info(`üìã –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV (;) (${freshData.length} —Å—Ç—Ä–æ–∫)`, { module: 'Background' });
                sendResponse({ status: "success", data: csvContent });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV (;): ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    // üëá –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–±—Ä–æ—Å–∞ –∏–Ω–¥–µ–∫—Å–æ–≤
    if (request.action === "resetIndices") {
        (async () => {
            try {
                logger.info("üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ —Å–±—Ä–æ—Å –∏–Ω–¥–µ–∫—Å–æ–≤.", { module: 'Background' });
                resetIndexManager();
                logger.info("‚úÖ –ò–Ω–¥–µ–∫—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã.", { module: 'Background' });
                sendResponse({ status: "success", message: "–ò–Ω–¥–µ–∫—Å—ã —Å–±—Ä–æ—à–µ–Ω—ã." });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∏–Ω–¥–µ–∫—Å–æ–≤: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    // üëá –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏/—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤ popup)
    if (request.action === "getIndexState") {
        (async () => {
            try {
                // logger.info("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤.", { module: 'Background' });
                // getStateSnapshot –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ø–∏–∏, –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                const indexStateSnapshot = getStateSnapshot();

                // Maps –∏ Sets –Ω—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ sendMessage
                // –í–ê–ñ–ù–û: –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª—è–º–∏, –∫–æ—Ç–æ—Ä—ã–µ –æ–∂–∏–¥–∞–µ—Ç popup
                const serializableState = {
                    // –ü–æ–ª—è –¥–ª—è scrapedDataBuffer
                    scrapedDataBuffer_count: indexStateSnapshot.scrapedDataBuffer.length,
                    // üëá –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∞–º–∏ –¥–∞–Ω–Ω—ã–µ –±—É—Ñ–µ—Ä–∞ (–∏–ª–∏ —á–∞—Å—Ç—å)
                    scrapedDataBuffer_sample: indexStateSnapshot.scrapedDataBuffer, // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤

                    // –ü–æ–ª—è –¥–ª—è visitedVideoIds
                    visitedVideoIds_count: indexStateSnapshot.visitedVideoIds.size,
                    // üëá –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–∞–º–∏ ID (–∏–ª–∏ —á–∞—Å—Ç—å)
                    visitedVideoIds_sample: Array.from(indexStateSnapshot.visitedVideoIds), // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 10 ID

                    // –ü–æ–ª—è –¥–ª—è channelVideoCounts
                    channelVideoCounts_count: indexStateSnapshot.channelVideoCounts.size,
                    // üëá –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç—å —Å–ª–æ–≤–∞—Ä—è
                    channelVideoCounts_sample: Object.fromEntries(
                        Array.from(indexStateSnapshot.channelVideoCounts) // –ü–µ—Ä–≤—ã–µ 10 –∫–∞–Ω–∞–ª–æ–≤
                    ),

                    // –ü–æ–ª—è –¥–ª—è channelToVideoIds
                    channelToVideoIds_count: indexStateSnapshot.channelToVideoIds.size,
                    // üëá –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–∞—Å—Ç—å —Å–ª–æ–≤–∞—Ä—è, –ø—Ä–µ–æ–±—Ä–∞–∑—É—è Set –≤ Array
                    channelToVideoIds_sample: Object.fromEntries(
                        Array.from(indexStateSnapshot.channelToVideoIds, ([k, v]) => [k, Array.from(v)])
                    ),
                };

                sendResponse({ status: "success", serializableState });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    // TODO: –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (parseOnce, startAutoAnalysis –∏ —Ç.–¥.)
    // –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å MVP.
});

logger.info("üöÄ Background service worker –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.", { module: 'Background' });

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\background\background.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\content.js ===

// content/content.js
// window.performScrollNTimes –¥–æ—Å—Ç—É–ø–Ω–∞, —Ç–∞–∫ –∫–∞–∫ scroller.js –±—ã–ª –ø–æ–¥–∫–ª—é—á–µ–Ω —Ä–∞–Ω—å—à–µ

console.log("[Content Script] –ó–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.");

// –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç background.js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    console.log("[Content Script] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", request);

    if (request.action === "performSingleScroll") {
        console.log("[Content Script] –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –û–î–ù–û–ì–û —Å–∫—Ä–æ–ª–ª–∞:", request);

        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª, –≤—ã–∑—ã–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
        window.performSingleScroll(request.step)
            .then(() => {
                console.log("[Content Script] –û–¥–∏–Ω —Å–∫—Ä–æ–ª–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.");
                sendResponse({ status: "success" });
            })
            .catch((err) => {
                console.error("[Content Script] –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞:", err);
                sendResponse({ status: "error", message: err.message });
            });

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
        return true;
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞ ---
    if (request.action === "parseAndHighlight") {
        console.log("[Content Script] === –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥, –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ —Å–∫—Ä–∞–ø–∏–Ω–≥ ===");
        const { sourceVideoId = 'unknown' } = request; // –û–∂–∏–¥–∞–µ–º sourceVideoId –æ—Ç background
        console.log("[Content Script] –ò—Å–ø–æ–ª—å–∑—É–µ–º sourceVideoId:", sourceVideoId);

        try {
            // 1. –ù–∞–π—Ç–∏ –∏ –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏
            const parsedCardElements = window.ytParser.parseAndHighlight(); // –≠—Ç–æ HTMLElement[]
            const count = parsedCardElements.length;
            console.log(`[Content Script] –ù–∞–π–¥–µ–Ω–æ –∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫: ${count}`);

            // 2. –ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
            // –ü–µ—Ä–µ–¥–∞–µ–º –º–∞—Å—Å–∏–≤ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏ sourceVideoId –≤ scraper
            const scrapedData = window.ytScraper.scrapeCards(parsedCardElements, sourceVideoId);
            console.log(`[Content Script] –ò–∑–≤–ª–µ—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ${scrapedData.length} –∫–∞—Ä—Ç–æ—á–µ–∫.`);

            // 3. –í–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ
            sendResponse({
                status: "success",
                highlightedCount: count,
                scrapedData: scrapedData // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å—Ä–∞–∑—É –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            });
            console.log("[Content Script] === –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã ===");

        } catch (err) {
            console.error("[Content Script] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞/—Å–∫—Ä–∞–ø–∏–Ω–≥–∞:", err);
            sendResponse({
                status: "error",
                message: err.message,
                // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –º–æ–∂–µ–º –≤–µ—Ä–Ω—É—Ç—å —Ç–æ, —á—Ç–æ —É—Å–ø–µ–ª–∏ –Ω–∞–π—Ç–∏
                highlightedCount: 0,
                scrapedData: []
            });
        }
        return true; // keep channel open for async response
    }

    // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π ---
    if (request.action === "removeParserHighlights") {
        console.log("[Content Script] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏.");
        try {
            window.ytParser.removeHighlights();
            sendResponse({ status: "success" });
        } catch (err) {
            console.error("[Content Script] –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏:", err);
            sendResponse({ status: "error", message: err.message });
        }
        return true;
    }

    if (request.action === "requestCardDetails") {
        console.log(`[Content Script] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ ${request.count} –∫–∞—Ä—Ç–æ—á–∫–∞–º.`);
        try {
            // 1. –ù–∞–π—Ç–∏ –≤—Å–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏
            const highlightedCards = document.querySelectorAll('.video-highlighted');
            console.log(`[Content Script] –ù–∞–π–¥–µ–Ω–æ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫: ${highlightedCards.length}`);

            // 2. –ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞–∂–¥–æ–π
            const cardDetails = [];
            highlightedCards.forEach((cardElement, index) => {
                try {
                    // --- –õ–æ–≥–∏–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö, –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è core/scraper.js ---
                    // 1. –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ
                    const titleElement = cardElement.querySelector('.yt-lockup-metadata-view-model__title');
                    const title = titleElement?.textContent?.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

                    // 2. ID –≤–∏–¥–µ–æ –∏–∑ —Å—Å—ã–ª–∫–∏
                    const linkElement = cardElement.querySelector('a[href*="/watch?v="]');
                    let videoId = '–ù–µ –Ω–∞–π–¥–µ–Ω';
                    if (linkElement) {
                        try {
                            const url = new URL(linkElement.href);
                            videoId = url.searchParams.get('v') || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å ID';
                        } catch (urlErr) {
                            console.warn(`[Content Script] –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ URL –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ ${index}:`, urlErr);
                        }
                    }

                    // 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                    const viewsElement = cardElement.querySelector('.yt-lockup-metadata-view-model__byline-item');
                    const views = viewsElement?.textContent?.trim() || 'N/A';

                    // 4. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
                    const channelElement = cardElement.querySelector('.yt-lockup-metadata-view-model__secondary-title');
                    const channelName = channelElement?.textContent?.trim() || 'N/A';

                    // 5. URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
                    const thumbImg = cardElement.querySelector('img');
                    const thumbnailUrl = thumbImg?.src || 'N/A';

                    cardDetails.push({
                        videoId,
                        title,
                        views,
                        channelName,
                        thumbnailUrl
                        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ø–æ–ª–µ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
                    });
                    console.log(`[Content Script] –î–∞–Ω–Ω—ã–µ –∏–∑–≤–ª–µ—á–µ–Ω—ã –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ ${index + 1}: ${title.substring(0, 30)}...`);
                } catch (scrapeErr) {
                    console.error(`[Content Script] –û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ ${index}:`, scrapeErr);
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –æ—à–∏–±–∫–æ–π, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
                    cardDetails.push({
                        videoId: '–û—à–∏–±–∫–∞ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è',
                        title: `–û—à–∏–±–∫–∞: ${scrapeErr.message.substring(0, 50)}`,
                        views: 'N/A',
                        channelName: 'N/A',
                        thumbnailUrl: 'N/A'
                    });
                }
            });

            console.log(`[Content Script] –°–æ–±—Ä–∞–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ ${cardDetails.length} –∫–∞—Ä—Ç–æ—á–∫–∞–º.`);
            sendResponse({
                status: "success",
                cardDetails: cardDetails
            });
        } catch (err) {
            console.error("[Content Script] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—Ä—Ç–æ—á–∫–∞—Ö:", err);
            sendResponse({ status: "error", message: err.message });
        }
        return true; // keep channel open for async response
    }

    if (request.action === "checkVideoAvailability") {
        console.log("[Content Script] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ.");
        (async () => {
            try {
                // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –º–æ–¥—É–ª—è video-checker
                const isAvailable = window.ytVideoChecker.isCurrentVideoAvailable();
                console.log(`[Content Script] –í–∏–¥–µ–æ ${isAvailable ? '–¥–æ—Å—Ç—É–ø–Ω–æ' : '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}.`);
                sendResponse({ status: "success", isAvailable: isAvailable });
            } catch (err) {
                console.error("[Content Script] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ:", err);
                sendResponse({ status: "error", message: err.message, isAvailable: true }); // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "navigateToVideo") {
        console.log("[Content Script] –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ URL:", request.url);
        (async () => {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è –≤–∫–ª–∞–¥–∫–∞ —Ç–æ–π, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏
                // (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π, —Ö–æ—Ç—è –æ–±—ã—á–Ω–æ tabId —É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π)
                // const currentTab = await chrome.tabs.getCurrent();
                // if (currentTab.id !== sender.tab.id) { ... }

                // –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥, –∏–∑–º–µ–Ω—è—è location.href —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                window.location.href = request.url;
                console.log(`[Content Script] –í—ã–ø–æ–ª–Ω–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ${request.url}`);
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
                sendResponse({ status: "success", message: `–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ${request.url} –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞–Ω` });
            } catch (err) {
                console.error("[Content Script] –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞:", err);
                sendResponse({ status: "error", message: err.message });
            }
        })();
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
        return true;
    }

    if (request.action === "checkPageLoaded") {
        console.log("[Content Script] –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.");
        (async () => {
            try {
                // --- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–†–û–í–ï–†–ö–ò ---
                // –í–º–µ—Å—Ç–æ –∂–µ—Å—Ç–∫–∏—Ö —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º "–ø—Ä–∏–∑–Ω–∞–∫–∏" –∑–∞–≥—Ä—É–∑–∫–∏

                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤–∏–¥–µ–æ
                const isWatchPageLikely = document.querySelector('ytd-watch-flexy') !== null;

                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ—è–≤–∏–ª—Å—è –ª–∏ —Ö–æ—Ç—å –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –∫–∞–∫ —Ü–µ–ª–∞—è —Å–µ–∫—Ü–∏—è, —Ç–∞–∫ –∏ –ø—Ä–æ—Å—Ç–æ –æ–¥–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞
                const hasAnyRecommendationElement =
                    document.querySelector('#related') !== null || // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                    document.querySelector('ytd-compact-video-renderer') !== null || // –ö–∞—Ä—Ç–æ—á–∫–∞ –≤–∏–¥–µ–æ
                    document.querySelector('ytd-item-section-renderer') !== null; // –û–±—â–∞—è —Å–µ–∫—Ü–∏—è

                // 3. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≥—Ä—É–∑–∏–ª—Å—è –ª–∏ –ø–ª–µ–µ—Ä
                // const isPlayerLikelyReady = document.querySelector('#player') !== null || document.querySelector('ytd-watch-flexy video') !== null;

                // –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å—á–∏—Ç–∞–µ—Ç—Å—è "–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π", –µ—Å–ª–∏ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤–∏–¥–µ–æ
                // –∏ –ø–æ—è–≤–∏–ª–∏—Å—å –∫–∞–∫–∏–µ-—Ç–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                const isLoaded = isWatchPageLikely && hasAnyRecommendationElement;

                console.log(`[Content Script] –°—Ç—Ä–∞–Ω–∏—Ü–∞ "–ø–æ—Ö–æ–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞": ${isLoaded}.`, {
                    isWatchPageLikely,
                    hasAnyRecommendationElement,
                    // isPlayerLikelyReady
                });

                sendResponse({
                    status: "success",
                    isLoaded: isLoaded,
                    details: {
                        isWatchPageLikely,
                        hasAnyRecommendationElement,
                        // isPlayerLikelyReady
                    }
                });
            } catch (err) {
                console.error("[Content Script] –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:", err);
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    console.log("[Content Script] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º.");
});

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\content.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\parser.js ===

// content/modules/parser.js

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–¥–µ–æ, –∏—Å–∫–ª—é—á–∞—è –ø–ª–µ–π–ª–∏—Å—Ç—ã –∏ –∫–æ–ª–ª–µ–∫—Ü–∏–∏.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –∏–∑ —Å—Ç–∞—Ä–æ–π, –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏.
 * @returns {HTMLElement[]}
 */
function getVideoCards() {
    console.log("[Content Module Parser] –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤–∏–¥–µ–æ...");
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∏–∑ —Å—Ç–∞—Ä–æ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –∫–æ–¥–∞
    const allPotentialCards = Array.from(document.querySelectorAll('.yt-lockup-view-model'));
    console.log(`[Content Module Parser] –ù–∞–π–¥–µ–Ω–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${allPotentialCards.length}`);

    const filteredCards = allPotentialCards.filter(el => {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —Ç–µ–º –∂–µ –∫—Ä–∏—Ç–µ—Ä–∏—è–º
        const isCollectionStack2 = el.classList.contains('yt-lockup-view-model--collection-stack-2');
        const isCollection = el.classList.contains('yt-lockup-view-model--collection');
        const hasCollectionThumbnail = !!el.querySelector('yt-collection-thumbnail-view-model');
        const hasCollectionsStack = !!el.querySelector('yt-collections-stack');
        const isPlaylist = el.querySelector('a[href*="/watch"]')?.href.includes('list=');

        const shouldBeExcluded = isCollectionStack2 || isCollection || hasCollectionThumbnail || hasCollectionsStack || isPlaylist;

        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏, –≤—ã–≤–µ–¥–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–º, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç—Å—è
        // if (shouldBeExcluded) {
        //     console.log("[Content Module Parser] –ò—Å–∫–ª—é—á–µ–Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∞:", { isCollectionStack2, isCollection, hasCollectionThumbnail, hasCollectionsStack, isPlaylist });
        // }

        return !shouldBeExcluded;
    });

    console.log(`[Content Module Parser] –ù–∞–π–¥–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –≤–∏–¥–µ–æ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏: ${filteredCards.length}`);
    return filteredCards;
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –ø–æ–¥—Å–≤–µ—á–µ–Ω–∞ –ª–∏ –∫–∞—Ä—Ç–æ—á–∫–∞ –∏–ª–∏ –µ—ë —Ä–æ–¥–∏—Ç–µ–ª—å.
 * @param {HTMLElement} el
 * @returns {boolean}
 */
function isAlreadyHighlightedOrHasHighlightedParent(el) {
    if (el.classList.contains('video-highlighted')) return true;
    let parent = el.parentElement;
    while (parent) {
        if (parent.classList?.contains('video-highlighted')) return true;
        parent = parent.parentElement;
    }
    return false;
}

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –≤–∏–∑—É–∞–ª—å–Ω—É—é –ø–æ–¥—Å–≤–µ—Ç–∫—É –∫ —ç–ª–µ–º–µ–Ω—Ç—É.
 * @param {HTMLElement} el
 */
function highlightElement(el) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω –ª–∏ —É–∂–µ —ç–ª–µ–º–µ–Ω—Ç –∏–ª–∏ –µ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—å
    if (isAlreadyHighlightedOrHasHighlightedParent(el)) {
        console.log("[Content Module Parser] –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω –∏–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Ä–æ–¥–∏—Ç–µ–ª—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º.");
        return;
    }

    const box = document.createElement('div');
    Object.assign(box.style, {
        position: 'absolute',
        border: '3px solid #ff4d4d', // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Å—Ç–∏–ª—å, —á—Ç–æ –∏ —Ä–∞–Ω—å—à–µ
        pointerEvents: 'none',
        zIndex: '999999',
        borderRadius: '8px',
        top: '0',
        left: '0',
        width: '100%',
        height: '100%',
        boxShadow: '0 0 8px rgba(255, 77, 77, 0.6)',
        boxSizing: 'border-box' // –î–æ–±–∞–≤–ª—è–µ–º –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ —Ä–∞–º–∫–∏
    });

    // –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–µ—Ç position –¥–ª—è Absolute –ø–æ—Ç–æ–º–∫–∞
    const computedStyle = window.getComputedStyle(el);
    if (!computedStyle.position || computedStyle.position === 'static') {
        el.style.position = 'relative';
    }
    el.style.overflow = 'visible'; // –ß—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –Ω–µ –æ–±—Ä–µ–∑–∞–ª–∞—Å—å

    el.appendChild(box);
    el.classList.add('video-highlighted'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ –∫–ª–∞—Å—Å
    console.log("[Content Module Parser] –≠–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–≤–µ—á–µ–Ω.");
}

/**
 * –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏.
 * @param {HTMLElement[]} cards
 */
function highlightVideoCards(cards) {
    console.log(`[Content Module Parser] –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å ${cards.length} –∫–∞—Ä—Ç–æ—á–µ–∫...`);
    let highlightedCount = 0;
    cards.forEach(el => {
        try {
            highlightElement(el);
            highlightedCount++;
        } catch (err) {
            console.warn("[Content Module Parser] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–µ —ç–ª–µ–º–µ–Ω—Ç–∞:", err);
            // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤–µ—Å—å –ø—Ä–æ—Ü–µ—Å—Å –∏–∑-–∑–∞ –æ–¥–Ω–æ–π –æ—à–∏–±–∫–∏
        }
    });
    console.log(`[Content Module Parser] –£—Å–ø–µ—à–Ω–æ –ø–æ–¥—Å–≤–µ—á–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫: ${highlightedCount}`);
}

/**
 * –ù–∞—Ö–æ–¥–∏—Ç –∏ –ø–æ–¥—Å–≤–µ—á–∏–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –≤–∏–¥–µ–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ YouTube.
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–∞—Å—Å–∏–≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤, –∫–∞–∫ —Ç—Ä–µ–±—É–µ—Ç –ª–æ–≥–∏–∫–∞.
 * @returns {HTMLElement[]} –º–∞—Å—Å–∏–≤ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫
 */
function parseAndHighlightVideoCards() {
    console.log("[Content Module Parser] === –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤–∏–¥–µ–æ ===");

    // 1. –ù–∞–π—Ç–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    const cards = getVideoCards();
    console.log(`[Content Module Parser] –ù–∞–π–¥–µ–Ω–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏: ${cards.length}`);

    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏: –≤—ã–≤–µ–¥–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    console.log("[Content Module Parser] –ü–µ—Ä–≤—ã–µ 3 –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–∞:", cards.slice(0, 3));

    // 2. –ü–æ–¥—Å–≤–µ—Ç–∏—Ç—å –∏—Ö
    highlightVideoCards(cards);

    console.log(`[Content Module Parser] === –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${cards.length} ===`);
    // 3. –í–µ—Ä–Ω—É—Ç—å –º–∞—Å—Å–∏–≤ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    return cards;
}

/**
 * –£–¥–∞–ª—è–µ—Ç –ø–æ–¥—Å–≤–µ—Ç–∫—É, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—É—é parseAndHighlightVideoCards.
 */
function removeParserHighlights() {
    console.log("[Content Module Parser] –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏...");
    const highlightedCards = document.querySelectorAll('.video-highlighted');
    let removedCount = 0;
    highlightedCards.forEach(card => {
        // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω–∞—à —ç–ª–µ–º–µ–Ω—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∏ (—Ä–∞–º–∫—É)
        // –ò—â–µ–º div —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º–∏ —Å—Ç–∏–ª—è–º–∏
        const highlightBoxes = card.querySelectorAll('div[style*="border: 3px solid"]');
        highlightBoxes.forEach(box => {
            box.remove();
            removedCount++;
        });
        card.classList.remove('video-highlighted');
    });
    console.log(`[Content Module Parser] –£–¥–∞–ª–µ–Ω–æ ${removedCount} —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –∏–∑ ${highlightedCards.length} –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫.`);
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.ytParser = {
    parseAndHighlight: parseAndHighlightVideoCards,
    removeHighlights: removeParserHighlights,
    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –º–æ–∂–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    getVideoCards: getVideoCards
};

console.log("[Content Module Parser] –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤.");

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\parser.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\scraper.js ===

// content/modules/scraper.js

/**
 * –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –º–∞—Å—Å–∏–≤–∞ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫.
 * @param {HTMLElement[]} cardElements - –º–∞—Å—Å–∏–≤ DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫ (—É–∂–µ –ø–æ–¥—Å–≤–µ—á–µ–Ω–Ω—ã—Ö).
 * @param {string} sourceVideoId - ID –≤–∏–¥–µ–æ, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥ (—Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ).
 * @returns {Array<Object>} –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –¥–∞–Ω–Ω—ã–º–∏.
 *   –ö–∞–∂–¥—ã–π –æ–±—ä–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç: title, videoId, views, channelName, sourceVideoId, thumbnailUrl.
 */
function scrapeCardsFromElements(cardElements, sourceVideoId = 'unknown') {
    console.log(`[Content Module Scraper] –ù–∞—á–∏–Ω–∞–µ–º —Å–∫—Ä–∞–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö –∏–∑ ${cardElements.length} –∫–∞—Ä—Ç–æ—á–µ–∫...`);
    const scrapedData = [];

    cardElements.forEach((el, index) => {
        try {
            // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–∞ `el` ---
            // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ HTML –º–æ–∂–µ—Ç –Ω–µ–º–Ω–æ–≥–æ –æ—Ç–ª–∏—á–∞—Ç—å—Å—è, –ø–æ—ç—Ç–æ–º—É —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –º–æ–≥—É—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏.

            // 1. –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ
            // –û—Ä–∏–≥–∏–Ω–∞–ª: .yt-lockup-metadata-view-model__title
            // –ù–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ HTML):
            const titleElement = el.querySelector('h3.yt-lockup-metadata-view-model__heading-reset a.yt-lockup-metadata-view-model__title');
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞, –µ—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–∞—è –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∞:
            // const titleElement = el.querySelector('.yt-lockup-metadata-view-model__title');
            const title = titleElement?.textContent?.trim() || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è';

            // 2. ID –≤–∏–¥–µ–æ –∏–∑ —Å—Å—ã–ª–∫–∏
            let videoId = '–ù–µ –Ω–∞–π–¥–µ–Ω';
            // const linkElement = el.querySelector('a[href*="/watch?v="]');
            // –ë–æ–ª–µ–µ –æ–±—â–∏–π —Å–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
            const linkElement = el.querySelector('a[href^="/watch?v="]');
            if (linkElement) {
                try {
                    const url = new URL(linkElement.href, window.location.origin);
                    videoId = url.searchParams.get('v') || '–ù–µ –Ω–∞–π–¥–µ–Ω';
                } catch (e) {
                    console.warn(`[Content Module Scraper] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ URL –¥–ª—è –∫–∞—Ä—Ç–æ—á–∫–∏ ${index}:`, e);
                }
            }

            // 3. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
            let views = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
            // –ò—â–µ–º —Å—Ç—Ä–æ–∫—É –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞—Ö
            const metadataRows = el.querySelectorAll('.yt-content-metadata-view-model__metadata-row');
            for (const row of metadataRows) {
                const rowText = row.textContent || '';
                // console.log(`[Content Module Scraper Debug] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä–æ–∫–∏ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö: "${rowText}"`); // <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ —Ä—É—Å—Å–∫–∏–π), –∏–≥–Ω–æ—Ä–∏—Ä—É—è –¥–∞—Ç—É –ø–æ—Å–ª–µ "‚Ä¢"
                // –ü—Ä–∏–º–µ—Ä—ã: "21M views ‚Ä¢ 5 days ago", "195 —Ç—ã—Å. –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ ‚Ä¢ 2 –¥–Ω—è –Ω–∞–∑–∞–¥"
                // –£—á–∏—Ç—ã–≤–∞–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã (\u00A0) –∏ –æ–±—ã—á–Ω—ã–µ –ø—Ä–æ–±–µ–ª—ã
                const normalizedText = rowText.replace(/\u00A0/g, ' '); // –ó–∞–º–µ–Ω—è–µ–º –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª –Ω–∞ –æ–±—ã—á–Ω—ã–π –¥–ª—è –ø–æ–∏—Å–∫–∞

                // –ü–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞: —á–∏—Å–ª–æ + (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ K/M/B –∏–ª–∏ —Ç—ã—Å./–º–ª–Ω./–º–ª—Ä–¥.) + (views/view/–ø—Ä–æ—Å–º–æ—Ç—Ä/–ø—Ä–æ—Å–º–æ—Ç—Ä–∞/–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤)
                // \b - –≥—Ä–∞–Ω–∏—Ü–∞ —Å–ª–æ–≤–∞
                // [\d\s\u00A0,.]+ - –æ–¥–Ω–∞ –∏–ª–∏ –±–æ–ª–µ–µ —Ü–∏—Ñ—Ä–∞, –ø—Ä–æ–±–µ–ª, –Ω–µ—Ä–∞–∑—Ä—ã–≤–Ω—ã–π –ø—Ä–æ–±–µ–ª, –∑–∞–ø—è—Ç–∞—è –∏–ª–∏ —Ç–æ—á–∫–∞
                // (?:K|M|B|k|m|b|—Ç—ã—Å\.?|–º–ª–Ω\.?|–º–ª—Ä–¥\.?) - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—â–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è –º–Ω–æ–∂–∏—Ç–µ–ª–µ–π
                // \s* - –Ω–æ–ª—å –∏–ª–∏ –±–æ–ª–µ–µ –ø—Ä–æ–±–µ–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
                // (?:views?|–ø—Ä–æ—Å–º–æ—Ç—Ä–∞?|–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤|view) - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—â–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è —Å–ª–æ–≤ "views", "view", "–ø—Ä–æ—Å–º–æ—Ç—Ä", "–ø—Ä–æ—Å–º–æ—Ç—Ä–∞", "–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤"
                // .*? - –ª–µ–Ω–∏–≤—ã–π –∑–∞—Ö–≤–∞—Ç –≤—Å–µ–≥–æ –¥–æ "‚Ä¢" –∏–ª–∏ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
                // (?:\s*‚Ä¢.*)? - –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—â–∞—è –≥—Ä—É–ø–ø–∞ –¥–ª—è " ‚Ä¢ ..." –≤ –∫–æ–Ω—Ü–µ, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è
                // $ - –∫–æ–Ω–µ—Ü —Å—Ç—Ä–æ–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ —Ç–µ–∫—Å—Ç –º–æ–∂–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å—Å—è)
                const viewsPattern = /([\d\s\u00A0,.]+(?:K|M|B|k|m|b|—Ç—ã—Å\.?|–º–ª–Ω\.?|–º–ª—Ä–¥\.?)?\s*(?:views?|–ø—Ä–æ—Å–º–æ—Ç—Ä–∞?|–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤|view))/i;

                const match = normalizedText.match(viewsPattern);

                if (match) {
                    // match[1] —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞–π–¥–µ–Ω–Ω—É—é –ø–æ–¥—Å—Ç—Ä–æ–∫—É —Å —á–∏—Å–ª–æ–º –∏ —Å–ª–æ–≤–æ–º
                    let viewsPart = match[1].trim();
                    // console.log(`[Content Module Scraper Debug] –ù–∞–π–¥–µ–Ω–∞ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: "${viewsPart}"`); // <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

                    // –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ "views/view/–ø—Ä–æ—Å–º–æ—Ç—Ä/–ø—Ä–æ—Å–º–æ—Ç—Ä–∞/–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤" –∏–∑ —Å—Ç—Ä–æ–∫–∏
                    // –≠—Ç–æ –¥–µ–ª–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç —á–∏—â–µ, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ
                    viewsPart = viewsPart
                        .replace(/\s*(?:views?|–ø—Ä–æ—Å–º–æ—Ç—Ä–∞?|–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤|view)\s*$/i, '') // –£–±–∏—Ä–∞–µ–º —Å–ª–æ–≤–æ –≤ –∫–æ–Ω—Ü–µ
                        .trim();

                    // –ë–µ—Ä–µ–º —á–∞—Å—Ç—å –¥–æ "‚Ä¢", –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –ø–∞—Ç—Ç–µ—Ä–Ω –∑–∞—Ö–≤–∞—Ç–∏–ª –±–æ–ª—å—à–µ)
                    const parts = viewsPart.split('‚Ä¢');
                    views = parts[0].trim();

                    // console.log(`[Content Module Scraper Debug] –ò–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–æ—Å–º–æ—Ç—Ä—ã: "${views}"`); // <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    break; // –ù–∞—à–ª–∏, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞
                }
            }
            // –ï—Å–ª–∏ views –≤—Å—ë –µ—â—ë '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', –ø–æ–ø—Ä–æ–±—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø–æ–¥—Ö–æ–¥, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º –∫–æ–¥–µ
            if (views === '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ') {
                // console.log(`[Content Module Scraper Debug] –ü—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º...`); // <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                for (const row of metadataRows) {
                    const rowText = row.textContent || '';
                    const normalizedText = rowText.replace(/\u00A0/g, ' ');
                    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
                    if (/\b(?:views?|–ø—Ä–æ—Å–º–æ—Ç—Ä–∞?|–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤|view)\b/i.test(normalizedText)) {
                        // console.log(`[Content Module Scraper Debug] –ù–∞–π–¥–µ–Ω–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ –≤: "${normalizedText}"`); // <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                        // –ë–µ—Ä–µ–º —á–∞—Å—Ç—å –¥–æ "‚Ä¢"
                        const parts = normalizedText.split('‚Ä¢');
                        const potentialViews = parts[0].trim();
                        // –ü—Ä–æ—Å—Ç–∞—è –æ—á–∏—Å—Ç–∫–∞: —É–±–∏—Ä–∞–µ–º –≤—Å—ë –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª–æ–≤–∞, –ø–æ—Ö–æ–∂–µ–≥–æ –Ω–∞ "views/–ø—Ä–æ—Å–º–æ—Ç—Ä—ã"
                        const cleaned = potentialViews.replace(/\s*(?:views?|–ø—Ä–æ—Å–º–æ—Ç—Ä–∞?|–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤|view)\s*$/i, '').trim();
                        if (cleaned) {
                            views = cleaned;
                            // console.log(`[Content Module Scraper Debug] –ò–∑–≤–ª–µ—á–µ–Ω—ã –ø—Ä–æ—Å–º–æ—Ç—Ä—ã (–ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–±): "${views}"`); // <-- –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                            break;
                        }
                    }
                }
            }

            // 4. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞
            let channelName = '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
            // –í –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º HTML –∫–∞–Ω–∞–ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–Ω—É—Ç—Ä–∏ .yt-content-metadata-view-model__metadata-row
            // –∏ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: ... ChessMaster <–∏–∫–æ–Ω–∫–∞ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏> ...
            // –ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ span/text –Ω–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥ –∏–ª–∏ –ø–æ—Å–ª–µ –∏–∫–æ–Ω–∫–∏, –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç –¥–æ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è.
            const channelMetadataRow = Array.from(metadataRows).find(row =>
                row.querySelector('span.yt-core-attributed-string--link-inherit-color') &&
                !row.querySelector('span.yt-content-metadata-view-model__delimiter') // –ò—Å–∫–ª—é—á–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –¥–∞—Ç–æ–π
            );

            if (channelMetadataRow) {
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π span —Å –∏–º–µ–Ω–µ–º –∫–∞–Ω–∞–ª–∞
                const channelSpan = channelMetadataRow.querySelector('span.yt-core-attributed-string--link-inherit-color');
                if (channelSpan) {
                    // –£–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏, –µ—Å–ª–∏ –æ–Ω–∞ –≤–Ω—É—Ç—Ä–∏
                    const verifiedIcon = channelSpan.querySelector('.ytIconWrapperHost');
                    if (verifiedIcon) {
                        verifiedIcon.remove(); // –í—Ä–µ–º–µ–Ω–Ω–æ —É–¥–∞–ª—è–µ–º, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∞ textContent
                    }
                    channelName = channelSpan.textContent?.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                    if (verifiedIcon) {
                        channelSpan.appendChild(verifiedIcon); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –º–µ—Å—Ç–æ
                    }
                } else {
                    // –ï—Å–ª–∏ span –Ω–µ –Ω–∞–π–¥–µ–Ω, –±–µ—Ä–µ–º –≤–µ—Å—å —Ç–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ –∏ –ø—ã—Ç–∞–µ–º—Å—è –∏–∑–≤–ª–µ—á—å –∏–º—è
                    const fullText = channelMetadataRow.textContent || '';
                    // –ü—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: –∏–º—è –∫–∞–Ω–∞–ª–∞ –¥–æ –ø–µ—Ä–≤–æ–≥–æ "‚Ä¢"
                    const parts = fullText.split('‚Ä¢');
                    channelName = parts[0]?.trim() || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
                }
            }

            // 5. Thumbnail URL
            let thumbnailUrl = '';
            const thumbnailImg = el.querySelector('yt-thumbnail-view-model img.ytCoreImageHost');
            if (thumbnailImg && thumbnailImg.src) {
                thumbnailUrl = thumbnailImg.src;
            }

            // --- –°–±–æ—Ä–∫–∞ –æ–±—ä–µ–∫—Ç–∞ –¥–∞–Ω–Ω—ã—Ö ---
            const scrapedItem = {
                title,
                videoId,
                views,
                channelName,
                sourceVideoId, // –ü–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏–∑–≤–Ω–µ
                thumbnailUrl
            };

            scrapedData.push(scrapedItem);
            // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏, –º–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–µ N —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            // if (index < 3) {
            //     console.log(`[Content Module Scraper] –î–∞–Ω–Ω—ã–µ –∏–∑ –∫–∞—Ä—Ç–æ—á–∫–∏ ${index + 1}:`, scrapedItem);
            // }

        } catch (err) {
            console.error(`[Content Module Scraper] –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫—Ä–∞–ø–∏–Ω–≥–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ${index}:`, err);
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ–± –æ—à–∏–±–∫–µ, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å —Å—á–µ—Ç
            scrapedData.push({
                title: `–û—à–∏–±–∫–∞ —Å–∫—Ä–∞–ø–∏–Ω–≥–∞ ${index}`,
                videoId: '',
                views: '',
                channelName: '',
                sourceVideoId: sourceVideoId,
                thumbnailUrl: '',
                _scrapeError: err.message // –î–æ–ø. –ø–æ–ª–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            });
        }
    });

    console.log(`[Content Module Scraper] –°–∫—Ä–∞–ø–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω. –ò–∑–≤–ª–µ—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö: ${scrapedData.length}`);
    return scrapedData;
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
window.ytScraper = {
    scrapeCards: scrapeCardsFromElements
};

console.log("[Content Module Scraper] –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤.");

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\scraper.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\scroller.js ===

// content/modules/scroller.js

/**
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–¥–∏–Ω —à–∞–≥ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
 * @param {number} step - –ù–∞ —Å–∫–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–µ–π —Å–∫—Ä–æ–ª–ª–∏—Ç—å.
 * @returns {Promise<void>}
 */
function performSingleScroll(step = 1000) {
    return new Promise((resolve) => {
        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª
        window.scrollBy(0, step);
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å
        // –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å, –µ—Å–ª–∏ YouTube –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –ª–µ–Ω–∏–≤–æ
        setTimeout(() => {
            console.log(`[Content Module Scroller] –í—ã–ø–æ–ª–Ω–µ–Ω –æ–¥–∏–Ω —Å–∫—Ä–æ–ª–ª –Ω–∞ ${step}px.`);
            resolve();
        }, 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 50–º—Å
    });
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
// –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–∞–∫ window.performSingleScroll
window.performSingleScroll = performSingleScroll;

console.log("[Content Module Scroller] –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤.");

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\scroller.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\video-checker.js ===

// content/modules/video-checker.js

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –¥–æ—Å—Ç—É–ø–Ω–æ –ª–∏ —Ç–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ YouTube.
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ content script.
 * @returns {Promise<boolean>} true, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –¥–æ—Å—Ç—É–ø–Ω–æ, false - –µ—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–ª–∏ –Ω–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–µ–æ.
 */
function isCurrentVideoAvailable() {
    console.log("[Content Module VideoChecker] –ù–∞—á–∞–ª–æ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ.");

    try {
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º URL - —á–∞—Å—Ç–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∏–¥–µ–æ –∏–º–µ—é—Ç —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π URL
        if (window.location.pathname === '/unavailable') {
            console.log("[Content Module VideoChecker] –û–±–Ω–∞—Ä—É–∂–µ–Ω URL /unavailable.");
            return false;
        }

        // 2. –ò—â–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —ç–ª–µ–º–µ–Ω—Ç –ø–ª–µ–µ—Ä–∞ –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–∏–¥–µ–æ
        const playerElement = document.querySelector('#player, ytd-watch-flexy');
        if (!playerElement) {
            console.log("[Content Module VideoChecker] –ù–µ –Ω–∞–π–¥–µ–Ω –æ—Å–Ω–æ–≤–Ω–æ–π —ç–ª–µ–º–µ–Ω—Ç –ø–ª–µ–µ—Ä–∞ –∏–ª–∏ watch-flexy.");
            // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–∏–¥–µ–æ, –Ω–æ –º—ã –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–ª—å—à–µ
        }

        // 3. –ò—â–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç-–∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
        // –ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ HTML
        const promoRenderer = document.querySelector('ytd-background-promo-renderer');
        if (promoRenderer) {
            const titleElement = promoRenderer.querySelector('.promo-title');
            const titleText = titleElement?.textContent?.trim().toLowerCase() || '';

            const bodyTextElement = promoRenderer.querySelector('.promo-body-text');
            const bodyText = bodyTextElement?.textContent?.trim().toLowerCase() || '';

            // –°–ø–∏—Å–æ–∫ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ñ—Ä–∞–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            const unavailableIndicators = [
                'video unavailable',
                'this video is private',
                'this video is unavailable',
                'this video has been removed',
                'video –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω',
                '–≤–∏–¥–µ–æ —É–¥–∞–ª–µ–Ω–æ',
                '–≤–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ'
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –Ω–∞ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–∞—Ö
            ];

            const isUnavailableTitle = unavailableIndicators.some(phrase => titleText.includes(phrase.toLowerCase()));
            const isUnavailableBody = unavailableIndicators.some(phrase => bodyText.includes(phrase.toLowerCase()));

            if (isUnavailableTitle || isUnavailableBody) {
                console.log(`[Content Module VideoChecker] –ù–∞–π–¥–µ–Ω–∞ –ø–ª–∞—à–∫–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏. –ó–∞–≥–æ–ª–æ–≤–æ–∫: '${titleText}', –¢–µ–ª–æ: '${bodyText}'`);
                return false;
            }
        }

        // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–± –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–æ–∑—Ä–∞—Å—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
        // –≠—Ç–æ –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, –æ—Å—Ç–∞–≤–∏–º –Ω–∞ –ø–æ—Ç–æ–º –∏–ª–∏ –µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è

        // 5. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã —è–≤–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏, —Å—á–∏—Ç–∞–µ–º –≤–∏–¥–µ–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º
        // (–∏–ª–∏ –Ω–∞ –¥—Ä—É–≥–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ, –Ω–æ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ "–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏")
        console.log("[Content Module VideoChecker] –ü—Ä–∏–∑–Ω–∞–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –°—á–∏—Ç–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–º.");
        return true;

    } catch (err) {
        console.error("[Content Module VideoChecker] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤–∏–¥–µ–æ:", err);
        // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏, –ª—É—á—à–µ —Å—á–∏—Ç–∞—Ç—å –≤–∏–¥–µ–æ –¥–æ—Å—Ç—É–ø–Ω—ã–º, —á—Ç–æ–±—ã –Ω–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–±–æ—Ç—É
        return true;
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏ –¥–ª—è –≤—ã–∑–æ–≤–∞ –∏–∑ content.js
window.ytVideoChecker = {
    isCurrentVideoAvailable: isCurrentVideoAvailable
};

console.log("[Content Module VideoChecker] –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤.");

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\video-checker.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\data-processor.js ===

// core/data-processor.js

/**
 * @typedef {import('./types/table.types.js').VideoData} VideoData
 */

/**
 * –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–∞—Å—Å–∏–≤–∞ –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö).
 * @param {VideoData[]} videoDataArray - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–µ–æ.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏.
 * @returns {Set<string>} .visitedVideoIds - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ, –ù–ê –ö–û–¢–û–†–´–ï –£–ñ–ï –ó–ê–•–û–î–ò–õ–ò (sourceVideoId).
 * @returns {Map<string, number>} .channelVideoCounts - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞.
 * @returns {Map<string, Set<string>>} .channelToVideoIds - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (videoId).
 */
export function prepareImportedDataIndices(videoDataArray) {
    // 1. –°–µ—Ç –≤–∏–¥–µ–æ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª–∏ (sourceVideoId)
    // –≠—Ç–æ –≤–∏–¥–µ–æ, —Å –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥, —Ç.–µ. –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ "—Ç–µ–∫—É—â–∏–º–∏".
    const visitedVideoIds = new Set();

    // 2. –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞
    const channelVideoCounts = new Map();

    // 3. –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (videoId)
    const channelToVideoIds = new Map();

    if (!Array.isArray(videoDataArray)) {
        console.warn("[DataProcessor] –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º.");
        return { visitedVideoIds, channelVideoCounts, channelToVideoIds };
    }

    for (const video of videoDataArray) {
        // --- 1. –ó–∞–ø–æ–ª–Ω—è–µ–º visitedVideoIds ---
        // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º sourceVideoId, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ ID –≤–∏–¥–µ–æ,
        // –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º—ã "–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å" –∏ —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª–∏.
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç—Ç–æ –∂–µ –≤–∏–¥–µ–æ.
        if (video.sourceVideoId) {
            visitedVideoIds.add(video.sourceVideoId);
        }
        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å videoId (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–∏–¥–µ–æ –≤ —Ç–∞–±–ª–∏—Ü—É),
        // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, allParsedVideoIds. –ù–æ –¥–ª—è visitedVideoIds - —ç—Ç–æ sourceVideoId.

        // --- 2. –ó–∞–ø–æ–ª–Ω—è–µ–º channelVideoCounts ---
        const channel = video.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
        const currentCount = channelVideoCounts.get(channel) || 0;
        channelVideoCounts.set(channel, currentCount + 1);

        // --- 3. –ó–∞–ø–æ–ª–Ω—è–µ–º channelToVideoIds ---
        // –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º videoId, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ö–æ—Ç–∏–º –∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∏–¥–µ–æ
        // –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∫–∞–Ω–∞–ª—É.
        if (!channelToVideoIds.has(channel)) {
            channelToVideoIds.set(channel, new Set());
        }
        if (video.videoId) {
            channelToVideoIds.get(channel).add(video.videoId);
        }
    }

    return {
        visitedVideoIds,
        channelVideoCounts,
        channelToVideoIds
    };
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\data-processor.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\index-manager.js ===

// core/index-manager.js

/**
 * –ú–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–¥–µ–∫—Å–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–∞—Ä—Å–∏–Ω–≥–∞.
 * –£–ø—Ä–∞–≤–ª—è–µ—Ç visitedVideoIds, channelVideoCounts, channelToVideoIds –∏ scrapedData.
 */

// --- 1. –°–æ—Å—Ç–æ—è–Ω–∏–µ (–≤ –ø–∞–º—è—Ç–∏ background.js) ---
/** @type {Set<string>} - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º—ã —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª–∏ (sourceVideoId). */
let visitedVideoIds = new Set();

/** @type {Map<string, number>} - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞. */
let channelVideoCounts = new Map();

/** @type {Map<string, Set<string>>} - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞. */
let channelToVideoIds = new Map();

/** @type {Array<Object>} - –ú–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö, –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –≤ —Ö–æ–¥–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞. */
let scrapedDataBuffer = [];

// --- 2. API –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏ ---

/**
 * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∏–Ω–¥–µ–∫—Å—ã, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 * @param {Array<Object>} [initialData=[]] - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ tableAdapter.getAll()).
 * @returns {Promise<void>}
 */
export async function initialize(initialData = []) {
    console.log("[IndexManager] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤...");
    reset(); // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

    if (!Array.isArray(initialData) || initialData.length === 0) {
        console.log("[IndexManager] –ù–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤.");
        return;
    }

    console.log(`[IndexManager] –ù–∞—á–∏–Ω–∞–µ–º –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–∑ ${initialData.length} –∑–∞–ø–∏—Å–µ–π...`);
    let processedCount = 0;

    for (const video of initialData) {
        // --- visitedVideoIds: ID –≤–∏–¥–µ–æ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∑–∞—Ö–æ–¥–∏–ª–∏ (sourceVideoId) ---
        // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –µ—Å–ª–∏ –∑–∞–ø–∏—Å—å –µ—Å—Ç—å, —Ç–æ –Ω–∞ —ç—Ç–æ video.sourceVideoId –º—ã —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª–∏.
        if (video.sourceVideoId) {
            visitedVideoIds.add(video.sourceVideoId);
        }

        // --- channelVideoCounts: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ ---
        const channel = video.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
        const currentCount = channelVideoCounts.get(channel) || 0;
        channelVideoCounts.set(channel, currentCount + 1);

        // --- channelToVideoIds: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ ---
        if (!channelToVideoIds.has(channel)) {
            channelToVideoIds.set(channel, new Set());
        }
        if (video.videoId) {
            channelToVideoIds.get(channel).add(video.videoId);
        }

        processedCount++;
    }

    console.log(`[IndexManager] –ò–Ω–¥–µ–∫—Å—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–ø–∏—Å–µ–π: ${processedCount}`);
    console.log(`[IndexManager] visitedVideoIds.size: ${visitedVideoIds.size}`);
    console.log(`[IndexManager] channelVideoCounts.size: ${channelVideoCounts.size}`);
    console.log(`[IndexManager] channelToVideoIds.size: ${channelToVideoIds.size}`);
}

/**
 * –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏ –±—É—Ñ–µ—Ä –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ.
 */
export function reset() {
    console.log("[IndexManager] –°–±—Ä–æ—Å –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –±—É—Ñ–µ—Ä–∞.");
    visitedVideoIds.clear();
    channelVideoCounts.clear();
    channelToVideoIds.clear();
    scrapedDataBuffer = [];
    console.log("[IndexManager] –í—Å–µ –∏–Ω–¥–µ–∫—Å—ã –∏ –±—É—Ñ–µ—Ä —Å–±—Ä–æ—à–µ–Ω—ã.");
}

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –∏–Ω–¥–µ–∫—Å—ã –∏ –±—É—Ñ–µ—Ä.
 * @param {Array<Object>} newScrapedData - –ú–∞—Å—Å–∏–≤ –Ω–æ–≤—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –¥–∞–Ω–Ω—ã—Ö –≤–∏–¥–µ–æ.
 */
export function addScrapedData(newScrapedData, addToBuffer = true) {
    if (!Array.isArray(newScrapedData) || newScrapedData.length === 0) {
        console.warn("[IndexManager] addScrapedData: –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –º–∞—Å—Å–∏–≤ –¥–∞–Ω–Ω—ã—Ö.");
        return;
    }
    console.log(`[IndexManager] –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ${newScrapedData.length} –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ –∏–Ω–¥–µ–∫—Å—ã. addToBuffer: ${addToBuffer}`, { module: 'IndexManager' });

    // 1. –î–æ–±–∞–≤–ª—è–µ–º –≤ –±—É—Ñ–µ—Ä, –µ—Å–ª–∏ addToBuffer === true
    if (addToBuffer) {
        scrapedDataBuffer.push(...newScrapedData);
        console.log(`[IndexManager] –î–æ–±–∞–≤–ª–µ–Ω–æ ${newScrapedData.length} –∑–∞–ø–∏—Å–µ–π –≤ scrapedDataBuffer. –ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä –±—É—Ñ–µ—Ä–∞: ${scrapedDataBuffer.length}`, { module: 'IndexManager' });
    } else {
        console.log(`[IndexManager] –ü—Ä–æ–ø—É—â–µ–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ scrapedDataBuffer (addToBuffer=false).`, { module: 'IndexManager' });
    }

    // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–µ–∫—Å—ã (—ç—Ç–æ –≤—Å–µ–≥–¥–∞ –Ω—É–∂–Ω–æ –¥–µ–ª–∞—Ç—å)
    for (const video of newScrapedData) {
        // visitedVideoIds –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è, –µ—Å–ª–∏ sourceVideoId —è–≤–ª—è–µ—Ç—Å—è "–ø–æ—Å–µ—â–µ–Ω–Ω—ã–º"
        // –ù–æ –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ sourceVideoId - —ç—Ç–æ –≤–∏–¥–µ–æ, –° –ö–û–¢–û–†–û–ì–û –º—ã –ø—Ä–∏—à–ª–∏.
        // visitedVideoIds - —ç—Ç–æ —Å–∫–æ—Ä–µ–µ ID –≤–∏–¥–µ–æ, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ü–ê–†–°–ò–õ–ò –∫–∞–∫ –∏—Å—Ç–æ—á–Ω–∏–∫.
        // –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–∞–∫–∏–µ –∏—Å—Ö–æ–¥–Ω—ã–µ –≤–∏–¥–µ–æ –º—ã —É–∂–µ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏,
        // —Ç–æ sourceVideoId –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ visitedVideoIds.
        // –ï—Å–ª–∏ –º—ã —Ö–æ—Ç–∏–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –∫–∞–∫–∏–µ –≤–∏–¥–µ–æ –º—ã –£–ñ–ï –ù–ê–®–õ–ò (–∏ –Ω–µ –¥–æ–ª–∂–Ω—ã –¥–æ–±–∞–≤–ª—è—Ç—å —Å–Ω–æ–≤–∞),
        // —Ç–æ videoId –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å.
        // –î–ª—è MVP: visitedVideoIds –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç sourceVideoId (–æ—Ç–∫—É–¥–∞ –ø—Ä–∏—à–ª–∏).
        if (video.sourceVideoId) {
            visitedVideoIds.add(video.sourceVideoId);
            // console.log(`[IndexManager] –î–æ–±–∞–≤–ª–µ–Ω sourceVideoId –≤ visitedVideoIds: ${video.sourceVideoId}`, { module: 'IndexManager' });
        }

        // channelVideoCounts –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
        const channel = video.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
        const currentCount = channelVideoCounts.get(channel) || 0;
        channelVideoCounts.set(channel, currentCount + 1);
        // console.log(`[IndexManager] –û–±–Ω–æ–≤–ª–µ–Ω channelVideoCounts –¥–ª—è –∫–∞–Ω–∞–ª–∞ ${channel}: ${currentCount} -> ${currentCount + 1}`, { module: 'IndexManager' });

        // channelToVideoIds –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
        if (!channelToVideoIds.has(channel)) {
            channelToVideoIds.set(channel, new Set());
        }
        if (video.videoId) {
            channelToVideoIds.get(channel).add(video.videoId);
            // console.log(`[IndexManager] –î–æ–±–∞–≤–ª–µ–Ω videoId –≤ channelToVideoIds –¥–ª—è –∫–∞–Ω–∞–ª–∞ ${channel}: ${video.videoId}`, { module: 'IndexManager' });
        }
    }

    console.log(`[IndexManager] –ò–Ω–¥–µ–∫—Å—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`, { module: 'IndexManager' });
    console.log(`[IndexManager] visitedVideoIds.size: ${visitedVideoIds.size}`, { module: 'IndexManager' });
    console.log(`[IndexManager] channelVideoCounts.size: ${channelVideoCounts.size}`, { module: 'IndexManager' });
    console.log(`[IndexManager] channelToVideoIds.size: ${channelToVideoIds.size}`, { module: 'IndexManager' });

    // 3. –û–ø–æ–≤–µ—â–∞–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–Ω–¥–µ–∫—Å–æ–≤/–±—É—Ñ–µ—Ä–∞
    // broadcastDataUpdate(); // –£–±–∏—Ä–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç tableAdapter
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ—Ö –∏–Ω–¥–µ–∫—Å–æ–≤ –∏ –±—É—Ñ–µ—Ä–∞.
 * @returns {{ visitedVideoIds: Set<string>, channelVideoCounts: Map<string, number>, channelToVideoIds: Map<string, Set<string>>, scrapedDataBuffer: Array<Object> }}
 */
export function getStateSnapshot() {
    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–æ–ø–∏–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –≤–Ω–µ—à–Ω–µ–µ –º—É—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    return {
        visitedVideoIds: new Set(visitedVideoIds),
        channelVideoCounts: new Map(channelVideoCounts),
        channelToVideoIds: new Map(Array.from(channelToVideoIds, ([k, v]) => [k, new Set(v)])),
        scrapedDataBuffer: [...scrapedDataBuffer] // –ö–æ–ø–∏—è –º–∞—Å—Å–∏–≤–∞
    };
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—É—â–∏–π –±—É—Ñ–µ—Ä –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 * @returns {Array<Object>} –ö–æ–ø–∏—è –º–∞—Å—Å–∏–≤–∞ scrapedDataBuffer.
 */
export function getScrapedDataBuffer() {
    return [...scrapedDataBuffer];
}

/**
 * –û—á–∏—â–∞–µ—Ç –±—É—Ñ–µ—Ä –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
 */
export function clearScrapedDataBuffer() {
    console.log("[IndexManager] –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.");
    scrapedDataBuffer = [];
    console.log("[IndexManager] –ë—É—Ñ–µ—Ä –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—á–∏—â–µ–Ω.");
}

// --- 3. –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏) ---

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –±—ã–ª –ª–∏ —É–∂–µ –ø–æ—Å–µ—â–µ–Ω —É–∫–∞–∑–∞–Ω–Ω—ã–π sourceVideoId.
 * @param {string} sourceVideoId
 * @returns {boolean}
 */
export function isSourceVisited(sourceVideoId) {
    return visitedVideoIds.has(sourceVideoId);
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –¥–∞–Ω–Ω—ã—Ö.
 * @returns {number}
 */
export function getUniqueChannelCount() {
    return channelVideoCounts.size;
}

/**
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –¥–∞–Ω–Ω—ã—Ö.
 * @returns {number}
 */
export function getTotalUniqueVideoCount() {
    // –°—É–º–º–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–∏–¥–µ–æ –ø–æ –≤—Å–µ–º –∫–∞–Ω–∞–ª–∞–º
    let total = 0;
    for (const videoIdsSet of channelToVideoIds.values()) {
        total += videoIdsSet.size;
    }
    return total;
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ç–∞–∫–∂–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∞–º–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
// (–Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å getStateSnapshot –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏)
export { visitedVideoIds, channelVideoCounts, channelToVideoIds };

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\index-manager.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\logger.js ===

// core/logger.js
import { ChromeStorageLogAdapter } from '../adapters/ChromeStorageLogAdapter.js';

/**
 * @typedef {import('./types/log.types.js').LogEntry} LogEntry
 * @typedef {import('./types/log.types.js').LoggerConfig} LoggerConfig
 * @typedef {import('./types/log.types.js').LogAdapter} LogAdapter
 * @typedef {import('./types/log.types.js').LogSubscriber} LogSubscriber
 */

export class Logger {
    /** @type {LogAdapter[]} */
    #adapters = [];
    /** @type {LogSubscriber[]} */
    #subscribers = [];
    /** @type {LoggerConfig} */
    #config;

    /**
     * @param {LoggerConfig} config
     */
    constructor(config = {}) {
        this.#config = {
            maxSize: config.maxSize ?? 1000,
            enableConsole: config.enableConsole ?? true,
            defaultLevel: config.defaultLevel ?? 'info',
        };

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–±–∞–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è Chrome Storage
        this.addAdapter(new ChromeStorageLogAdapter({ maxSize: this.#config.maxSize }));
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è/–≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤.
     * @param {LogAdapter} adapter
     */
    addAdapter(adapter) {
        this.#adapters.push(adapter);
    }

    /**
     * –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–µ –ª–æ–≥–∏ –∏ –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—á–∏—Å—Ç–∫–∞).
     * @param {LogSubscriber} callback
     */
    subscribe(callback) {
        this.#subscribers.push(callback);
    }

    /**
     * –û—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤.
     * @param {LogSubscriber} callback
     */
    unsubscribe(callback) {
        this.#subscribers = this.#subscribers.filter(cb => cb !== callback);
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥-–∑–∞–ø–∏—Å—å.
     * @param {string} message
     * @param {'debug'|'info'|'success'|'warn'|'error'} [level]
     * @param {Object} [options]
     * @param {string} [options.module]
     * @param {string} [options.contextId]
     * @param {Object} [options.meta]
     */
    async log(message, level = this.#config.defaultLevel, options = {}) {
        const entry = {
            id: this.#generateId(),
            timestamp: Date.now(),
            level,
            message,
            module: options.module,
            contextId: options.contextId,
            meta: options.meta,
        };

        // 1. –ó–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä—ã
        const writePromises = this.#adapters.map(adapter => adapter.write(entry));
        await Promise.allSettled(writePromises); // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ–¥–Ω–æ–≥–æ –∞–¥–∞–ø—Ç–µ—Ä–∞

        // 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        if (this.#config.enableConsole) {
            this.#logToConsole(entry);
        }

        // 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        this.#notifySubscribers(entry);

        // 4. üëá –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ popup (–µ—Å–ª–∏ –≤ background)
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Service Worker (background)
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ this
                chrome.runtime.sendMessage({
                    type: "newLog",
                    log: entry
                }).catch(err => {
                    // –≠—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ sendMessage
                    if (chrome.runtime.lastError) {
                        // –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ popup –∑–∞–∫—Ä—ã—Ç
                        // console.debug("Popup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è sendMessage:", chrome.runtime.lastError.message);
                    } else {
                        console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–æ–≥–∞ –≤ popup (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è):", err);
                    }
                });
            } catch (syncSendError) {
                // –≠—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ sendMessage
                // –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (—Ä–µ–¥–∫–æ)
                console.debug("–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ sendMessage:", syncSendError);
            }
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ª–æ–≥–∏ –∏–∑ –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ (–±–µ—Ä–µ—Ç –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ).
     * @returns {Promise<LogEntry[]>}
     */
    async getAllLogs() {
        for (const adapter of this.#adapters) {
            try {
                const logs = await adapter.read();
                return logs;
            } catch (e) {
                console.warn("[Logger] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∏–∑ –∞–¥–∞–ø—Ç–µ—Ä–∞:", e);
            }
        }
        return []; // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∞–¥–∞–ø—Ç–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    }

    /**
     * –û—á–∏—â–∞–µ—Ç –ª–æ–≥–∏ –≤–æ –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–∞—Ö.
     * @returns {Promise<void>}
     */
    async clear() {
        const clearPromises = this.#adapters.map(adapter => adapter.clear());
        await Promise.allSettled(clearPromises);
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ–± –æ—á–∏—Å—Ç–∫–µ
        this.#notifySubscribers({ type: 'CLEAR_LOGS' });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---

    /**
     * –£–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
     */
    debug(message, options = {}) { return this.log(message, 'debug', options); }
    info(message, options = {}) { return this.log(message, 'info', options); }
    success(message, options = {}) { return this.log(message, 'success', options); }
    warn(message, options = {}) { return this.log(message, 'warn', options); }
    error(message, options = {}) { return this.log(message, 'error', options); }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∑–∞–ø–∏—Å–∏.
     * @returns {string}
     */
    #generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    /**
     * –í—ã–≤–æ–¥–∏—Ç –ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.
     * @param {LogEntry} entry
     */
    #logToConsole(entry) {
        const time = new Date(entry.timestamp).toLocaleTimeString();
        const prefix = `[${time}] [${entry.level.toUpperCase()}]`;
        const suffix = entry.module ? `[${entry.module}]` : '';
        const context = entry.contextId ? `(ctx:${entry.contextId})` : '';

        const consoleMethod = entry.level === 'error' ? console.error :
            entry.level === 'warn' ? console.warn :
                entry.level === 'debug' ? console.debug : console.log;

        consoleMethod(`${prefix} ${entry.message} ${suffix} ${context}`, entry.meta || '');
    }

    /**
     * –£–≤–µ–¥–æ–º–ª—è–µ—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
     * @param {LogEntry | { type: 'CLEAR_LOGS' }} entry
     */
    #notifySubscribers(entry) {
        this.#subscribers.forEach(callback => {
            try {
                callback(entry);
            } catch (e) {
                console.error("[Logger] –û—à–∏–±–∫–∞ –≤ –ø–æ–¥–ø–∏—Å—á–∏–∫–µ:", e);
            }
        });
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\logger.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\scenario-engine.js ===


// core/scenario-engine.js
import { logger } from '../background/background.js'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä

/**
 * @typedef {import('./types/scenario.types.js').ScenarioDefinition} ScenarioDefinition
 * @typedef {import('./types/scenario.types.js').ScenarioContext} ScenarioContext
 */

export class ScenarioEngine {
    /** @type {Map<string, { definition: ScenarioDefinition, context: ScenarioContext, controller: AbortController }>} */
    #runningScenarios = new Map();

    /**
     * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ –¥–≤–∏–∂–∫–µ.
     * @param {ScenarioDefinition} scenarioDefinition
     */
    registerScenario(scenarioDefinition) {
        // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è UI/–≤—ã–±–æ—Ä–∞
        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        logger.debug(`[ScenarioEngine] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π: ${scenarioDefinition.name}`, { module: 'ScenarioEngine' });
    }

    /**
     * –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π.
     * @param {ScenarioDefinition} scenarioDefinition
     * @param {Object} [params={}] - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
     * @param {number} [tabId] - ID –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
     * @returns {Promise<string>} ID –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
     */

    async run(scenarioDefinition, params = {}, tabId = null) {
        const instanceId = this.#generateId();
        const controller = new AbortController();
        console.log(`[ScenarioEngine] –ù–∞—á–∞–ª–æ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è ${scenarioDefinition.id}, tabId:`, tabId); // <-- –õ–æ–≥

        /** @type {ScenarioContext} */
        const context = {
            id: instanceId,
            tabId,
            params,
            log: (message, options = {}) => {
                logger.info(message, {
                    module: options.module || `Scenario:${scenarioDefinition.id}`,
                    contextId: instanceId,
                    ...options
                });
            },
            abortSignal: async () => {
                return new Promise((resolve, reject) => {
                    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –ª–∏ —Å–∏–≥–Ω–∞–ª —É–∂–µ
                    if (controller.signal.aborted) {
                        // –ï—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –û–¢–ö–õ–û–ù–Ø–ï–ú –ø—Ä–æ–º–∏—Å
                        reject(new Error('–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.'));
                        return;
                    }
                    // 2. –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –µ—â–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, —Å—Ç–∞–≤–∏–º —Å–ª—É—à–∞—Ç–µ–ª—å
                    controller.signal.addEventListener('abort', () => {
                        // –ö–æ–≥–¥–∞ controller.abort() –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω, –û–¢–ö–õ–ê–ù–ò–ú –ø—Ä–æ–º–∏—Å
                        reject(new Error('–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.'));
                    }, { once: true });

                    // 3. !!!–ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï!!!
                    // –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –µ—â–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ—Ç.
                    // –°–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ, abortSignal –¥–æ–ª–∂–µ–Ω –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ò–¢–¨–°–Ø.
                    // –ú—ã –Ω–µ –∂–¥–µ–º "—Ä–µ–∞–ª—å–Ω–æ–≥–æ" —Å–æ–±—ã—Ç–∏—è abort, –º—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–æ–±—â–∞–µ–º,
                    // —á—Ç–æ –Ω–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ—Ç.
                    resolve(); // <-- –£–°–ü–ï–®–ù–û –†–ê–ó–†–ï–®–ê–ï–ú –ø—Ä–æ–º–∏—Å
                });
            },
            // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø –≤ finally
            controller: controller
        };

        this.#runningScenarios.set(instanceId, { definition: scenarioDefinition, context, controller });

        // üëá –£–≤–µ–¥–æ–º–ª—è–µ–º popup –æ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({
                type: "scenarioStatus",
                status: "started",
                message: `[ScenarioEngine] –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioDefinition.name}" (ID: ${instanceId})`,
                level: "info"
            }).catch(err => {
                console.debug("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ popup:", err);
            });
        }

        context.log(`[ScenarioEngine] –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioDefinition.name}" (ID: ${instanceId})`, { module: 'ScenarioEngine' });

        try {
            await scenarioDefinition.execute(context);
            context.log(`[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.`, { module: 'ScenarioEngine' });
        } catch (error) {
            if (error.message === '–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.') {
                context.log(`[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.`, { module: 'ScenarioEngine', level: 'warn' });
            } else {
                context.log(`[ScenarioEngine] –û—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ "${scenarioDefinition.name}": ${error.message}`, { module: 'ScenarioEngine', level: 'error' });
                logger.error(`–û—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ "${scenarioDefinition.name}": ${error.stack}`, { module: 'ScenarioEngine', contextId: instanceId });
            }
        } finally {
            this.#runningScenarios.delete(instanceId);

            // üëá –£–≤–µ–¥–æ–º–ª—è–µ–º popup –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
            // –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ controller —á–µ—Ä–µ–∑ context
            const isAborted = context.controller.signal.aborted;
            const finalStatus = isAborted ? "stopped" : "finished";
            const finalMessage = isAborted ?
                `[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" (ID: ${instanceId}) –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.` :
                `[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" (ID: ${instanceId}) –∑–∞–≤–µ—Ä—à–µ–Ω.`;

            console.log(`[ScenarioEngine] –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ "${finalStatus}" –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ID: ${instanceId}`); // <-- –õ–æ–≥

            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({
                    type: "scenarioStatus",
                    status: finalStatus,
                    message: finalMessage,
                    level: "info"
                }).catch(err => {
                    console.debug("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ popup:", err);
                });
            }
            console.log(`[ScenarioEngine] –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å "${finalStatus}" –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ID: ${instanceId} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞).`); // <-- –õ–æ–≥
        }
        return instanceId;
    }

    /**
     * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
     * @param {string} instanceId
     * @returns {boolean} true, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
     */
    stop(instanceId) {
        const scenarioInstance = this.#runningScenarios.get(instanceId);
        if (scenarioInstance) {
            scenarioInstance.controller.abort();
            scenarioInstance.context.log(`[ScenarioEngine] –ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, { module: 'ScenarioEngine', level: 'warn' });
            return true;
        }
        logger.warn(`[ScenarioEngine] –ü–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π (ID: ${instanceId})`, { module: 'ScenarioEngine' });
        return false;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
     * @returns {Array<{id: string, name: string}>}
     */
    getRunningScenarios() {
        return Array.from(this.#runningScenarios.entries()).map(([id, { definition }]) => ({
            id,
            name: definition.name
        }));
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
     * @returns {string}
     */
    #generateId() {
        return `scenario_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
}



=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\scenario-engine.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\log.types.js ===

// core/types/log.types.js

/**
 * @typedef {Object} LogEntry
 * @property {string} id - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏.
 * @property {number} timestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ (–º—Å —Å 1970).
 * @property {string} level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞: 'debug', 'info', 'success', 'warn', 'error'.
 * @property {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
 * @property {string} [module] - –ú–æ–¥—É–ª—å –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —Å–æ–∑–¥–∞–≤—à–∏–π –∑–∞–ø–∏—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Parser', 'Selector').
 * @property {string} [contextId] - –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ID —Å–µ—Å—Å–∏–∏ –∞–Ω–∞–ª–∏–∑–∞).
 * @property {Object} [meta] - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */

/**
 * @typedef {Object} LoggerConfig
 * @property {number} [maxSize=1000] - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏/—Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
 * @property {boolean} [enableConsole=true] - –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –≤ console.
 * @property {string} [defaultLevel='info'] - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
 */

/**
 * @callback LogSubscriber
 * @param {LogEntry | { type: 'CLEAR_LOGS' }} entry - –ó–∞–ø–∏—Å—å –ª–æ–≥–∞ –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏.
 * @returns {void}
 */

/**
 * @typedef {Object} LogAdapter
 * @property {function(LogEntry): Promise<void>} write - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥.
 * @property {function(): Promise<LogEntry[]>} read - –ß–∏—Ç–∞–µ—Ç –≤—Å–µ –ª–æ–≥–∏.
 * @property {function(): Promise<void>} clear - –û—á–∏—â–∞–µ—Ç –ª–æ–≥–∏.
 */

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\log.types.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\scenario.types.js ===

// core/types/scenario.types.js

/**
 * @typedef {Object} ScenarioContext
 * @property {string} id - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {number} [tabId] - ID –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
 * @property {Object} [params] - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—é.
 * @property {function(string, Object): void} log - –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {function(): Promise<void>} abortSignal - –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É.
 */

/**
 * @typedef {Object} ScenarioDefinition
 * @property {string} id - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {string} name - –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {string} description - –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {function(ScenarioContext): Promise<void>} execute - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
 */

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\scenario.types.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\table.types.js ===

// core/types/table.types.js

/**
 * @typedef {Object} VideoData
 * @property {string} videoId - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∏–¥–µ–æ.
 * @property {string} title - –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ.
 * @property {string} channelName - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞.
 * @property {string} views - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, "1.2M").
 * @property {string} sourceVideoId - ID –≤–∏–¥–µ–æ, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥.
 * @property {string} thumbnailUrl - URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã.
 * @property {number} timestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
 * @property {boolean} [isImported] - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ –∑–∞–ø–∏—Å—å –±—ã–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞.
 */

/**
 * @typedef {Object} TableAdapter
 * @property {function(VideoData): Promise<void>} add - –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å.
 * @property {function(VideoData[]): Promise<void>} addBatch - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π.
 * @property {function(): Promise<VideoData[]>} getAll - –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏.
 * @property {function(): Promise<void>} clear - –û—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É.
 * @property {function(): Promise<number>} getCount - –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π.
 */

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\table.types.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\blacklist.js ===

// core/utils/blacklist.js

const BLACKLIST_STORAGE_KEY = 'unavailableVideoIds';

/**
 * –ü–æ–ª—É—á–∞–µ—Ç Set –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö videoId –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
 * @returns {Promise<Set<string>>} –ú–Ω–æ–∂–µ—Å—Ç–≤–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö ID.
 */
export async function getUnavailableVideoIds() {
    try {
        const result = await chrome.storage.local.get([BLACKLIST_STORAGE_KEY]);
        const idsArray = result[BLACKLIST_STORAGE_KEY] || [];
        return new Set(idsArray);
    } catch (e) {
        console.error("[Blacklist] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞:", e);
        return new Set(); // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π Set –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
    }
}

/**
 * –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ videoId –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫.
 * @param {string | string[]} videoIds - ID –≤–∏–¥–µ–æ –∏–ª–∏ –º–∞—Å—Å–∏–≤ ID.
 * @returns {Promise<void>}
 */
export async function addUnavailableVideoIds(videoIds) {
    const idsToAdd = Array.isArray(videoIds) ? videoIds : [videoIds];
    if (idsToAdd.length === 0) return;

    try {
        const currentSet = await getUnavailableVideoIds();
        let changed = false;

        idsToAdd.forEach(id => {
            if (id && !currentSet.has(id)) {
                currentSet.add(id);
                changed = true;
            }
        });

        if (changed) {
            const newArray = Array.from(currentSet);
            await chrome.storage.local.set({ [BLACKLIST_STORAGE_KEY]: newArray });
            console.log(`[Blacklist] –î–æ–±–∞–≤–ª–µ–Ω–æ ${idsToAdd.length} ID –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫. –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä: ${newArray.length}`);
        } else {
            console.log("[Blacklist] –ù–µ—Ç –Ω–æ–≤—ã—Ö ID –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫.");
        }
    } catch (e) {
        console.error("[Blacklist] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫:", e);
        throw e; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã—à–µ
    }
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π videoId –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ.
 * @param {string} videoId - ID –≤–∏–¥–µ–æ.
 * @returns {Promise<boolean>}
 */
export async function isVideoUnavailable(videoId) {
    if (!videoId) return false;
    const blacklistSet = await getUnavailableVideoIds();
    return blacklistSet.has(videoId);
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\blacklist.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\metrics.js ===

// core/utils/metrics.js

import { isLikelyRussian } from './video-selector.js';

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.
 * @param {Array<Object>} scrapedData - –î–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞).
 * @param {Map<string, number>} globalChannelCounts - –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å channelVideoCounts (–∏–∑ IndexManager).
 * @param {Function} log - –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
 * @returns {number} .newChannelCount - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤.
 * @returns {Set<string>} .newChannelNames - –ù–∞–∑–≤–∞–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (–¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞).
 */
export function calculateNewChannelsInIteration(scrapedData, globalChannelCounts, log) {

    if (!Array.isArray(scrapedData) || scrapedData.length === 0) {
        return { newChannelCount: 0, newChannelNames: new Set() };
    }

    // –ò–∑–≤–ª–µ–∫–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
    const channelsInIteration = new Set(
        scrapedData
            .map(item => item.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª')
            .filter(name => name !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª')
    );

    // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –∫–∞–Ω–∞–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–º –∏–Ω–¥–µ–∫—Å–µ
    const newChannels = new Set();
    for (const channelName of channelsInIteration) {
        const isAlreadyKnown = globalChannelCounts.has(channelName);
        if (!isAlreadyKnown) {
            newChannels.add(channelName);
        }
    }

    return {
        newChannelCount: newChannels.size,
        newChannelNames: newChannels
    };
}

/**
 * –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ —Å—Ä–µ–¥–∏ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –ù–û–í–´–• –∫–∞–Ω–∞–ª–æ–≤,
 * –∏—Å–ø–æ–ª—å–∑—É—è –¢–û–õ–¨–ö–û –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (scrapedData).
 * –ö–∞–Ω–∞–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä—É—Å—Å–∫–∏–º, –µ—Å–ª–∏ –±–æ–ª–µ–µ 50% –µ–≥–æ –≤–∏–¥–µ–æ (–∏–∑ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏) –∏–º–µ—é—Ç —Ä—É—Å—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è.
 * @param {Set<string>} newChannelNames - –ù–∞–∑–≤–∞–Ω–∏—è –ù–û–í–´–• –∫–∞–Ω–∞–ª–æ–≤ (—Ä–µ–∑—É–ª—å—Ç–∞—Ç calculateNewChannelsInIteration).
 * @param {Array<Object>} scrapedData - –î–∞–Ω–Ω—ã–µ, –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ (–∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞).
 * @param {Function} log - –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏.
 */
export function calculateRussianChannelRatio(newChannelNames, scrapedData, log) {

    if (newChannelNames.size === 0) {
        // log(`üá∑üá∫ –ù–µ—Ç –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.`, { module: 'Metrics' });
        return { russianChannelCount: 0, totalChannels: 0, ratio: 0, russianChannelList: [] };
    }

    // üëá –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤–∏–¥–µ–æ –∏–∑ scrapedData –ø–æ –∫–∞–Ω–∞–ª–∞–º
    const channelVideosMap = new Map();
    for (const video of scrapedData) {
        const channelName = video.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
        if (!channelVideosMap.has(channelName)) {
            channelVideosMap.set(channelName, []);
        }
        channelVideosMap.get(channelName).push(video);
    }

    let russianCount = 0;
    const russianChannelList = [];

    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ù–û–í–´–ô –∫–∞–Ω–∞–ª
    for (const channelName of newChannelNames) {
        // log(`üá∑üá∫ --- üì∫ –ê–Ω–∞–ª–∏–∑ –ù–û–í–û–ì–û –∫–∞–Ω–∞–ª–∞: "${channelName}" ---`, { module: 'Metrics' });

        const videosInChannel = channelVideosMap.get(channelName) || [];
        if (videosInChannel.length === 0) {
            // log(`üá∑üá∫   ‚ùå –î–ª—è –∫–∞–Ω–∞–ª–∞ "${channelName}" –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∏–¥–µ–æ –≤ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.`, { module: 'Metrics', level: 'warn' });
            continue;
        }

        // log(`üá∑üá∫   ‚úÖ –ù–∞–π–¥–µ–Ω–æ ${videosInChannel.length} –≤–∏–¥–µ–æ –¥–ª—è –∫–∞–Ω–∞–ª–∞ "${channelName}" –≤ —Ç–µ–∫—É—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.`, { module: 'Metrics' });

        let russianVideoCount = 0;
        let totalVideoCount = 0;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥–æ–µ –≤–∏–¥–µ–æ –∫–∞–Ω–∞–ª–∞
        for (const video of videosInChannel) {
            if (video.title) {
                totalVideoCount++;
                const isRussian = isLikelyRussian(video.title);
                if (isRussian) {
                    russianVideoCount++;
                }
                // log(`üá∑üá∫     üé¨ –í–∏–¥–µ–æ ID: ${video.videoId} | –ù–∞–∑–≤–∞–Ω–∏–µ: "${video.title.substring(0, 40)}${video.title.length > 40 ? '...' : ''}" | –†—É—Å—Å–∫–æ–µ: ${isRussian ? '‚úÖ' : '‚ùå'}`, { module: 'Metrics' });
            }
        }

        // –ö–∞–Ω–∞–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä—É—Å—Å–∫–∏–º, –µ—Å–ª–∏ >50% –µ–≥–æ –≤–∏–¥–µ–æ ‚Äî —Ä—É—Å—Å–∫–∏–µ
        const russianRatio = totalVideoCount > 0 ? (russianVideoCount / totalVideoCount) * 100 : 0;
        const isChannelRussian = totalVideoCount > 0 && russianRatio > 50;

        // log(`üá∑üá∫   üìä –í—Å–µ–≥–æ –≤–∏–¥–µ–æ —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏: ${totalVideoCount}`, { module: 'Metrics' });
        // log(`üá∑üá∫   üìä –†—É—Å—Å–∫–∏—Ö –≤–∏–¥–µ–æ: ${russianVideoCount}`, { module: 'Metrics' });
        // log(`üá∑üá∫   üìä –ü—Ä–æ—Ü–µ–Ω—Ç —Ä—É—Å—Å–∫–∏—Ö –≤–∏–¥–µ–æ: ${russianRatio.toFixed(2)}%`, { module: 'Metrics' });
        // log(`üá∑üá∫   ${isChannelRussian ? '‚úÖ –ö–∞–Ω–∞–ª —Å—á–∏—Ç–∞–µ—Ç—Å—è –†–£–°–°–ö–ò–ú (–ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ—Ä–æ–≥ > 50%)' : '‚ùå –ö–∞–Ω–∞–ª –ù–ï —Å—á–∏—Ç–∞–µ—Ç—Å—è —Ä—É—Å—Å–∫–∏–º (–Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ—Ä–æ–≥ > 50%)'}`, { module: 'Metrics', level: isChannelRussian ? 'success' : 'info' });

        if (isChannelRussian) {
            russianCount++;
            russianChannelList.push(channelName);
        }
    }

    const totalChannels = newChannelNames.size;
    const ratio = totalChannels > 0 ? (russianCount / totalChannels) * 100 : 0;

    // log(`üá∑üá∫ === üèÅ –ò–¢–û–ì –ê–ù–ê–õ–ò–ó–ê ===`, { module: 'Metrics' });
    // log(`üá∑üá∫ –í—Å–µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤: ${totalChannels}`, { module: 'Metrics' });
    // log(`üá∑üá∫ –†—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: ${russianCount}`, { module: 'Metrics', level: 'success' });
    // log(`üá∑üá∫ –ü—Ä–æ—Ü–µ–Ω—Ç —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: ${ratio.toFixed(2)}%`, { module: 'Metrics', level: 'success' });

    return {
        russianChannelCount: russianCount,
        totalChannels: totalChannels,
        ratio: parseFloat(ratio.toFixed(2)),
        russianChannelList: russianChannelList
    };
}

/** @type {number[]} */
const last10RussianChannelCounts = [];

/**
 * –û–±–Ω–æ–≤–ª—è–µ—Ç –º–µ—Ç—Ä–∏–∫—É —Å—Ä–µ–¥–Ω–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–æ–≤—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∏—Ç–µ—Ä–∞—Ü–∏–π.
 * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ü–µ –∫–∞–∂–¥–æ–π —É—Å–ø–µ—à–Ω–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞.
 * @param {number} russianChannelCount - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤, –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –≤ –¢–ï–ö–£–©–ï–ô –∏—Ç–µ—Ä–∞—Ü–∏–∏.
 * @param {Function} log - –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 */
export function updateRussianChannelMetric(russianChannelCount, log) {
    // 1. –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –º–∞—Å—Å–∏–≤
    last10RussianChannelCounts.push(russianChannelCount);
    // 2. –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–æ–ª—å—à–µ 10, —É–¥–∞–ª—è–µ–º —Å–∞–º—ã–π —Å—Ç–∞—Ä—ã–π (–ø–µ—Ä–≤—ã–π)
    if (last10RussianChannelCounts.length > 10) {
        last10RussianChannelCounts.shift();
    }
    // 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    const sum = last10RussianChannelCounts.reduce((acc, val) => acc + val, 0);
    const average = last10RussianChannelCounts.length > 0 ? sum / last10RussianChannelCounts.length : 0;
    const roundedAverage = parseFloat(average.toFixed(2));
    // 4. –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ
    let level = 'info';
    let message = '';
    if (roundedAverage > 7) {
        level = 'success';
        message = `‚úÖ –û—Ç–ª–∏—á–Ω–æ! –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: ${roundedAverage}`;
    } else if (roundedAverage >= 5) {
        level = 'warn';
        message = `‚ö†Ô∏è –û–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ: –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: ${roundedAverage}`;
    } else {
        level = 'error';
        message = `‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –°—Ä–µ–¥–Ω–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–≤—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: ${roundedAverage}`;
    }
    // 5. –õ–æ–≥–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    log(message, { module: 'Metrics', level: level });
    // 6. (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –õ–æ–≥–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    // log(`üìä –ò—Å—Ç–æ—Ä–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π: [${last10RussianChannelCounts.join(', ')}]`, { module: 'Metrics', level: 'debug' });
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\metrics.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\navigator.js ===

// core/utils/navigator.js

/**
 * –ü–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É YouTube –≤–∏–¥–µ–æ –ø–æ –µ–≥–æ ID.
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è (–¥–ª—è tabId –∏ –ª–æ–≥–æ–≤).
 * @param {string} videoId - ID –≤–∏–¥–µ–æ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–π—Ç–∏.
 * @returns {Promise<void>}
 */
export async function navigateToVideo(context, videoId) {
    const { log, tabId } = context;

    if (typeof tabId !== 'number' || tabId < 0) {
        const errorMsg = `–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π tabId –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: ${tabId}`;
        log(`‚ùå ${errorMsg}`, { module: 'Navigator', level: 'error' });
        throw new Error(errorMsg);
    }

    if (!videoId || typeof videoId !== 'string') {
        const errorMsg = `–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π videoId –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞: ${videoId}`;
        log(`‚ùå ${errorMsg}`, { module: 'Navigator', level: 'error' });
        throw new Error(errorMsg);
    }

    const targetUrl = `https://www.youtube.com/watch?v=${encodeURIComponent(videoId)}`;
    log(`üß≠ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ URL: ${targetUrl}`, { module: 'Navigator' });

    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ content script –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
        const response = await chrome.tabs.sendMessage(tabId, {
            action: "navigateToVideo",
            url: targetUrl,
            videoId: videoId // –ü–µ—Ä–µ–¥–∞–µ–º ID –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ content script
        });

        if (response && response.status === "success") {
            log(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.`, { module: 'Navigator' });
        } else {
            const errorMsg = response?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞";
            log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞: ${errorMsg}`, { module: 'Navigator', level: 'error' });
            throw new Error(errorMsg);
        }
    } catch (err) {
        log(`‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ: ${err.message}`, { module: 'Navigator', level: 'error' });
        throw err; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã—à–µ
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\navigator.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\parser.js ===

// core/utils/parser.js

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ content script –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏ –≤–∏–¥–µ–æ.
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è (–¥–ª—è tabId –∏ –ª–æ–≥–æ–≤).
 * @returns {Promise<{status: string, highlightedCards?: HTMLElement[], highlightedCount?: number, message?: string}>}
 * –í–ê–ñ–ù–û: DOM-—ç–ª–µ–º–µ–Ω—Ç—ã –Ω–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å —á–µ—Ä–µ–∑ sendMessage, –æ–Ω–∏ —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è –ø—É—Å—Ç—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏ {}.
 * –ü–æ—ç—Ç–æ–º—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–∞–º–∏—Ö –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (scraping).
 */
export async function parseAndHighlight(context) {
    const { log, tabId } = context;
    // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ sourceVideoId –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ context
    // –≠—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å ID —Ç–µ–∫—É—â–µ–π –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –º—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤–∏–¥–µ–æ, –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ.
    // –î–ª—è MVP –≤–æ–∑—å–º–µ–º –µ–≥–æ –∏–∑ URL –≤–∫–ª–∞–¥–∫–∏ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É.
    let sourceVideoId = 'unknown_source';
    try {
        if (typeof tabId === 'number' && tabId > 0) {
            const tab = await chrome.tabs.get(tabId);
            const url = new URL(tab.url);
            sourceVideoId = url.searchParams.get('v') || 'unknown_source_from_url';
        }
    } catch (getUrlErr) {
        console.warn("[Core Parser] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å sourceVideoId –∏–∑ URL –≤–∫–ª–∞–¥–∫–∏:", getUrlErr);
        sourceVideoId = 'unknown_source';
    }

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º sourceVideoId, –µ—Å–ª–∏ –æ–Ω –ø–µ—Ä–µ–¥–∞–Ω —è–≤–Ω–æ –≤ params (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ —Å—Ü–µ–Ω–∞—Ä–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
    if (context.params && context.params.sourceVideoId) {
        sourceVideoId = context.params.sourceVideoId;
    }

    if (typeof tabId !== 'number' || tabId < 0) {
        const errorMsg = `–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π tabId –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞: ${tabId}`;
        log(`‚ùå ${errorMsg}`, { module: 'Parser', level: 'error' });
        throw new Error(errorMsg);
    }

    log(`üîç –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–∞—Ä—Å–∏–Ω–≥, –ø–æ–¥—Å–≤–µ—Ç–∫—É –∏ —Å–∫—Ä–∞–ø–∏–Ω–≥ –≤–∏–¥–µ–æ (–∏—Å—Ç–æ—á–Ω–∏–∫: ${sourceVideoId})...`, { module: 'Parser' });

    try {
        const response = await chrome.tabs.sendMessage(tabId, {
            action: "parseAndHighlight",
            sourceVideoId: sourceVideoId // –ü–µ—Ä–µ–¥–∞–µ–º sourceVideoId –≤ content script
        });

        if (response && response.status === "success") {
            const count = response.highlightedCount;
            const data = response.scrapedData || [];
            log(`‚úÖ –ü–∞—Ä—Å–∏–Ω–≥, –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∏ —Å–∫—Ä–∞–ø–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –ù–∞–π–¥–µ–Ω–æ/–ø–æ–¥—Å–≤–µ—á–µ–Ω–æ –≤–∏–¥–µ–æ: ${count}, –∏–∑–≤–ª–µ—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö: ${data.length}`, { module: 'Parser' });

            // –í—ã–≤–æ–¥–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å background –ø–µ—Ä–≤—ã–µ N –∑–∞–ø–∏—Å–µ–π –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            const itemsToShow = Math.min(3, data.length);
            if (itemsToShow > 0) {
                console.group(`[Core Parser] –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã—Ö ${itemsToShow} –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫:`);
                for (let i = 0; i < itemsToShow; i++) {
                    const item = data[i];
                    console.log(
                        `–ö–∞—Ä—Ç–æ—á–∫–∞ ${i + 1}:`,
                        `ID: ${item.videoId || 'N/A'}`,
                        `–ù–∞–∑–≤–∞–Ω–∏–µ: "${(item.title || 'N/A').substring(0, 50)}${(item.title || '').length > 50 ? '...' : ''}"`,
                        `–ö–∞–Ω–∞–ª: "${(item.channelName || 'N/A').substring(0, 30)}${(item.channelName || '').length > 30 ? '...' : ''}"`
                    );
                }
                console.groupEnd();
            }

            return response; // { status: "success", highlightedCount: number, scrapedData: Array }
        } else {
            const errorMsg = response?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞/–ø–æ–¥—Å–≤–µ—Ç–∫–∏/—Å–∫—Ä–∞–ø–∏–Ω–≥–∞";
            log(`‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞/–ø–æ–¥—Å–≤–µ—Ç–∫–∏/—Å–∫—Ä–∞–ø–∏–Ω–≥–∞: ${errorMsg}`, { module: 'Parser', level: 'error' });
            throw new Error(errorMsg);
        }
    } catch (err) {
        log(`‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ/–ø–æ–¥—Å–≤–µ—Ç–∫–µ/—Å–∫—Ä–∞–ø–∏–Ω–≥–µ: ${err.message}`, { module: 'Parser', level: 'error' });
        throw err; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—ã—à–µ
    }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ content script –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏.
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è (–¥–ª—è tabId –∏ –ª–æ–≥–æ–≤).
 * @returns {Promise<void>}
 */
export async function removeParserHighlights(context) {
    const { log, tabId } = context;

    if (typeof tabId !== 'number' || tabId < 0) {
        // –ù–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
        console.warn("[Core Parser] –ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π tabId –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏:", tabId);
        return;
    }

    log(`üßπ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥—Å–≤–µ—Ç–∫–∏...`, { module: 'Parser' });

    try {
        const response = await chrome.tabs.sendMessage(tabId, {
            action: "removeParserHighlights"
        });

        if (response && response.status === "success") {
            log(`‚úÖ –ü–æ–¥—Å–≤–µ—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞.`, { module: 'Parser' });
        } else {
            const errorMsg = response?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏";
            log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏: ${errorMsg}`, { module: 'Parser', level: 'warn' });
            // –ù–µ –±—Ä–æ—Å–∞–µ–º –æ—à–∏–±–∫—É, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è
        }
    } catch (err) {
        // –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ –∑–∞–∫—Ä—ã—Ç–∞
        log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∏: ${err.message}`, { module: 'Parser', level: 'warn' });
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\parser.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\scroller.js ===

// core/utils/scroller.js

/**
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç N —à–∞–≥–æ–≤ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.
 * @param {number} [count=16] - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–∫—Ä–æ–ª–ª–∏—Ç—å.
 * @param {number} [delayMs=1500] - –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∫—Ä–æ–ª–ª–∞–º–∏ (–º—Å).
 * @param {number} [step=1000] - –ù–∞ —Å–∫–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–µ–π —Å–∫—Ä–æ–ª–ª–∏—Ç—å –∑–∞ —Ä–∞–∑.
 * @returns {Promise<void>}
 */
export async function scrollPageNTimes(context, count = 16, delayMs = 1500, step = 1000) {
    const { log, abortSignal } = context;
    let tabId = context.tabId;
    console.log("[Scroller] scrollPageNTimes –≤—ã–∑–≤–∞–Ω–∞ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:", { count, delayMs, step, tabId: context.tabId }); // <-- –õ–æ–≥
    log(`üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${count} —Ä–∞–∑(–∞), —à–∞–≥ ${step}px, –∑–∞–¥–µ—Ä–∂–∫–∞ ${delayMs}–º—Å`, { module: 'Scroller' });

    try {

        // --- –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê tabId ---
        // 1. –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –ø–µ—Ä–µ–¥–∞–Ω –ª–∏ tabId –≤ context
        let effectiveTabId = tabId;

        // 2. –ï—Å–ª–∏ tabId –≤—Å–µ –µ—â–µ null/undefined, –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
        // (–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏, –µ—Å–ª–∏ background.js –Ω–µ —Å–º–æ–≥ –µ–≥–æ –ø–æ–ª—É—á–∏—Ç—å)
        if (effectiveTabId == null) { // == –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏ null, –∏ undefined
            const errorMsg = `–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π tabId –¥–ª—è sendMessage: ${effectiveTabId}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ YouTube.`;
            log(`‚ùå ${errorMsg}`, { module: 'Scroller', level: 'error' });
            throw new Error(errorMsg); // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞
        }

        // 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ (–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–µ–¥–æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å)
        if (typeof effectiveTabId !== 'number' || effectiveTabId < 0) {
            const errorMsg = `–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π —Ç–∏–ø –∏–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ tabId –¥–ª—è sendMessage: ${effectiveTabId} (—Ç–∏–ø: ${typeof effectiveTabId}). –û–∂–∏–¥–∞–ª–æ—Å—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ.`;
            log(`‚ùå ${errorMsg}`, { module: 'Scroller', level: 'error' });
            throw new Error(errorMsg);
        }
        // --- –ö–û–ù–ï–¶ –£–õ–£–ß–®–ï–ù–ù–û–ô –ü–†–û–í–ï–†–ö–ò tabId ---
        console.log("–ü—Ä–æ–≤–µ—Ä–∫–∞ tabId –ø—Ä–æ–π–¥–µ–Ω–∞", effectiveTabId);
        for (let i = 1; i <= count; i++) {
            console.log("// 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É/–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ");
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É/–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ
            await abortSignal();

            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ content script –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –û–î–ù–û–ì–û —Å–∫—Ä–æ–ª–ª–∞
            log(`‚è≥ –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª ${i}/${count}...`, { module: 'Scroller' });

            // --- –ü–û–ü–´–¢–ö–ê –° –ë–õ–û–ö–û–ú try/catch –î–õ–Ø sendMessage ---
            let response;
            try {
                response = await chrome.tabs.sendMessage(
                    context.tabId,
                    {
                        action: "performSingleScroll",
                        step: step
                    }
                );
            } catch (sendMsgErr) {
                log(`‚ùå –û—à–∏–±–∫–∞ sendMessage –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ ${i}/${count}: ${sendMsgErr.message}`, { module: 'Scroller', level: 'error' });
                throw new Error(`–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π YouTube: ${sendMsgErr.message}`);
            }
            // --- –ö–û–ù–ï–¶ –ü–û–ü–´–¢–ö–ò ---

            if (response && response.status === "success") {
                log(`‚úÖ –°–∫—Ä–æ–ª–ª ${i}/${count} –≤—ã–ø–æ–ª–Ω–µ–Ω.`, { module: 'Scroller' });
            } else {
                const errorMsg = response?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞";
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ ${i}/${count}: ${errorMsg}`, { module: 'Scroller', level: 'error' });
                throw new Error(errorMsg);
            }

            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
            await abortSignal();

            // 4. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∫—Ä–æ–ª–ª, –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É
            if (i < count) {
                log(`‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ ${delayMs}–º—Å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–∫—Ä–æ–ª–ª–æ–º (${i + 1}/${count})...`, { module: 'Scroller' });

                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–∏—Å –¥–ª—è –∑–∞–¥–µ—Ä–∂–∫–∏
                const delayPromise = new Promise(resolve => setTimeout(resolve, delayMs));

                try {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise.race –º–µ–∂–¥—É –∑–∞–¥–µ—Ä–∂–∫–æ–π –∏ —Å–∏–≥–Ω–∞–ª–æ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.
                    // context.abortSignal() –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–º–∏—Å, –∫–æ—Ç–æ—Ä—ã–π:
                    // - –†–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ, –µ—Å–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ—Ç (–≠–¢–û –ù–ï–í–ï–†–ù–û –î–õ–Ø RACE!)
                    // - –û—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è —Å –æ—à–∏–±–∫–æ–π, –µ—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.
                    //
                    // –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ª–æ–≥–∏–∫–∞: –º—ã —Ö–æ—Ç–∏–º –∂–¥–∞—Ç—å –∑–∞–¥–µ—Ä–∂–∫—É, –ù–û –ø—Ä–µ—Ä–≤–∞—Ç—å—Å—è, –µ—Å–ª–∏ –ø–æ—Å—Ç—É–ø–∏–ª —Å–∏–≥–Ω–∞–ª.
                    // –ó–Ω–∞—á–∏—Ç, abortSignal –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø—Ä–æ–º–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –ñ–î–ï–¢ —Å–∏–≥–Ω–∞–ª–∞ (–Ω–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è —Å–∞–º).
                    // –ù–æ –Ω–∞—à–∞ —Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è resolve() –µ–≥–æ. –≠—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞.
                    //
                    // –ü–ï–†–ï–î–ï–õ–ê–ï–ú –õ–û–ì–ò–ö–£:
                    // 1. –°–æ–∑–¥–∞–¥–∏–º –æ—Ç–¥–µ–ª—å–Ω—ã–π AbortController –¥–ª—è —ç—Ç–æ–π –ø–∞—É–∑—ã.
                    // 2. –ë—É–¥–µ–º –∂–¥–∞—Ç—å –ª–∏–±–æ —Ç–∞–π–º–∞—É—Ç, –ª–∏–±–æ —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞–ø—Ä—è–º—É—é.

                    // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Ç–æ–π –ø–∞—É–∑–æ–π
                    const pauseController = new AbortController();
                    const abortPromise = new Promise((_, reject) => {
                        // –°–ª—É—à–∞–µ–º —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è
                        context.controller.signal.addEventListener('abort', () => {
                            reject(new Error('–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.'));
                        }, { once: true, signal: pauseController.signal }); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –Ω–∞—à–µ–º—É pauseController, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç–º–µ–Ω–∏—Ç—å —Å–ª—É—à–∞—Ç–µ–ª—å
                    });

                    // –ì–æ–Ω–∫–∞ –º–µ–∂–¥—É —Ç–∞–π–º–∞—É—Ç–æ–º –∏ —Å–∏–≥–Ω–∞–ª–æ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    await Promise.race([
                        new Promise(resolve => setTimeout(resolve, delayMs)), // –¢–∞–π–º–∞—É—Ç
                        abortPromise // –°–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    ]);

                    // –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —ç—Ç–æ–π —Ç–æ—á–∫–∏, –∑–Ω–∞—á–∏—Ç –ª–∏–±–æ –ø—Ä–æ—à–ª–æ –≤—Ä–µ–º—è, –ª–∏–±–æ —Å—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É —É–∂–µ –≤–∫–ª—é—á–µ–Ω–∞ –≤ abortPromise.

                } catch (err) {
                    // –ï—Å–ª–∏ –ø—Ä–µ—Ä–≤–∞–Ω–æ –ø–æ —Å–∏–≥–Ω–∞–ª—É
                    log(`‚èπÔ∏è –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (${i + 1}/${count}).`, { module: 'Scroller', level: 'warn' });
                    throw err; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
                }
                // –ï—Å–ª–∏ –Ω–µ –±—ã–ª–æ –∏—Å–∫–ª—é—á–µ–Ω–∏—è, —Ü–∏–∫–ª –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—Å—è
            }
        }

        // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Å–∫—Ä–æ–ª–ª–æ–≤ –º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫
        try {
            const countResponse = await chrome.tabs.sendMessage(context.tabId, {
                action: "getEstimatedCardCount"
            });
            const cardCount = countResponse?.cardCount || 0;
            log(`‚úÖ –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ ${cardCount} –∫–∞—Ä—Ç–æ—á–µ–∫.`, { module: 'Scroller' });
        } catch (countErr) {
            console.warn("[Core Scroller] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞:", countErr);
            log(`‚úÖ –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω.`, { module: 'Scroller' });
        }

    } catch (err) {
        console.error("[Scroller] –ü–æ–π–º–∞–Ω–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –≤ scrollPageNTimes:", err); // <-- –õ–æ–≥ –æ—à–∏–±–æ–∫

        if (err.message === '–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.') {
            log(`‚èπÔ∏è –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.`, { module: 'Scroller', level: 'warn' });
        } else {
            log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞: ${err.message}`, { module: 'Scroller', level: 'error' });
        }
        throw err; // –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\scroller.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\video-selector.js ===

// core/utils/video-selector.js

import { getUnavailableVideoIds } from './blacklist.js';

/**
 * @typedef {Object} VideoData
 * @property {string} videoId - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∏–¥–µ–æ.
 * @property {string} title - –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ.
 * @property {string} channelName - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞.
 * @property {string} sourceVideoId - ID –≤–∏–¥–µ–æ, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥.
 * @property {string} views - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
 * @property {string} thumbnailUrl - URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã.
 * ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
 */

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç, –≤–µ—Ä–æ—è—Ç–Ω–æ, —Ä–£–°–°–ö–û—è–∑—ã—á–Ω—ã–º (–∞ –Ω–µ –ø—Ä–æ—Å—Ç–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º).
 * –û—Ç—Å–µ–∏–≤–∞–µ—Ç —É–∫—Ä–∞–∏–Ω—Å–∫–∏–µ, –±–µ–ª–æ—Ä—É—Å—Å–∫–∏–µ –∏ –¥—Ä—É–≥–∏–µ –Ω–µ-—Ä—É—Å—Å–∫–∏–µ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ —Ç–µ–∫—Å—Ç—ã –ø–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω—ã–º —Å–∏–º–≤–æ–ª–∞–º.
 * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.
 * @returns {boolean} true, –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–∏—Ä–∏–ª–ª–∏—Ü—É –∏ –ù–ï —Å–æ–¥–µ—Ä–∂–∏—Ç –º–∞—Ä–∫–µ—Ä–æ–≤ –¥—Ä—É–≥–∏—Ö —è–∑—ã–∫–æ–≤, –∏–Ω–∞—á–µ false.
 */
export function isLikelyRussian(text) {
    if (!text || typeof text !== 'string') return false;

    // --- 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –õ–Æ–ë–û–ô –∫–∏—Ä–∏–ª–ª–∏—Ü—ã ---
    // –ï—Å–ª–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –≤–æ–æ–±—â–µ –Ω–µ—Ç ‚Äî —Ç–æ—á–Ω–æ –Ω–µ —Ä—É—Å—Å–∫–∏–π
    const hasCyrillic = /[\u0400-\u04FF\u0500-\u052F]/.test(text);
    if (!hasCyrillic) {
        return false;
    }

    // --- 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–∞—Ä–∫–µ—Ä–æ–≤ –ù–ï-–†–£–°–°–ö–û–ì–û —è–∑—ã–∫–∞ ---
    // –£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Ä—É—Å—Å–∫–æ–º –∞–ª—Ñ–∞–≤–∏—Ç–µ
    const ukrainianMarkers = /[—ñ—ó—î“ë–Ü–á–Ñ“ê]/;
    // –ë–µ–ª–æ—Ä—É—Å—Å–∫–∞—è "—û"
    const belarusianMarkers = /[—û–é]/;
    // –°–µ—Ä–±—Å–∫–∞—è "—í", "—õ", "—ü" –∏ —Ç.–¥. (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    const serbianMarkers = /[—í—õ—ü–Ç–ã–è]/;

    // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –º–∞—Ä–∫–µ—Ä—ã –≤ –æ–¥–∏–Ω —Ä–µ–≥—ç–∫—Å–ø
    const nonRussianMarkers = new RegExp(`[${ukrainianMarkers.source}${belarusianMarkers.source}${serbianMarkers.source}]`);

    // –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –º–∞—Ä–∫–µ—Ä ‚Äî —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ —ç—Ç–æ –ù–ï —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç
    if (nonRussianMarkers.test(text)) {
        return false;
    }

    // --- 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –Ω–∞–ª–∏—á–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ–π —É–∫—Ä–∞–∏–Ω—Å–∫–æ–π "i" (–ª–∞—Ç–∏–Ω—Å–∫–∞—è) ---
    // –£–∫—Ä–∞–∏–Ω—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –ª–∞—Ç–∏–Ω—Å–∫—É—é "i" –≤–º–µ—Å—Ç–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–æ–π "—ñ" –∏–ª–∏ —Ä—É—Å—Å–∫–æ–π "–∏"
    // –≠—Ç–æ —Å–∏–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä.
    if (text.includes('i') || text.includes('I')) {
        return false;
    }

    // --- 4. –ï—Å–ª–∏ –¥–æ—à–ª–∏ –¥–æ —Å—é–¥–∞: –∫–∏—Ä–∏–ª–ª–∏—Ü–∞ –µ—Å—Ç—å, –∞ –∑–∞–ø—Ä–µ—â—ë–Ω–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ –Ω–µ—Ç ‚Äî —Å—á–∏—Ç–∞–µ–º —Ä—É—Å—Å–∫–∏–º ---
    return true;
}

/**
 * –ù–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å—Ç—Ä–æ–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ –≤ —á–∏—Å–ª–æ.
 * –ê–¥–∞–ø—Ç–∞—Ü–∏—è Python-—Ñ—É–Ω–∫—Ü–∏–∏ parse_views_robust.
 * @param {string} viewStr - –°—Ç—Ä–æ–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "1.2M", "195 —Ç—ã—Å. –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤").
 * @returns {number} –ß–∏—Å–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤. 0, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å.
 */
function parseViewsRobust(viewStr) {
    // console.log(viewStr);
    if (!viewStr || typeof viewStr !== 'string') {
        return 0;
    }
    viewStr = viewStr.trim();
    // –°–ª—É—á–∞–π: URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
    if (viewStr.startsWith('http') || viewStr.includes('ytimg.com')) {
        return 0;
    }
    // –°–ª—É—á–∞–π: "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ", "No", "‚Äî", "‚Äî" –∏ –ø–æ–¥–æ–±–Ω–æ–µ
    const unknownValues = ['–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ', 'no', '-', '‚Äî', '', 'unknown'];
    if (unknownValues.includes(viewStr.toLowerCase())) {
        return 0;
    }
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—É—Ñ—Ñ–∏–∫—Å–æ–≤
    const patterns = [
        // –†—É—Å—Å–∫–∏–π: –º–ª—Ä–¥ (–±–µ–∑ —Å–ª–æ–≤–∞ "–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤")
        { regex: /([\d\s\u00A0,\.]+)[\s\u00A0]*–º–ª—Ä–¥\.?/i, multiplier: 1_000_000_000 },
        // –†—É—Å—Å–∫–∏–π: –º–ª–Ω (–±–µ–∑ —Å–ª–æ–≤–∞ "–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤")
        { regex: /([\d\s\u00A0,\.]+)[\s\u00A0]*–º–ª–Ω\.?/i, multiplier: 1_000_000 },
        // –†—É—Å—Å–∫–∏–π: —Ç—ã—Å. (–±–µ–∑ —Å–ª–æ–≤–∞ "–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤")
        { regex: /([\d\s\u00A0,\.]+)[\s\u00A0]*—Ç—ã—Å\.?/i, multiplier: 1_000 },
        // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: B (billion)
        { regex: /([\d\s\u00A0,\.]+)[\s\u00A0]*[Bb]/i, multiplier: 1_000_000_000 },
        // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: M (million)
        { regex: /([\d\s\u00A0,\.]+)[\s\u00A0]*[Mm]/i, multiplier: 1_000_000 },
        // –ê–Ω–≥–ª–∏–π—Å–∫–∏–π: K (thousand)
        { regex: /([\d\s\u00A0,\.]+)[\s\u00A0]*[Kk]/i, multiplier: 1_000 },
    ];
    for (const { regex, multiplier } of patterns) {
        const match = viewStr.match(regex);
        if (match) {
            let numStr = match[1].replace(/\s/g, '').replace(',', '.');
            try {
                // üëá –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º parseFloat –∏ —É–º–Ω–æ–∂–∞–µ–º, –∑–∞—Ç–µ–º Math.floor
                const num = parseFloat(numStr);
                if (isNaN(num)) {
                    continue;
                }
                // console.log("–°—Ä–∞–±–æ—Ç–∞–ª–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω–∞ ", num * multiplier);
                return Math.floor(num * multiplier);
            } catch (e) {
                continue; // –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å ‚Äî –ø—Ä–æ–±—É–µ–º –¥–∞–ª—å—à–µ
            }
        }
    }
    // –°–ª—É—á–∞–π: –ø—Ä–æ—Å—Ç–æ —á–∏—Å–ª–æ (–≤–æ–∑–º–æ–∂–Ω–æ, —Å "–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤" –∏–ª–∏ –±–µ–∑)
    const digitsOnly = viewStr.replace(/[^\d]/g, '');
    if (digitsOnly) {
        try {
            // console.log("–ü–∞—Ç—Ç–µ—Ä–Ω –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª ", parseInt(digitsOnly, 10));
            return parseInt(digitsOnly, 10);
        } catch (e) {
            // pass
        }
    }
    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º 0
    return 0;
}

/**
 * –í—ã–±–∏—Ä–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ –∞–ª–≥–æ—Ä–∏—Ç–º—É "–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ –Ω–∞ –∫–∞–Ω–∞–ª".
 *
 * @param {Object} dependencies - –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Ñ—É–Ω–∫—Ü–∏–∏.
 * @param {Set<string>} dependencies.visitedSourceVideoIds - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –º—ã —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª–∏ (sourceVideoId).
 * @param {Map<string, number>} dependencies.channelVideoCounts - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞.
 * @param {Map<string, Set<string>>} dependencies.channelToVideoIds - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞.
 * @param {string} currentVideoId - ID —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ (–Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º—ã —Å–µ–π—á–∞—Å –Ω–∞—Ö–æ–¥–∏–º—Å—è –∏ –∫–æ—Ç–æ—Ä–æ–µ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–ø–∞—Ä—Å–∏–ª–∏).
 * @param {'current_recommendations' | 'all_videos'} mode - –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞.
 * @param {Array<VideoData>} scrapedData - –ú–∞—Å—Å–∏–≤ –≤–∏–¥–µ–æ, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –Ω–∞ —Ç–µ–∫—É—â–µ–º —à–∞–≥–µ (–¥–ª—è 'current_recommendations').
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @param {Function} context.log - –§—É–Ω–∫—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @returns {Promise<string|null>} ID —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ (videoId) –∏–ª–∏ null, –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å.
 */
export async function selectNextVideo(
    { visitedSourceVideoIds, channelVideoCounts, channelToVideoIds },
    currentVideoId,
    mode,
    scrapedData = [],
    context
) {
    const { log } = context;

    log(`üîç –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–±–æ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ. –ó–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º: ${mode}, –¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ ID: ${currentVideoId}`, { module: 'VideoSelector' });
    log(`üë£ –†–∞–∑–º–µ—Ä —Å–ø–∏—Å–∫–∞ –ø–æ—Å–µ—â–µ–Ω–Ω—ã—Ö sourceVideoId: ${visitedSourceVideoIds.size}`, { module: 'VideoSelector' });
    log(`üìà –†–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞ –∫–∞–Ω–∞–ª–æ–≤: ${channelVideoCounts.size}`, { module: 'VideoSelector' });
    log(`üéûÔ∏è –†–∞–∑–º–µ—Ä –∏–Ω–¥–µ–∫—Å–∞ –≤–∏–¥–µ–æ –ø–æ –∫–∞–Ω–∞–ª–∞–º: ${channelToVideoIds.size}`, { module: 'VideoSelector' });

    try {
        // --- 0. –ü–æ–ª—É—á–∞–µ–º —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∏–¥–µ–æ ---
        const unavailableVideoIdsSet = await getUnavailableVideoIds();
        log(`üîí –ü–æ–ª—É—á–µ–Ω —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∏–¥–µ–æ. –†–∞–∑–º–µ—Ä: ${unavailableVideoIdsSet.size}`, { module: 'VideoSelector' });

        // --- 1. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ ---
        let candidateVideos = [];
        let candidateSource = '';
        let effectiveMode = mode; // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º

        // --- –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ ---
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∫–∞–Ω–∞–ª–æ–≤
        let channelsToCheckForOverride = new Set();
        if (effectiveMode === 'current_recommendations') {
            channelsToCheckForOverride = new Set(scrapedData.map(v => v.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª'));
        } else if (effectiveMode === 'all_videos') {
            // –î–ª—è 'all_videos' —Å–Ω–∞—á–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–∏–º —Ç–æ–ø –∫–∞–Ω–∞–ª—ã, –∫–∞–∫ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∞–ª–≥–æ—Ä–∏—Ç–º–µ
            const allChannels = Array.from(channelVideoCounts.keys());
            const sortedChannels = allChannels
                .map(channel => ({ name: channel, count: channelVideoCounts.get(channel) || 0 }))
                .sort((a, b) => a.count - b.count);
            const top10ChannelsInitial = sortedChannels.slice(0, 10);
            channelsToCheckForOverride = new Set(top10ChannelsInitial.map(c => c.name));
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏—è: –µ—Å–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –º–µ–Ω—å—à–µ 2, –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º
        if (channelsToCheckForOverride.size < 2) {
            const oldMode = effectiveMode;
            effectiveMode = 'all_videos'; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –º–µ–Ω—è–µ–º —Ä–µ–∂–∏–º
            log(`‚ö†Ô∏è –í –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–∞—Ö –¥–ª—è —Ä–µ–∂–∏–º–∞ '${oldMode}' –Ω–∞–π–¥–µ–Ω–æ –º–µ–Ω–µ–µ 2 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (${channelsToCheckForOverride.size}). –†–µ–∂–∏–º –≤—ã–±–æ—Ä–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ '${effectiveMode}'.`, { module: 'VideoSelector', level: 'warn' });
        } else {
            log(`‚úÖ –í –∏—Å—Ö–æ–¥–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–∞—Ö –¥–ª—è —Ä–µ–∂–∏–º–∞ '${effectiveMode}' –Ω–∞–π–¥–µ–Ω–æ ${channelsToCheckForOverride.size} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å —ç—Ç–∏–º —Ä–µ–∂–∏–º–æ–º.`, { module: 'VideoSelector' });
        }
        // --- –ö–æ–Ω–µ—Ü –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ ---

        // --- 2. –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ ---
        if (effectiveMode === 'current_recommendations') {
            // --- –†–ï–ñ–ò–ú: –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥–±–æ—Ä–∫–∏ ---
            candidateSource = '–ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–¥–±–æ—Ä–∫–∞ (scrapedData)';
            log(`üéûÔ∏è –†–µ–∂–∏–º 'current_recommendations': –∏—Å–ø–æ–ª—å–∑—É–µ–º ${scrapedData.length} –≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥–±–æ—Ä–∫–∏.`, { module: 'VideoSelector' });

            // üëá –ù–û–í–û–ï: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —è–∑—ã–∫—É –¥–ª—è —Ä–µ–∂–∏–º–∞ current_recommendations
            let filteredByLanguageScrapedData = [...scrapedData];
            log(`üî§ –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ —è–∑—ã–∫—É –¥–ª—è —Ä–µ–∂–∏–º–∞ 'current_recommendations'...`, { module: 'VideoSelector' });

            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º —Å–∏–º–≤–æ–ª–∞–º –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const cyrillicFiltered = scrapedData.filter(v =>
                v.title && isLikelyRussian(v.title)
            );

            if (cyrillicFiltered.length > 0) {
                filteredByLanguageScrapedData = cyrillicFiltered;
                log(`üî§ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º —Å–∏–º–≤–æ–ª–∞–º –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏: ${cyrillicFiltered.length}/${scrapedData.length} –≤–∏–¥–µ–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ.`, { module: 'VideoSelector' });
            } else {
                log(`üî§ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–º —Å–∏–º–≤–æ–ª–∞–º –Ω–µ –¥–∞–ª–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –û—Å—Ç–∞–≤–ª—è–µ–º –≤—Å–µ –≤–∏–¥–µ–æ (${scrapedData.length}).`, { module: 'VideoSelector', level: 'warn' });
                // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å filteredByLanguageScrapedData –ø—É—Å—Ç—ã–º –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ all_videos
                // –ù–æ –¥–ª—è MVP –æ—Å—Ç–∞–≤–∏–º –≤—Å–µ –≤–∏–¥–µ–æ, –µ—Å–ª–∏ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏—Ö –Ω–µ—Ç
                // filteredByLanguageScrapedData = []; 
            }

            candidateVideos = filteredByLanguageScrapedData; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            // üëÜ –ö–û–ù–ï–¶ –ù–û–í–û–ì–û: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —è–∑—ã–∫—É –¥–ª—è —Ä–µ–∂–∏–º–∞ current_recommendations

        } else if (effectiveMode === 'all_videos') {
            // --- –†–ï–ñ–ò–ú: –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –≤–∏–¥–µ–æ ---
            candidateSource = '–≤—Å–µ –≤–∏–¥–µ–æ (channelToVideoIds)';
            log(`üåê –†–µ–∂–∏–º 'all_videos': –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å–µ –≤–∏–¥–µ–æ –∏–∑ –∏–Ω–¥–µ–∫—Å–æ–≤.`, { module: 'VideoSelector' });

            // 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –∏–∑ channelVideoCounts
            const allChannels = Array.from(channelVideoCounts.keys());
            log(`üìà –ù–∞–π–¥–µ–Ω–æ ${allChannels.length} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –≤–æ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö.`, { module: 'VideoSelector' });

            // 2. –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–Ω–∞–ª—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ
            const sortedChannels = allChannels
                .map(channel => ({ name: channel, count: channelVideoCounts.get(channel) || 0 }))
                .sort((a, b) => a.count - b.count);

            log(`üìä –ö–∞–Ω–∞–ª—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤–∏–¥–µ–æ (–ø–µ—Ä–≤—ã–µ 10):`, { module: 'VideoSelector' });
            sortedChannels.slice(0, 10).forEach((c, i) => {
                log(`   ${i + 1}. ${c.name} (${c.count})`, { module: 'VideoSelector' });
            });

            // 3. –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 10 –∫–∞–Ω–∞–ª–æ–≤
            const top10Channels = sortedChannels.slice(0, 10);

            // 4. –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ videoId –∏–∑ —ç—Ç–∏—Ö –∫–∞–Ω–∞–ª–æ–≤
            const videoIdsFromTopChannels = new Set();
            for (const { name: channelName } of top10Channels) {
                const videoIdsInChannel = channelToVideoIds.get(channelName);
                if (videoIdsInChannel) {
                    for (const id of videoIdsInChannel) {
                        videoIdsFromTopChannels.add(id);
                    }
                }
            }
            log(`üéûÔ∏è –°–æ–±—Ä–∞–Ω–æ ${videoIdsFromTopChannels.size} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö videoId –∏–∑ —Ç–æ–ø-10 –∫–∞–Ω–∞–ª–æ–≤.`, { module: 'VideoSelector' });

            // 5. –°–æ–∑–¥–∞–µ–º "–≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ" –æ–±—ä–µ–∫—Ç—ã VideoData –¥–ª—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            candidateVideos = Array.from(videoIdsFromTopChannels).map(videoId => {
                // –ù–∞–π—Ç–∏ –∫–∞–Ω–∞–ª –¥–ª—è —ç—Ç–æ–≥–æ videoId (–Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, –Ω–æ –¥–ª—è MVP —Å–æ–π–¥–µ—Ç)
                let channelName = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª –∏–∑ Top10';
                for (const { name: chName } of top10Channels) {
                    const videoIds = channelToVideoIds.get(chName);
                    if (videoIds && videoIds.has(videoId)) {
                        channelName = chName;
                        break;
                    }
                }
                return { videoId, channelName };
            });

        } else {
            log(`‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –≤—ã–±–æ—Ä–∞: ${effectiveMode}. –ò—Å–ø–æ–ª—å–∑—É–µ–º scrapedData –∫–∞–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤.`, { module: 'VideoSelector', level: 'warn' });
            candidateVideos = [...scrapedData];
            candidateSource = 'scrapedData (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞)';
            effectiveMode = 'current_recommendations'; // –£—Ç–æ—á–Ω—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º –¥–ª—è –ª–æ–≥–∏–∫–∏ –Ω–∏–∂–µ
        }

        if (candidateVideos.length === 0) {
            log(`üìâ –ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ '${candidateSource}'.`, { module: 'VideoSelector', level: 'warn' });
            return null;
        }

        log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${candidateVideos.length} –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–∑ '${candidateSource}' (—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º: ${effectiveMode}).`, { module: 'VideoSelector' });

        // --- 3. –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ---
        const filteredCandidates = candidateVideos.filter(v =>
            v.videoId &&
            v.videoId !== currentVideoId &&
            !unavailableVideoIdsSet.has(v.videoId)
        );

        log(`üßπ –ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ (–Ω–µ —Ç–µ–∫—É—â–µ–µ, –Ω–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ–µ): ${filteredCandidates.length} –≤–∏–¥–µ–æ.`, { module: 'VideoSelector' });
        if (filteredCandidates.length === 0) {
            log(`üìâ –ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏.`, { module: 'VideoSelector', level: 'warn' });
            return null;
        }

        // --- 4. –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–∞–Ω–∞–ª–æ–≤ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∏–¥–µ–æ ---
        const candidateChannelsMap = new Map();
        for (const video of filteredCandidates) {
            const channel = video.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
            if (!candidateChannelsMap.has(channel)) {
                candidateChannelsMap.set(channel, { count: 0, videos: [] });
            }
            const globalCount = channelVideoCounts.get(channel) || 0;
            candidateChannelsMap.get(channel).count = globalCount;
            candidateChannelsMap.get(channel).videos.push(video);
        }

        // üëá –ù–û–í–û–ï: –ü–æ–ª—É—á–∞–µ–º –º–∞—Å—Å–∏–≤ –∫–∞–Ω–∞–ª–æ–≤
        const candidateChannelsArray = Array.from(candidateChannelsMap.entries())
            .map(([name, data]) => ({ name, ...data }));

        // üëá –ù–û–í–û–ï: –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–Ω–∞—á–∞–ª–∞ –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∏–¥–µ–æ (count)
        candidateChannelsArray.sort((a, b) => a.count - b.count);

        // üëá –ù–û–í–û–ï: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∫–∞–Ω–∞–ª–æ–≤ —Å count === 1
        // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –ø–µ—Ä–≤–æ–≥–æ –∫–∞–Ω–∞–ª–∞ —Å count > 1
        const firstNonSingleIndex = candidateChannelsArray.findIndex(channel => channel.count > 1);
        const singleVideoChannelsEndIndex = firstNonSingleIndex === -1 ? candidateChannelsArray.length : firstNonSingleIndex;

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–¥–º–∞—Å—Å–∏–≤ –∫–∞–Ω–∞–ª–æ–≤ —Å count === 1 –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º –∏—Ö –≤–∏–¥–µ–æ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)
        if (singleVideoChannelsEndIndex > 0) {
            const singleVideoChannels = candidateChannelsArray.slice(0, singleVideoChannelsEndIndex);
            singleVideoChannels.sort((a, b) => {
                // –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ (–∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ) –≤–∏–¥–µ–æ –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–Ω–∞–ª–∞
                const videoA = a.videos[0];
                const videoB = b.videos[0];
                const viewsA = parseViewsRobust(videoA.views || '');
                const viewsB = parseViewsRobust(videoB.views || '');
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤
                return viewsB - viewsA;
            });
            // –ó–∞–º–µ–Ω—è–µ–º –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–¥–º–∞—Å—Å–∏–≤ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –º–∞—Å—Å–∏–≤–µ
            candidateChannelsArray.splice(0, singleVideoChannelsEndIndex, ...singleVideoChannels);
        }

        // üëá –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
        const sortedCandidateChannels = candidateChannelsArray;

        log(`üìä –ö–∞–Ω–∞–ª—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ –≥–ª–æ–±–∞–ª—å–Ω–æ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –≤–∏–¥–µ–æ (–ø–µ—Ä–≤—ã–µ 10):`, { module: 'VideoSelector' });
        sortedCandidateChannels.slice(0, 10).forEach((c, i) => {
            log(`   ${i + 1}. ${c.name} (${c.count})`, { module: 'VideoSelector' });
            // üëá –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û: –î–ª—è –∫–∞–Ω–∞–ª–æ–≤ —Å –æ–¥–Ω–∏–º –≤–∏–¥–µ–æ –ª–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
            if (c.count === 1 && c.videos.length > 0) {
                const viewsNum = parseViewsRobust(c.videos[0].views || '');
                log(`      üëÅÔ∏è  –ü—Ä–æ—Å–º–æ—Ç—Ä—ã: ${viewsNum}`, { module: 'VideoSelector' });
            }
        });

        // --- 5. –ü–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –≤–∏–¥–µ–æ ---
        log(`üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫ –ø–æ–¥—Ö–æ–¥—è—â–µ–≥–æ –≤–∏–¥–µ–æ –ø–æ —Ç–æ–ø-–∫–∞–Ω–∞–ª–∞–º...`, { module: 'VideoSelector' });

        for (let i = 0; i < Math.min(10, sortedCandidateChannels.length); i++) {
            const channelData = sortedCandidateChannels[i];
            const channelName = channelData.name;
            const channelVideos = channelData.videos;
            log(`üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–Ω–∞–ª: ${channelName} (–≥–ª–æ–±–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${channelData.count})`, { module: 'VideoSelector' });

            for (const video of channelVideos) {
                if (!visitedSourceVideoIds.has(video.videoId)) {
                    log(`üéØ –ù–ê–ô–î–ï–ù–û –ø–æ–¥—Ö–æ–¥—è—â–µ–µ –≤–∏–¥–µ–æ: ${video.videoId} –∏–∑ –∫–∞–Ω–∞–ª–∞ ${channelName}`, { module: 'VideoSelector', level: 'success' });
                    return video.videoId;
                } else {
                    log(`‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –≤–∏–¥–µ–æ ${video.videoId} (—É–∂–µ –±—ã–ª–æ sourceVideoId)`, { module: 'VideoSelector' });
                }
            }
        }

        // --- 6. Fallback: —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∏–¥–µ–æ –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ ---
        log(`üîÑ –ü–æ–∏—Å–∫ –ø–æ —Ç–æ–ø-–∫–∞–Ω–∞–ª–∞–º –Ω–µ –¥–∞–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞. –ü—Ä–æ–±—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∏–¥–µ–æ –∏–∑ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤...`, { module: 'VideoSelector', level: 'warn' });
        if (filteredCandidates.length > 0) {
            const randomIndex = Math.floor(Math.random() * filteredCandidates.length);
            const randomVideo = filteredCandidates[randomIndex];
            log(`üé≤ Fallback –≤—ã–±—Ä–∞–ª —Å–ª—É—á–∞–π–Ω–æ–µ –≤–∏–¥–µ–æ: ${randomVideo.videoId}`, { module: 'VideoSelector', level: 'warn' });
            return randomVideo.videoId;
        }

        log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ.`, { module: 'VideoSelector', level: 'error' });
        return null;

    } catch (err) {
        log(`‚ùå –û—à–∏–±–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ: ${err.message}`, { module: 'VideoSelector', level: 'error' });
        console.error("[VideoSelector] Stack trace:", err);
        return null;
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\video-selector.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.css ===

/* === popup/popup.css === */

/* --- 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–µ–º—ã --- */
:root {
    --primary: #4338ca;
    --primary-hover: #3730a3;
    --success: #16a34a;
    --success-hover: #15803d;
    --warning: #ca8a04;
    --warning-hover: #a16207;
    --danger: #dc2626;
    --danger-hover: #b91c1c;
    --info: #0284c7;
    --info-hover: #0369a1;
    --secondary: #64748b;
    --secondary-hover: #475569;
    --bg: #ffffff;
    --card: #f9fafb;
    --text: #111827;
    --border: #e5e7eb;
    --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

/* --- 2. –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ --- */
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    padding: 16px;
    /* –§–∏–∫—Å–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –æ–±–ª–∞—Å—Ç–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏ popup */
    width: 800px;
    height: 720px;
    /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ body, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–æ–ª—å—à–µ */
    overflow: auto;
    /* –£–±–∏—Ä–∞–µ–º —Å–∫—Ä—ã—Ç–∏–µ –ø–æ–ª–æ—Å –ø—Ä–æ–∫—Ä—É—Ç–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è */
    /* overflow: hidden; –£–î–ê–õ–ò–¢–¨ */
}

/* --- 3. –ú–∞–∫–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è --- */
.app-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    /* –£–∫–∞–∑—ã–≤–∞–µ–º –∂–µ–ª–∞–µ–º—É—é –≤—ã—Å–æ—Ç—É —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ */
    /* height: 100%; –£–î–ê–õ–ò–¢–¨ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å */
    height: calc(720px - 32px);
    /* 720px (body height) - 32px (padding body 16*2) = 688px */
    /* –ò–õ–ò, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ 800px –¥–ª—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ: */
    /* height: 800px; */
    /* –£—Å—Ç–∞–Ω–æ–≤–∏—Ç –≤—ã—Å–æ—Ç—É –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –≤ 800px, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç body */
    /* –ï—Å–ª–∏ height –±—É–¥–µ—Ç –±–æ–ª—å—à–µ, —á–µ–º –≤—ã—Å–æ—Ç–∞ body (720px - 32px = 688px), –ø–æ—è–≤–∏—Ç—Å—è —Å–∫—Ä–æ–ª–ª —É body */

    /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Ä–æ—Å—Ç –±–æ–ª—å—à–µ –∑–∞–¥–∞–Ω–Ω–æ–π –≤—ã—Å–æ—Ç—ã, –µ—Å–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–Ω—å—à–µ */
    /* min-height: 100%; –ù–ï –ù–£–ñ–ù–û, –µ—Å–ª–∏ height —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω */
    /* –†–∞–∑—Ä–µ—à–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ app-container, –µ—Å–ª–∏ –µ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (—Å–µ–∫—Ü–∏–∏) –±–æ–ª—å—à–µ –µ–≥–æ –≤—ã—Å–æ—Ç—ã */
    /* overflow: hidden; –£–î–ê–õ–ò–¢–¨ */
    overflow: visible;
    /* –ò–ª–∏ auto, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–∫—Ä–æ–ª–ª –≤–Ω—É—Ç—Ä–∏ app-container –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
}

.app-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 16px;
    text-align: center;
}

/* --- 4. –°–µ–∫—Ü–∏–∏ (Sections) --- */
.section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    box-shadow: var(--shadow);
    flex-shrink: 0;
    /* üëá –í–ê–ñ–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º overflow: hidden –¥–ª—è .section */
    overflow: hidden;
    /* –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç flex-–ø–æ—Ç–æ–º–∫–æ–≤ (#logSection.content, #tableSection.content) 
       —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–∏–º –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ–º, –µ—Å–ª–∏ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç flex –∏ maxHeight/minHeight */
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

#logSection .section-header {
    margin-bottom: 8px;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
}

/* --- 5. –°–µ–∫—Ü–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ --- */
.settings-section.collapsed #settingsContent {
    display: none;
}

.setting-item {
    margin-bottom: 16px;
}

.setting-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
}

.radio-label:hover {
    background: var(--border);
}

.input-field {
    width: 100%;
    max-width: 200px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}

.import-textarea {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: monospace;
    font-size: 13px;
    resize: vertical;
    margin-bottom: 12px;
}

.toggle-btn {
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    color: var(--secondary);
    padding: 4px 8px;
    border-radius: 6px;
}

.toggle-btn:hover {
    background: var(--border);
}

/* –°—Ç–∏–ª—å –¥–ª—è input[type="file"] */
#importFileInput {
    width: 100%;
    max-width: 100%;
    /* –ü–æ–ª–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
    background-color: var(--bg);
    /* –¶–≤–µ—Ç —Ñ–æ–Ω–∞ */
    color: var(--text);
    /* –¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ */
    cursor: pointer;
    /* –ö—É—Ä—Å–æ—Ä-—É–∫–∞–∑–∞—Ç–µ–ª—å */
}

#importFileInput::-webkit-file-upload-button {
    /* –°—Ç–∏–ª–∏–∑—É–µ–º –∫–Ω–æ–ø–∫—É "–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª" –≤–Ω—É—Ç—Ä–∏ input */
    background-color: var(--primary);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    margin-right: 10px;
    cursor: pointer;
    font-weight: 500;
}

#importFileInput::-webkit-file-upload-button:hover {
    background-color: var(--primary-hover);
}

/* --- 6. –ì—Ä—É–ø–ø—ã –∫–Ω–æ–ø–æ–∫ --- */
.button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* --- 7. –¶–≤–µ—Ç–∞ –∫–Ω–æ–ø–æ–∫ --- */
.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: var(--success-hover);
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-warning:hover {
    background: var(--warning-hover);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: var(--danger-hover);
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-info:hover {
    background: var(--info-hover);
}

.btn-secondary {
    background: var(--secondary);
    color: white;
}

.btn-secondary:hover {
    background: var(--secondary-hover);
}

/* --- 8. –°–µ–∫—Ü–∏—è –∂—É—Ä–Ω–∞–ª–∞ --- */
#logSection {
    flex: 2;
    min-height: 250px;
    /* –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* –û—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ .section */
}

.log-container {
    padding: 12px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.5;
}

.log-entry {
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-family: monospace;
}

.log-entry:last-child {
    border-bottom: none;
}

/* –¶–≤–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π –ª–æ–≥–æ–≤ */
.log-level-info {
    color: var(--text);
}

.log-level-success {
    color: var(--success);
    font-weight: 500;
}

.log-level-warn {
    color: var(--warning);
}

.log-level-error {
    color: var(--danger);
    font-weight: 500;
}

/* Placeholder –¥–ª—è –∂—É—Ä–Ω–∞–ª–∞ */
.log-placeholder {
    color: var(--secondary);
    font-style: italic;
    text-align: center;
    padding: 20px 0;
}

/* --- 9. –°–µ–∫—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã --- */
#tableSection {
    flex: 3;
    min-height: 250px;
    /* –£–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* –û—Å—Ç–∞–µ—Ç—Å—è –Ω–∞ .section */
}

#tableSection .section-header {
    margin-bottom: 8px;
}

/* --- 10. –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö --- */
.table-container {
    flex: 1;
    overflow: auto;
    min-height: 0;
    border: 1px solid var(--border);
    border-radius: 8px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    height: 100%;
}

.data-table th,
.data-table td {
    padding: 8px;
    text-align: left;
    border: 1px solid var(--border);
}

.data-table th {
    background-color: var(--card);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
}

.data-table tr:nth-child(even) {
    background-color: #fafafa;
}

/* Placeholder –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
.table-placeholder td {
    text-align: center;
    color: var(--secondary);
    font-style: italic;
    padding: 40px 20px;
}

.data-table img {
    width: 60px;
    height: 34px;
    object-fit: cover;
    border-radius: 4px;
}

/* --- 11. –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã --- */
.log-container::-webkit-scrollbar,
.table-container::-webkit-scrollbar {
    width: 6px;
}

.log-container::-webkit-scrollbar-thumb,
.table-container::-webkit-scrollbar-thumb {
    background-color: var(--border);
    border-radius: 3px;
}

/* --- 12. –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –º–µ—Ç—Ä–∏–∫–∏ —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤ --- */
.metric-indicator {
    display: inline-block;
    margin-left: 16px;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: white;
    background-color: var(--secondary);
    /* –°–µ—Ä—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    vertical-align: middle;
    line-height: 1;
}

/* –¶–≤–µ—Ç–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ */
.metric-indicator.good {
    background-color: var(--success);
    /* –ó–µ–ª–µ–Ω—ã–π */
}

.metric-indicator.warning {
    background-color: var(--warning);
    /* –ñ–µ–ª—Ç—ã–π */
}

.metric-indicator.bad {
    background-color: var(--danger);
    /* –ö—Ä–∞—Å–Ω—ã–π */
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.css ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.html ===

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ü–∞—Ä—Å–µ—Ä</title>
    <link rel="stylesheet" href="popup.css">
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">üìπ YouTube –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ü–∞—Ä—Å–µ—Ä</h1>
        </header>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Collapsible) -->
        <section id="settingsSection" class="section settings-section">
            <div class="section-header">
                <h2 class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button id="toggleSettingsBtn" class="toggle-btn">‚ñ≤</button>
            </div>
            <div id="settingsContent" class="section-content">
                <!-- –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ -->
                <div class="setting-item">
                    <label class="setting-label">–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ:</label>
                    <div class="radio-group">
                        <!-- –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ value -->
                        <label class="radio-label">
                            <input type="radio" name="selectionMode" value="all_videos" checked>
                            –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –≤–∏–¥–µ–æ
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="selectionMode" value="current_recommendations">
                            –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥–±–æ—Ä–∫–∏
                        </label>
                    </div>
                </div>

                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π -->
                <div class="setting-item">
                    <label class="setting-label" for="iterationsInput">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π:</label>
                    <input type="number" id="iterationsInput" class="input-field" value="10" min="1" max="1000">
                </div>

                <!-- –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
                <div class="setting-item">
                    <label class="setting-label">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (CSV/TSV):</label>

                    <!-- üëá –ù–û–í–û–ï: Input –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ -->
                    <input type="file" id="importFileInput" class="file-input" accept=".csv,.tsv,text/csv,text/tsv">

                    <!-- üëá –ù–û–í–û–ï: –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ -->
                    <div class="button-group">
                        <button id="importDataBtn" class="btn btn-primary">üìÇ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª</button>
                        <button id="clearImportedBtn" class="btn btn-secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <section id="controlSection" class="section control-section">
            <div class="section-header">
                <h2 class="section-title">üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            </div>
            <div class="control-group">
                <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ -->
                <div class="setting-item">
                    <label class="setting-label" for="scenarioSelector">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π:</label>
                    <select id="scenarioSelector" class="input-field">
                        <option value="parse-recommendation">–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</option>
                        <option value="test-countdown">–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç</option>
                        <!-- –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –æ–ø—Ü–∏–π -->
                    </select>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="button-group">
                    <!-- –ò–∑–º–µ–Ω—è–µ–º ID –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—É—Å–∫–∞ -->
                    <button id="runScenarioBtn" class="btn btn-success">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ -->
                    <button id="stopBtn" class="btn btn-warning" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button id="copyTableBtn" class="btn btn-info">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
                    <button id="clearTableBtn" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
                    <button id="clearLogBtn" class="btn btn-secondary">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
                    <button id="resetIndicesBtn" class="btn btn-secondary">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã</button>
                    <button id="dumpIndicesBtn" class="btn btn-secondary">üîç Dump Indices to Console</button>
                </div>
            </div>
        </section>

        <!-- –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π -->
        <section id="logSection" class="section log-section">
            <div class="section-header">
                <h2 class="section-title">
                    üìã –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π
                    <span id="russianChannelMetricIndicator" class="metric-indicator">‚Äî</span>
                </h2>
            </div>
            <div id="logContainer" class="log-container">
                <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                <div class="log-placeholder">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>
            </div>
        </section>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <section id="tableSection" class="section table-section">
            <div class="section-header">
                <h2 class="section-title">üìä –°–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
            </div>
            <div class="table-container">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>ID</th>
                            <th>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                            <th>–ö–∞–Ω–∞–ª</th>
                            <th>–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ</th>
                            <th>–ú–∏–Ω–∏–∞—Ç—é—Ä–∞</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                        <tr class="table-placeholder">
                            <td colspan="6">–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script type="module" src="./popup.js"></script>
</body>

</html>

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.html ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.js ===


// popup/popup.js
import { SettingsSection } from './components/SettingsSection.js';
import { ControlSection } from './components/ControlSection.js';
import { LogSection } from './components/LogSection.js';
import { TableSection } from './components/TableSection.js';

class PopupApp {
    constructor() {
        this.initElements();
        this.initComponents(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        this.bindEvents(); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è popup-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        this.loadState(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI
        this.updateScenarioControlButtons(false);
        this.checkScenarioStatusOnLoad();
        this.isScenarioLaunchInProgress = false;
    }

    initElements() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM —ç–ª–µ–º–µ–Ω—Ç—ã, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–µ popup –Ω–∞–ø—Ä—è–º—É—é
        this.settingsSection = document.getElementById('settingsSection');
        this.settingsContent = document.getElementById('settingsContent');
        this.toggleSettingsBtn = document.getElementById('toggleSettingsBtn');

        this.selectionModeRadios = document.querySelectorAll('input[name="selectionMode"]');
        this.iterationsInput = document.getElementById('iterationsInput');
        this.importTextarea = document.getElementById('importTextarea');
        this.importDataBtn = document.getElementById('importDataBtn');
        this.clearImportedBtn = document.getElementById('clearImportedBtn');

        this.runScenarioBtn = document.getElementById('runScenarioBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.copyTableBtn = document.getElementById('copyTableBtn');
        this.clearTableBtn = document.getElementById('clearTableBtn');
        this.clearLogBtn = document.getElementById('clearLogBtn');

        // –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

        this.scenarioSelector = document.getElementById('scenarioSelector');

        document.addEventListener('importData', (e) => {
            this.handleImportData(e.detail); // –ü–µ—Ä–µ–¥–∞—ë–º detail –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
        });
    }

    initComponents() {
        // –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤. –û–Ω–∏ —Å–∞–º–∏ –ø—Ä–∏–≤—è–∂—É—Ç —Å–≤–æ–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ DOM.
        this.settings = new SettingsSection();
        this.control = new ControlSection();
        this.logs = new LogSection();
        this.table = new TableSection();

        // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        // –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ updateLogs –∏ updateTable
        this.logs.loadInitialLogs();
        this.table.loadInitialData();
    }

    bindEvents() {
        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI popup-–∞ ---
        this.selectionModeRadios.forEach(radio => {
            radio.addEventListener('change', () => this.saveSettings());
        });
        this.iterationsInput.addEventListener('change', () => this.saveSettings());
        this.importDataBtn.addEventListener('click', () => this.handleImport());
        this.clearImportedBtn.addEventListener('click', () => this.handleClearImported());

        this.runScenarioBtn.addEventListener('click', () => this.handleRunScenario());
        this.stopBtn.addEventListener('click', () => this.handleStop());
        this.copyTableBtn.addEventListener('click', () => this.handleCopyTable());
        this.clearTableBtn.addEventListener('click', () => this.handleClearTable());
        this.clearLogBtn.addEventListener('click', () => this.handleClearLog());

        this.runScenarioBtn.addEventListener('click', () => this.handleRunScenario());

        document.addEventListener('requestImportFromFile', () => this.handleImportFromFile());

        // --- –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç background ---
        this.addMessageListener();
    }

    saveSettings() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const isSettingsCollapsed = this.settingsSection.classList.contains('collapsed');

        const state = {
            isSettingsCollapsed: isSettingsCollapsed,
            selectionMode: document.querySelector('input[name="selectionMode"]:checked')?.value || 'smart',
            iterations: this.iterationsInput.value,
        };


        try {
            localStorage.setItem('popupSettings', JSON.stringify(state));
        } catch (e) {
            console.error("saveSettings: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ localStorage:", e);
        }
    }

    loadState() {

        const savedStateJson = localStorage.getItem('popupSettings');
        if (savedStateJson) {
            try {
                const state = JSON.parse(savedStateJson);
                if (state.isSettingsCollapsed === true) {
                    this.settingsSection.classList.add('collapsed');
                    this.toggleSettingsBtn.textContent = 'üîΩ';
                } else {
                    this.settingsSection.classList.remove('collapsed');
                    this.toggleSettingsBtn.textContent = '‚ñ≤';
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (state.selectionMode) {
                    const radio = document.querySelector(`input[name="selectionMode"][value="${state.selectionMode}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                }

                if (state.iterations) {
                    this.iterationsInput.value = state.iterations;
                }
            } catch (e) {
                console.error("loadState: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", e);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                // –∏ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
            }
        } else {
            this.settingsSection.classList.remove('collapsed'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ
            this.toggleSettingsBtn.textContent = '‚ñ≤';
            // –î—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –∑–∞–¥–∞–Ω—ã –≤ HTML
        }
    }

    // --- Message Listener ---
    addMessageListener() {
        this.messageListener = (request, sender, sendResponse) => {
            if (request.type === 'scenarioStatus') {
                console.log("PopupApp: Received scenarioStatus message", request);
                if (request.status === 'started') {
                    this.updateScenarioControlButtons(true);
                } else if (request.status === 'stopped' || request.status === 'finished') {
                    console.log("PopupApp: Updating buttons to STOPPED state based on scenarioStatus"); // <-- –õ–æ–≥
                    this.updateScenarioControlButtons(false);
                }
                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                if (request.message) {
                    document.dispatchEvent(new CustomEvent('log', { detail: { message: request.message, level: request.level || 'info' } }));
                }
                return;
            }

            if (request.type === 'dataUpdated') {
                this.table.loadInitialData();
            }

            if (request.type === 'dataCleared') {
                document.dispatchEvent(new CustomEvent('clearTable'));
            }

            if (request.type === 'newLog' && request.log) {
                document.dispatchEvent(new CustomEvent('log', { detail: request.log }));
            }

            if (request.type === 'logsCleared') {
                document.dispatchEvent(new CustomEvent('clearLog'));
            }

            if (request.type === 'dataCleared') {
                document.dispatchEvent(new CustomEvent('clearTable'));
            }

            // TODO: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            // if (request.type === 'analysisStatus') { ... }
            // if (request.type === 'dataUpdated') { 
            //    document.dispatchEvent(new CustomEvent('updateTable', { detail: newDataArray }));
            // }
        };

        chrome.runtime.onMessage.addListener(this.messageListener);
    }

    // --- Button Handlers (–∏–º–∏—Ç–∞—Ü–∏—è / –∑–∞–≥–ª—É—à–∫–∏) ---
    // –≠—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç CustomEvent –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    // –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞—é—Ç chrome.runtime.sendMessage

    handleImport() {
        const text = this.importTextarea.value.trim();
        if (!text) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', level: 'error' } }));
            return;
        }
        document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–∏–º–∏—Ç–∞—Ü–∏—è): ${text.split('\n').length - 1} —Å—Ç—Ä–æ–∫`, level: 'success' } }));
        this.importTextarea.value = '';
        // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç sendMessage –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ background
        // –∏ –∑–∞—Ç–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        setTimeout(() => {
            this.table.loadInitialData(); // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        }, 500);
    }

    handleClearImported() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã (–∏–º–∏—Ç–∞—Ü–∏—è)', level: 'success' } }));
        // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç sendMessage –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤ background
    }

    async handleRunScenario() {
        if (this.isScenarioLaunchInProgress) {
            console.warn("[PopupApp] –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫.");
            return;
        }
        this.isScenarioLaunchInProgress = true; // <-- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥
        // 1. –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        const selectedScenarioId = this.scenarioSelector.value;
        if (!selectedScenarioId) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞', level: 'error' } }));
            return;
        }

        // 2. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ UI
        const iterations = parseInt(this.iterationsInput.value) || 10;
        const mode = document.querySelector('input[name="selectionMode"]:checked')?.value || 'all_videos';

        // 3. –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ
        const scenarioName = this.scenarioSelector.options[this.scenarioSelector.selectedIndex].text;
        document.dispatchEvent(new CustomEvent('log', { detail: { message: `üì§ –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioName}": ${iterations} –∏—Ç–µ—Ä–∞—Ü–∏–π, —Ä–µ–∂–∏–º: ${mode}`, level: 'info' } }));

        try {
            // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const response = await chrome.runtime.sendMessage({
                action: "runScenario",
                scenarioId: selectedScenarioId,
                params: {
                    iterations,
                    mode,
                    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–∑–∂–µ)
                    count: 16,
                    delayMs: 1500,
                    step: 1000
                }
            });

            if (response && response.status === "started") {
                console.log("[PopupApp] –°—Ü–µ–Ω–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ background, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫.");
                // 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                this.updateScenarioControlButtons(true);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω. ID: ${response.instanceId}`, level: 'success' } }));
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ';
                console.error("[PopupApp] –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è: ${errorMsg}`, level: 'error' } }));
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                this.updateScenarioControlButtons(false);
            }

        } catch (err) {
            console.error("[PopupApp] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏—è:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏—è: ${err.message}`, level: 'error' } }));
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            this.isScenarioLaunchInProgress = false;
            this.updateScenarioControlButtons(false);
        } finally {
            // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞
            console.log("[PopupApp] Finally –±–ª–æ–∫ handleRunScenario: —Å–±—Ä–æ—Å —Ñ–ª–∞–≥–∞ isScenarioLaunchInProgress.");
            this.isScenarioLaunchInProgress = false; // <-- –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥
            this.updateScenarioControlButtons(false);
        }
    }

    async handleStop() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤...', level: 'info' } }));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
            const response = await chrome.runtime.sendMessage({
                action: "stopAllScenarios"
            });

            if (response && response.status === "success") {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ ${response.message}`, level: 'warn' } }));
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                this.updateScenarioControlButtons(false);
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ';
                console.error("[PopupApp] –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${errorMsg}`, level: 'error' } }));
                // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–∑–∞–ø—É—â–µ–Ω–æ", —Ç–∞–∫ –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
            }
        } catch (err) {
            console.error("[PopupApp] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${err.message}`, level: 'error' } }));
            // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–∑–∞–ø—É—â–µ–Ω–æ", —Ç–∞–∫ –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
        }
    }

    async handleCopyTable() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (CSV —Å ";")...', level: 'info' } }));

        try {
            // 1. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            const response = await chrome.runtime.sendMessage({ action: "copyTableDataAsCSV" }); // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

            if (response && response.status === "success") {
                // 2. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ CSV –∏–∑ –æ—Ç–≤–µ—Ç–∞
                const csvContent = response.data; // –û–∂–∏–¥–∞–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ —É–∂–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ

                // 3. –ö–æ–ø–∏—Ä—É–µ–º –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                await navigator.clipboard.writeText(csvContent);

                const lines = csvContent.split('\n').filter(line => line.trim() !== '').length;
                const dataLines = lines > 1 ? lines - 1 : 0; // –í—ã—á–∏—Ç–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫

                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (${dataLines} —Å—Ç—Ä–æ–∫)`, level: 'success' } }));
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                throw new Error(errorMsg);
            }
        } catch (err) {
            console.error("[PopupApp] –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, level: 'error' } }));
        }
    }

    async handleClearTable() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü—ã...', level: 'info' } }));
        try {
            const response = await chrome.runtime.sendMessage({ action: "clearTableData" });
            if (response.status === "success") {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞', level: 'success' } }));
                // –°–æ–æ–±—â–∞–µ–º TableSection –æ–± –æ—á–∏—Å—Ç–∫–µ
                document.dispatchEvent(new CustomEvent('clearTable'));
            } else {
                throw new Error(response.message);
            }
        } catch (err) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, level: 'error' } }));
        }
    }

    async handleClearLog() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ popup –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        // –∏ background –ø–æ—Ç–æ–º –ø—Ä–∏—Å–ª–∞–µ—Ç 'logsCleared' –∏–ª–∏ popup —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç UI
        try {
            await chrome.storage.local.remove(['appLogs']);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', level: 'success' } }));
            // –°–æ–æ–±—â–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É –∂—É—Ä–Ω–∞–ª–∞ –æ–± –æ—á–∏—Å—Ç–∫–µ
            document.dispatchEvent(new CustomEvent('clearLog'));
        } catch (err) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∂—É—Ä–Ω–∞–ª–∞: ${err.message}`, level: 'error' } }));
        }
    }

    async handleImportData(eventDetail) {
        const dataToImport = eventDetail && eventDetail.data;

        if (!dataToImport || !Array.isArray(dataToImport)) {
            console.error("[PopupApp] handleImportData: –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º", dataToImport);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', level: 'error' } }));
            return;
        }

        document.dispatchEvent(new CustomEvent('log', { detail: { message: `üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${dataToImport.length} –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞...`, level: 'info' } }));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ background –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const response = await chrome.runtime.sendMessage({
                action: "importTableData", // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∞
                data: dataToImport // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é
            });

            if (response && response.status === "success") {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ ${response.count} –∑–∞–ø–∏—Å–µ–π —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã`, level: 'success' } }));
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ popup
                this.table.loadInitialData();
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error("[PopupApp] –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ background:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${errorMsg}`, level: 'error' } }));
            }
        } catch (err) {
            console.error("[PopupApp] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ background:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å background: ${err.message}`, level: 'error' } }));
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏.
     * @param {boolean} isRunning - –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ–π—á–∞—Å –∫–∞–∫–æ–π-–ª–∏–±–æ —Å—Ü–µ–Ω–∞—Ä–∏–π.
     */
    updateScenarioControlButtons(isRunning) {
        if (this.runScenarioBtn && this.stopBtn) {
            this.runScenarioBtn.disabled = isRunning;
            this.stopBtn.disabled = !isRunning;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ popup.
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.
     */
    async checkScenarioStatusOnLoad() {
        console.log("[PopupApp] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ...");
        try {
            const response = await chrome.runtime.sendMessage({
                action: "getScenarioStatus"
            });

            if (response && response.status === "success") {
                const isRunning = response.isRunning;
                console.log(`[PopupApp] –°—Ç–∞—Ç—É—Å —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: isRunning=${isRunning}`);
                this.updateScenarioControlButtons(isRunning);

                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
                if (isRunning) {
                    const count = response.runningScenarios?.length || 1;
                    document.dispatchEvent(new CustomEvent('log', {
                        detail: {
                            message: `‚ÑπÔ∏è –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ popup –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${count}. –ö–Ω–æ–ø–∫–∞ "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞.`,
                            level: 'info'
                        }
                    }));
                }
            } else {
                console.warn("[PopupApp] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", response?.message);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–Ω–µ –∑–∞–ø—É—â–µ–Ω–æ)
                this.updateScenarioControlButtons(false);
            }
        } catch (err) {
            console.error("[PopupApp] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", err);
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–Ω–µ –∑–∞–ø—É—â–µ–Ω–æ)
            this.updateScenarioControlButtons(false);
        }
    }

    async handleImportFromFile() {
        // 1. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ input
        const fileInput = document.getElementById('importFileInput');
        const file = fileInput?.files[0];

        if (!file) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', level: 'error' } }));
            return;
        }

        // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (!file.name.endsWith('.csv') && !file.name.endsWith('.tsv')) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –í—ã–±–µ—Ä–∏—Ç–µ .csv –∏–ª–∏ .tsv', level: 'error' } }));
            fileInput.value = '';
            return;
        }

        // 3. –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
        try {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `üîÑ –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ "${file.name}"...`, level: 'info' } }));
            const text = await this.#readFileAsync(file);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –§–∞–π–ª "${file.name}" –ø—Ä–æ—á–∏—Ç–∞–Ω. –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥...`, level: 'success' } }));

            // 4. –ü–∞—Ä—Å–∏–º CSV/TSV
            const data = this.#parseCSV(text);
            if (data.length === 0) {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞', level: 'error' } }));
                fileInput.value = '';
                return;
            }

            // 5. –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ isImported
            const dataWithFlag = data.map(item => ({
                ...item,
                isImported: true,
                timestamp: item.timestamp || Date.now()
            }));

            document.dispatchEvent(new CustomEvent('log', { detail: { message: `üìä –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ ${dataWithFlag.length} –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.`, level: 'info' } }));

            // 6. üëá –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–• –ß–ê–ù–ö–ê–ú–ò –í BACKGROUND
            await this.#importDataInChunks(dataWithFlag, file.name);

            // 7. –û—á–∏—â–∞–µ–º input –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
            fileInput.value = '';
            this.table.loadInitialData();

        } catch (err) {
            console.error("[PopupApp] –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —Ñ–∞–π–ª–∞:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${err.message}`, level: 'error' } }));
        }
    }

    // üëá –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ —á—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    #readFileAsync(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = (e) => reject(new Error(`–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${e.target.error.message}`));
            reader.readAsText(file);
        });
    }

    // üëá –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –ü–∞—Ä—Å–∏–Ω–≥ CSV (—Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –∏–∑ SettingsSection.js)
    #parseCSV(text) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) throw new Error('–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª');

        let delimiter = ';';
        if (lines[0].includes('\t')) delimiter = '\t';
        else if (lines[0].includes(',')) delimiter = ',';

        const headers = this.#parseCsvLine(lines[0], delimiter);

        const required = ['–Ω–∞–∑–≤–∞–Ω–∏–µ', 'id', '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã', '–∫–∞–Ω–∞–ª', '–∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ', '–º–∏–Ω–∏–∞—Ç—é—Ä–∞'];
        const fieldMap = {
            '–Ω–∞–∑–≤–∞–Ω–∏–µ': 'title',
            'id': 'videoId',
            '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã': 'views',
            '–∫–∞–Ω–∞–ª': 'channelName',
            '–∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ': 'sourceVideoId',
            '–º–∏–Ω–∏–∞—Ç—é—Ä–∞': 'thumbnailUrl'
        };

        const indices = {};
        required.forEach(field => {
            const index = headers.findIndex(h => h.trim().toLowerCase() === field);
            if (index === -1) throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: ${field}`);
            indices[field] = index;
        });

        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cells = this.#parseCsvLine(line, delimiter);
            if (cells.length < required.length) continue;

            const item = {};
            required.forEach(field => {
                const index = indices[field];
                item[fieldMap[field]] = cells[index] ? cells[index] : '';
            });
            data.push(item);
        }
        return data;
    }

    // üëá –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ô –ú–ï–¢–û–î: –ü–∞—Ä—Å–∏–Ω–≥ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ CSV
    #parseCsvLine(line, delimiter) {
        const values = [];
        let currentValue = '';
        let insideQuotes = false;
        let i = 0;
        while (i < line.length) {
            const char = line[i];
            if (char === '"') {
                if (insideQuotes && i + 1 < line.length && line[i + 1] === '"') {
                    currentValue += '"';
                    i += 2;
                } else {
                    insideQuotes = !insideQuotes;
                    i++;
                }
            } else if (char === delimiter && !insideQuotes) {
                values.push(currentValue.trim());
                currentValue = '';
                i++;
            } else {
                currentValue += char;
                i++;
            }
        }
        values.push(currentValue.trim());
        return values;
    }

    // üëá –ì–õ–ê–í–ù–´–ô –ú–ï–¢–û–î: –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–∞–º–∏
    async #importDataInChunks(data, fileName) {
        const CHUNK_SIZE = 5000;
        const CONCURRENT_REQUESTS = 5; // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
        const totalChunks = Math.ceil(data.length / CHUNK_SIZE);

        document.dispatchEvent(new CustomEvent('log', { detail: { message: `üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö —á–∞–Ω–∫–∞–º–∏ –ø–æ ${CHUNK_SIZE} –∑–∞–ø–∏—Å–µ–π —Å –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π...`, level: 'info' } }));

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–¥–Ω–æ–≥–æ —á–∞–Ω–∫–∞
        const processChunk = async (chunkIndex) => {
            const start = chunkIndex * CHUNK_SIZE;
            const end = start + CHUNK_SIZE;
            const chunk = data.slice(start, end);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: "importTableDataChunk",
                    data: chunk,
                    isLastChunk: (chunkIndex === totalChunks - 1),
                    fileName: fileName,
                    chunkIndex: chunkIndex + 1,
                    totalChunks: totalChunks
                });

                if (response?.status === "success") {
                    return { success: true, chunkIndex: chunkIndex + 1 };
                } else {
                    throw new Error(response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (err) {
                return { success: false, chunkIndex: chunkIndex + 1, error: err.message };
            }
        };

        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —á–∞–Ω–∫–∏ –ø–∞—á–∫–∞–º–∏
        for (let i = 0; i < totalChunks; i += CONCURRENT_REQUESTS) {
            const chunkBatch = [];
            for (let j = i; j < Math.min(i + CONCURRENT_REQUESTS, totalChunks); j++) {
                chunkBatch.push(processChunk(j));
            }

            const results = await Promise.allSettled(chunkBatch);

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–∞—á–∫–∏
            for (const result of results) {
                if (result.status === 'fulfilled') {
                    const { success, chunkIndex, error } = result.value;
                    if (success) {
                        document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –ß–∞–Ω–∫ ${chunkIndex}/${totalChunks} —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω.`, level: 'success' } }));
                    } else {
                        document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ —á–∞–Ω–∫–∞ ${chunkIndex}/${totalChunks}: ${error}`, level: 'error' } }));
                    }
                } else {
                    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ —Å–∞–º–æ–π —Ñ—É–Ω–∫—Ü–∏–∏ processChunk (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ)
                    document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —á–∞–Ω–∫–∞: ${result.reason?.message}`, level: 'error' } }));
                }
            }
        }

        document.dispatchEvent(new CustomEvent('log', { detail: { message: `üéâ –ò–º–ø–æ—Ä—Ç —Ñ–∞–π–ª–∞ "${fileName}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!`, level: 'success' } }));
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
document.addEventListener('DOMContentLoaded', () => {
    new PopupApp();
});


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\ControlSection.js ===

export class ControlSection {
    constructor() {
        // –û–±–Ω–æ–≤–ª—è–µ–º ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å popup.html
        this.runScenarioBtn = document.getElementById('runScenarioBtn'); // <-- –ò–∑–º–µ–Ω–µ–Ω–æ
        this.stopBtn = document.getElementById('stopBtn');
        this.copyTableBtn = document.getElementById('copyTableBtn');
        this.clearTableBtn = document.getElementById('clearTableBtn');
        this.clearLogBtn = document.getElementById('clearLogBtn');
        this.resetIndicesBtn = document.getElementById('resetIndicesBtn');
        this.dumpIndicesBtn = document.getElementById('dumpIndicesBtn');
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
        this.scenarioSelector = document.getElementById('scenarioSelector'); // <-- –ù–æ–≤–æ–µ

        this.init();
    }

    init() {
        // –°–ª—É—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç popup –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        document.addEventListener('control:enableStart', () => this.enableStart());
        document.addEventListener('control:disableStart', () => this.disableStart());

        if (this.resetIndicesBtn) {
            this.resetIndicesBtn.addEventListener('click', () => this.handleResetIndices());
        } else {
            console.warn("[ControlSection] –ö–Ω–æ–ø–∫–∞ 'resetIndicesBtn' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM.");
        }

        // üëá –ù–û–í–´–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤—ã–≤–æ–¥–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        if (this.dumpIndicesBtn) {
            this.dumpIndicesBtn.addEventListener('click', () => this.handleDumpIndices());
        } else {
            console.warn("[ControlSection] –ö–Ω–æ–ø–∫–∞ 'dumpIndicesBtn' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ DOM.");
        }

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π UI

        this.stopBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('stopAnalysis')); // –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
        });

        this.copyTableBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('copyTable'));
        });

        this.clearTableBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('clearTable'));
        });

        this.clearLogBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('clearLog'));
        });
    }

    handleStart() {
        const iterations = parseInt(document.getElementById('iterationsInput').value) || 10;
        const mode = document.querySelector('input[name="selectionMode"]:checked')?.value || 'smart';

        this.dispatchEvent('startAnalysis', { iterations, mode });
        this.startBtn.disabled = true;
        this.stopBtn.disabled = false;
    }

    handleStop() {
        this.dispatchEvent('stopAnalysis');
        this.startBtn.disabled = false;
        this.stopBtn.disabled = true;
    }

    handleCopyTable() {
        this.dispatchEvent('copyTable');
    }

    handleClearTable() {
        this.dispatchEvent('clearTable');
    }

    handleClearLog() {
        this.dispatchEvent('clearLog');
    }

    async handleResetIndices() {
        console.log("[ControlSection] –ù–∞—á–∞–ª–æ handleResetIndices");
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–±—Ä–æ—Å –∏–Ω–¥–µ–∫—Å–æ–≤...', level: 'info' } }));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background
            const response = await chrome.runtime.sendMessage({
                action: "resetIndices"
            });

            if (response && response.status === "success") {
                console.log("[ControlSection] –ò–Ω–¥–µ–∫—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã –≤ background");
                document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –ò–Ω–¥–µ–∫—Å—ã —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω—ã', level: 'success' } }));
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ, –µ—Å–ª–∏ –¥—Ä—É–≥–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å
                // document.dispatchEvent(new CustomEvent('indicesReset'));
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error("[ControlSection] –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ background:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –∏–Ω–¥–µ–∫—Å–æ–≤: ${errorMsg}`, level: 'error' } }));
            }
        } catch (err) {
            console.error("[ControlSection] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã —Å–±—Ä–æ—Å–∞ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ background:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ${err.message}`, level: 'error' } }));
        }
    }

    async handleDumpIndices() {
        console.log("[ControlSection] –ù–∞—á–∞–ª–æ handleDumpIndices");
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üîç –ó–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤...', level: 'info' } }));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è
            const response = await chrome.runtime.sendMessage({
                action: "getIndexState"
            });

            if (response && response.status === "success") {
                const state = response.serializableState;
                console.log("[ControlSection] === –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ IndexManager ===");

                // –í—ã–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ–±—ä–µ–∫—Ç–∞ state —Å –ø–æ—è—Å–Ω–µ–Ω–∏—è–º–∏
                console.log(`scrapedDataBuffer:`, `${state.scrapedDataBuffer_count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`, state.scrapedDataBuffer_sample);
                console.log(`visitedVideoIds:`, `${state.visitedVideoIds_count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`, state.visitedVideoIds_sample);
                console.log(`channelVideoCounts:`, `${state.channelVideoCounts_count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`, state.channelVideoCounts_sample);
                console.log(`channelToVideoIds:`, `${state.channelToVideoIds_count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤`, state.channelToVideoIds_sample);

                console.log("[ControlSection] === –ö–æ–Ω–µ—Ü —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ ===");

                document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤—ã–≤–µ–¥–µ–Ω–æ –≤ –∫–æ–Ω—Å–æ–ª—å background', level: 'success' } }));
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error("[ControlSection] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–∑ background:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤: ${errorMsg}`, level: 'error' } }));
            }
        } catch (err) {
            console.error("[ControlSection] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ background:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ${err.message}`, level: 'error' } }));
        }
    }

    enableStart() {
        // –õ–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ PopupApp.updateScenarioControlButtons
        if (this.runScenarioBtn) this.runScenarioBtn.disabled = false;
        if (this.stopBtn) this.stopBtn.disabled = true;
    }

    disableStart() {
        // –õ–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ PopupApp.updateScenarioControlButtons
        if (this.runScenarioBtn) this.runScenarioBtn.disabled = true;
        if (this.stopBtn) this.stopBtn.disabled = false;
    }

    dispatchEvent(type, detail) {
        document.dispatchEvent(new CustomEvent(type, { detail }));
    }
}


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\ControlSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\LogSection.js ===

// popup/components/LogSection.js
export class LogSection {
    constructor() {
        this.container = document.getElementById('logContainer');
        this.init();
    }

    init() {
        // –°–ª—É—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤
        document.addEventListener('log', (e) => {
            this.addLog(e.detail);
        });
        document.addEventListener('clearLog', () => this.clear());
        // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
        this.loadInitialLogs();
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
     */
    async loadInitialLogs() {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ chrome.storage.local
            // –í –±—É–¥—É—â–µ–º —ç—Ç–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤—ã–∑–æ–≤ –Ω–æ–≤–æ–≥–æ Logger API
            const result = await chrome.storage.local.get(['appLogs']);
            const logs = result.appLogs || [];

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —É–±–∏—Ä–∞–µ–º placeholder
            this.container.innerHTML = '';

            if (logs.length === 0) {
                // –ï—Å–ª–∏ –ª–æ–≥–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                this.#showPlaceholder();
            } else {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –ª–æ–≥–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100
                const logsToShow = logs.slice(-100);
                logsToShow.forEach(logEntry => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ addLog, –Ω–æ –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                    this.#renderLogEntry(logEntry);
                });
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤
                this.container.scrollTop = this.container.scrollHeight;
            }
        } catch (error) {
            console.error("LogSection: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤:", error);
            // –î–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
            this.#showPlaceholder();
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ UI
            this.addLog({ message: `‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞: ${error.message}`, level: 'error' });
        }
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π, —É—á–∏—Ç—ã–≤–∞—è –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {Object} logEntry - –û–±—ä–µ–∫—Ç –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞.
     * @param {string} logEntry.message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
     * @param {string} logEntry.level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞ ('info', 'success', 'warn', 'error').
     * @param {number} logEntry.timestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞.
     */
    addLog({ message, level = 'info', timestamp = Date.now() }) {
        // –£–¥–∞–ª—è–µ–º placeholder, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const placeholder = this.container.querySelector('.log-placeholder');
        if (placeholder) {
            placeholder.remove();
        }

        const entry = document.createElement('div');
        entry.className = `log-entry log-level-${level}`;
        const time = new Date(timestamp).toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;

        // --- –õ–æ–≥–∏–∫–∞ —É–º–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ---
        const container = this.container;
        const isScrolledToBottom = (container.scrollHeight - container.clientHeight) <= (container.scrollTop + 1);
        container.appendChild(entry);
        if (isScrolledToBottom) {
            container.scrollTop = container.scrollHeight;
        }
        // ---
    }

    /**
     * –û—á–∏—â–∞–µ—Ç –∂—É—Ä–Ω–∞–ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder.
     */
    clear() {
        this.container.innerHTML = '';
        this.#showPlaceholder();
        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç –æ—á–∏—Å—Ç–∫–∏
        // this.addLog({ message: 'üßπ –ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', level: 'info' });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---

    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder "–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç".
     */
    #showPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'log-placeholder';
        placeholder.textContent = '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç';
        this.container.appendChild(placeholder);
    }

    /**
     * –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –±–µ–∑ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤.
     * @private
     */
    #renderLogEntry({ message, level = 'info', timestamp = Date.now() }) {
        // Placeholder —É–¥–∞–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å—å—é
        const placeholder = this.container.querySelector('.log-placeholder');
        if (placeholder) {
            placeholder.remove();
        }

        const entry = document.createElement('div');
        entry.className = `log-entry log-level-${level}`;
        const time = new Date(timestamp).toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;
        this.container.appendChild(entry);
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–¥–µ—Å—å
    }

}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\LogSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\SettingsSection.js ===

export class SettingsSection {
    constructor() {
        this.element = document.getElementById('settingsSection');
        this.toggleBtn = document.getElementById('toggleSettingsBtn');
        this.selectionModeRadios = document.querySelectorAll('input[name="selectionMode"]');
        this.iterationsInput = document.getElementById('iterationsInput');
        // üëá –ù–û–í–û–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ input –∏ –∫–Ω–æ–ø–∫—É
        this.importFileInput = document.getElementById('importFileInput');
        this.importDataBtn = document.getElementById('importDataBtn');
        this.clearImportedBtn = document.getElementById('clearImportedBtn');

        // üëá –ù–û–í–û–ï: –í—Ä–µ–º–µ–Ω–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Ñ–∞–π–ª–∞
        this.pendingFileContent = null;
        this.pendingFileName = null;

        this.init();
    }

    init() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage
        this.restoreState();
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        this.toggleBtn.addEventListener('click', () => this.toggle());
        this.selectionModeRadios.forEach(radio => {
            radio.addEventListener('change', () => this.saveState());
        });
        this.iterationsInput.addEventListener('change', () => this.saveState());
        // üëá –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        this.importFileInput.addEventListener('change', (event) => this.handleFileSelected(event));
        // üëá –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∏–º–ø–æ—Ä—Ç–∞ ‚Äî –∑–∞–ø—É—Å–∫–∞–µ—Ç –∏–º–ø–æ—Ä—Ç
        this.importDataBtn.addEventListener('click', () => this.handleImport());
        this.clearImportedBtn.addEventListener('click', () => this.handleClearImported());
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        this.iterationsInput.addEventListener('blur', () => this.saveState());
    }

    toggle() {
        const isCollapsed = this.element.classList.contains('collapsed');
        if (isCollapsed) {
            this.expand();
        } else {
            this.collapse();
        }
        this.saveState();
    }

    collapse() {
        this.element.classList.add('collapsed');
        this.toggleBtn.textContent = 'üîΩ';
    }

    expand() {
        this.element.classList.remove('collapsed');
        this.toggleBtn.textContent = '‚ñ≤';
    }

    saveState() {
        const state = {
            isCollapsed: this.element.classList.contains('collapsed'),
            selectionMode: document.querySelector('input[name="selectionMode"]:checked')?.value || 'smart',
            iterations: this.iterationsInput.value,
        };
        localStorage.setItem('settingsState', JSON.stringify(state));
    }

    restoreState() {
        const saved = localStorage.getItem('settingsState');
        if (saved) {
            const state = JSON.parse(saved);
            if (state.isCollapsed) {
                this.collapse();
            } else {
                this.expand();
            }
            if (state.selectionMode) {
                const radio = document.querySelector(`input[name="selectionMode"][value="${state.selectionMode}"]`);
                if (radio) radio.checked = true;
            }
            if (state.iterations) {
                this.iterationsInput.value = state.iterations;
            }
        }
    }

    // üëá –ù–û–í–û–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞ ‚Äî —á–∏—Ç–∞–µ—Ç —Ñ–∞–π–ª, –Ω–æ –ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç
    handleFileSelected(event) {
        const file = event.target.files[0];
        if (!file) {
            this.dispatchEvent('log', { message: '‚ùå –§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω', level: 'error' });
            return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if (!file.name.endsWith('.csv') && !file.name.endsWith('.tsv') && file.type !== 'text/csv' && file.type !== 'text/tsv') {
            this.dispatchEvent('log', { message: '‚ùå –ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞. –í—ã–±–µ—Ä–∏—Ç–µ .csv –∏–ª–∏ .tsv', level: 'error' });
            this.importFileInput.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
            this.pendingFileContent = e.target.result;
            this.pendingFileName = file.name;
            this.dispatchEvent('log', { message: `‚úÖ –§–∞–π–ª "${file.name}" –≤—ã–±—Ä–∞–Ω. –ù–∞–∂–º–∏—Ç–µ "–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª" –¥–ª—è –Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∫–∏.`, level: 'success' });
        };
        reader.onerror = () => {
            this.dispatchEvent('log', { message: `‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞: ${file.name}`, level: 'error' });
            this.importFileInput.value = '';
        };
        reader.readAsText(file);
    }

    // üëá –û–ë–ù–û–í–õ–ï–ù–ù–´–ô: –ò–º–ø–æ—Ä—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–Ω–æ–ø–∫–∏
    handleImport() {
        // –ü—Ä–æ—Å—Ç–æ —Ç—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ. –†–µ–∞–ª—å–Ω—É—é –ª–æ–≥–∏–∫—É –≤—ã–ø–æ–ª–Ω–∏—Ç PopupApp.
        this.dispatchEvent('requestImportFromFile');
    }

    // üëá –ù–û–í–û–ï: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å —á–∞–Ω–∫–∞–º–∏
    async parseCSVAsync(text, fileName) {
        const lines = text.split(/\r?\n/).filter(line => line.trim() !== '');
        if (lines.length === 0) throw new Error('–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª');

        let delimiter = ';';
        if (lines[0].includes('\t')) delimiter = '\t';
        else if (lines[0].includes(',')) delimiter = ',';

        const headers = this.#parseCsvLine(lines[0], delimiter);
        const required = ['–Ω–∞–∑–≤–∞–Ω–∏–µ', 'id', '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã', '–∫–∞–Ω–∞–ª', '–∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ', '–º–∏–Ω–∏–∞—Ç—é—Ä–∞'];
        const fieldMap = {
            '–Ω–∞–∑–≤–∞–Ω–∏–µ': 'title',
            'id': 'videoId',
            '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã': 'views',
            '–∫–∞–Ω–∞–ª': 'channelName',
            '–∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ': 'sourceVideoId',
            '–º–∏–Ω–∏–∞—Ç—é—Ä–∞': 'thumbnailUrl'
        };

        const indices = {};
        required.forEach(field => {
            const index = headers.findIndex(h => h.trim().toLowerCase() === field);
            if (index === -1) throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: ${field}`);
            indices[field] = index;
        });

        const data = [];
        const totalLines = lines.length - 1; // –º–∏–Ω—É—Å –∑–∞–≥–æ–ª–æ–≤–æ–∫
        let processedLines = 0;

        // üëá –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, —á–∞–Ω–∫–∞–º–∏ –ø–æ 5000
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            const cells = this.#parseCsvLine(line, delimiter);
            if (cells.length < required.length) continue;

            const item = {};
            required.forEach(field => {
                const index = indices[field];
                item[fieldMap[field]] = cells[index] ? cells[index] : '';
            });
            data.push(item);

            processedLines++;

            // –ö–∞–∂–¥—ã–µ 5000 —Å—Ç—Ä–æ–∫ ‚Äî –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            if (processedLines % 5000 === 0) {
                this.dispatchEvent('log', {
                    message: `üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedLines} –∏–∑ ${totalLines} —Å—Ç—Ä–æ–∫ —Ñ–∞–π–ª–∞ "${fileName}"...`,
                    level: 'info'
                });
                // üëá –û—Ç–¥–∞–µ–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä—É, —á—Ç–æ–±—ã UI –Ω–µ –∑–∞–≤–∏—Å–∞–ª
                await new Promise(resolve => setTimeout(resolve, 0));
            }
        }

        this.dispatchEvent('log', {
            message: `‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —Ñ–∞–π–ª–∞ "${fileName}" –∑–∞–≤–µ—Ä—à–µ–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${processedLines} —Å—Ç—Ä–æ–∫.`,
            level: 'success'
        });

        return data;
    }

    // üëá –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    #parseCsvLine(line, delimiter) {
        const values = [];
        let currentValue = '';
        let insideQuotes = false;
        let i = 0;
        while (i < line.length) {
            const char = line[i];
            if (char === '"') {
                if (insideQuotes && i + 1 < line.length && line[i + 1] === '"') {
                    currentValue += '"';
                    i += 2;
                } else {
                    insideQuotes = !insideQuotes;
                    i++;
                }
            } else if (char === delimiter && !insideQuotes) {
                values.push(currentValue.trim());
                currentValue = '';
                i++;
            } else {
                currentValue += char;
                i++;
            }
        }
        values.push(currentValue.trim());
        return values;
    }

    async handleClearImported() {
        console.log("[SettingsSection] –ù–∞—á–∞–ª–æ handleClearImported");
        this.dispatchEvent('log', { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', level: 'info' });
        try {
            const response = await chrome.runtime.sendMessage({
                action: "clearImportedTableData"
            });
            if (response && response.status === "success") {
                console.log("[SettingsSection] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã –≤ background");
                this.dispatchEvent('log', { message: '‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', level: 'success' });
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error("[SettingsSection] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤ background:", errorMsg);
                this.dispatchEvent('log', { message: `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${errorMsg}`, level: 'error' });
            }
        } catch (err) {
            console.error("[SettingsSection] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –≤ background:", err);
            this.dispatchEvent('log', { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ${err.message}`, level: 'error' });
        }
    }

    dispatchEvent(type, detail) {
        document.dispatchEvent(new CustomEvent(type, { detail }));
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\SettingsSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\TableSection.js ===

// popup/components/TableSection.js

export class TableSection {
    constructor() {
        this.tableBody = document.getElementById('tableBody');
        this.init();
    }

    init() {
        // –°–ª—É—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        document.addEventListener('updateTable', (e) => this.render(e.detail));
        document.addEventListener('clearTable', () => this.clear());
        // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        this.loadInitialData();
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
     * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) –¥–∞–Ω–Ω—ã–µ.
     */
    async loadInitialData() {
        console.log("TableSection: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ)...");
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            const response = await chrome.runtime.sendMessage({ action: "getTableFreshData" });
            const data = response?.data || [];
            console.log(`TableSection: –ü–æ–ª—É—á–µ–Ω–æ ${data.length} —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π.`);
            this.render(data);
        } catch (error) {
            console.error("TableSection: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", error);
            this.clear();
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${error.message}`, level: 'error' } }));
        }
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É.
     * @param {Array<Object>} data - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–µ–æ.
     */
    render(data = []) {
        this.tableBody.innerHTML = '';
        if (data.length === 0) {
            this.#showPlaceholder();
            return;
        }

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const dataToShow = data.slice(-50); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50

        dataToShow.forEach(video => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${this.#escapeHtml(video.title || '')}</td>
                <td>${this.#escapeHtml(video.videoId || '')}</td>
                <td>${this.#escapeHtml(video.views || '')}</td>
                <td>${this.#escapeHtml(video.channelName || '')}</td>
                <td>${this.#escapeHtml(video.sourceVideoId || '')}</td>
                <td>
                    ${video.thumbnailUrl ?
                    `<img src="${video.thumbnailUrl}" alt="Thumbnail" onerror="this.parentElement.innerHTML='‚Äî'">` :
                    '‚Äî'}
                </td>
            `;
            this.tableBody.appendChild(row);
        });
    }

    /**
     * –û—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder.
     */
    clear() {
        this.tableBody.innerHTML = '';
        this.#showPlaceholder();
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---

    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder "–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞".
     * @private
     */
    #showPlaceholder() {
        const placeholderRow = document.createElement('tr');
        placeholderRow.className = 'table-placeholder';
        placeholderRow.innerHTML = `<td colspan="6">–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞</td>`;
        this.tableBody.appendChild(placeholderRow);
    }

    /**
     * –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML-—Å—É—â–Ω–æ—Å—Ç–∏.
     * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
     * @returns {string} - –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
     * @private
     */
    #escapeHtml(text) {
        if (typeof text !== 'string') return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\TableSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\parse-recommendation.js ===

// scenarios/parse-recommendation.js
import { scrollPageNTimes } from '../core/utils/scroller.js';
import { parseAndHighlight, removeParserHighlights } from '../core/utils/parser.js';
import { addScrapedData as updateIndexManager } from '../core/index-manager.js';
import { logger } from '../background/background.js';
import { tableAdapter } from '../background/background.js';
import { getUnavailableVideoIds, addUnavailableVideoIds } from '../core/utils/blacklist.js';
import { selectNextVideo, isLikelyRussian } from '../core/utils/video-selector.js';
import { getStateSnapshot } from '../core/index-manager.js';
import { navigateToVideo } from '../core/utils/navigator.js';
import { calculateNewChannelsInIteration, calculateRussianChannelRatio, updateRussianChannelMetric } from '../core/utils/metrics.js'; // <-- –ù–û–í–´–ô –ò–ú–ü–û–†–¢


/**
 * @type {import('../core/types/scenario.types.js').ScenarioDefinition}
 */
export const parseRecommendationScenario = {
    id: 'parse-recommendation',
    name: '–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π',
    description: '–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏, –ø–∞—Ä—Å–∏—Ç –≤–∏–¥–µ–æ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É.',

    /**
     * @param {import('../core/types/scenario.types.js').ScenarioContext} context
     */
    async execute(context) {
        const { log, params = {}, tabId, abortSignal } = context;
        console.log("[ParseRecommendation] –ù–∞—á–∞–ª–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, context:", { params, tabId });

        // --- –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ---
        const totalRequestedIterations = parseInt(params.iterations, 10) || 1;
        const scrollParams = {
            count: parseInt(params.count, 10) || 16,
            delayMs: parseInt(params.delayMs, 10) || 1500,
            step: parseInt(params.step, 10) || 1000
        };
        const selectionModeInternal = params.mode || 'all_videos';
        const maxRetriesPerIteration = 3; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ –Ω–∞ –æ–¥–Ω—É –∏—Ç–µ—Ä–∞—Ü–∏—é

        log(`üöÄ –°—Ü–µ–Ω–∞—Ä–∏–π "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π" –∑–∞–ø—É—â–µ–Ω.`, { module: 'ParseRecommendation' });
        log(`üî¢ –ó–∞–ø—Ä–æ—à–µ–Ω–æ –∏—Ç–µ—Ä–∞—Ü–∏–π: ${totalRequestedIterations}`, { module: 'ParseRecommendation' });
        log(`üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞: ${JSON.stringify(scrollParams)}`, { module: 'ParseRecommendation' });
        log(`üß† –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ: ${selectionModeInternal}`, { module: 'ParseRecommendation' });

        let successfulTransitions = 0; // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ—Ö–æ–¥—ã
        let noTransitionStreak = 0; // –°—á–µ—Ç—á–∏–∫ –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞
        const maxNoTransitionStreak = 3; // –ú–∞–∫—Å–∏–º—É–º –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –¥–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏

        // --- –¶–∏–∫–ª –∏—Ç–µ—Ä–∞—Ü–∏–π ---
        // –ò—Ç–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç—Å—è, –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ totalRequestedIterations –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
        // –∏–ª–∏ –Ω–µ –∏—Å—á–µ—Ä–ø–∞–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞
        while (successfulTransitions < totalRequestedIterations && noTransitionStreak < maxNoTransitionStreak) {

            const currentIterationNumber = successfulTransitions + 1;
            log(`üîÑ === –ù–ê–ß–ê–õ–û –ò–¢–ï–†–ê–¶–ò–ò ${currentIterationNumber}/${totalRequestedIterations} (–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ ${successfulTransitions + 1}) ===`, { module: 'ParseRecommendation' });

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∏—Ç–µ—Ä–∞—Ü–∏–∏
            try {
                await abortSignal();
            } catch (abortErr) {
                log(`‚èπÔ∏è –°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º. –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: ${successfulTransitions}/${totalRequestedIterations}.`, { module: 'ParseRecommendation', level: 'warn' });
                return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –≤–µ—Å—å —Å—Ü–µ–Ω–∞—Ä–∏–π
            }

            let attempt = 1;
            let iterationCompletedWithTransition = false; // –§–ª–∞–≥ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ —ç—Ç–æ–π "–ø–æ–ø—ã—Ç–∫–µ" –∏—Ç–µ—Ä–∞—Ü–∏–∏

            // --- –¶–∏–∫–ª –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è —Ç–µ–∫—É—â–µ–π "–ª–æ–≥–∏—á–µ—Å–∫–æ–π" –∏—Ç–µ—Ä–∞—Ü–∏–∏ ---
            while (attempt <= maxRetriesPerIteration && !iterationCompletedWithTransition) {
                log(`üîÅ –ü–æ–ø—ã—Ç–∫–∞ ${attempt}/${maxRetriesPerIteration} –¥–ª—è –∏—Ç–µ—Ä–∞—Ü–∏–∏ ${currentIterationNumber}...`, { module: 'ParseRecommendation' });

                try {
                    // --- 0. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ ---
                    log(`üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ...`, { module: 'ParseRecommendation' });
                    let isCurrentVideoAvailable = true;
                    let currentVideoIdForCheck = 'unknown_current_video';

                    if (typeof tabId === 'number' && tabId > 0) {
                        try {
                            const tab = await chrome.tabs.get(tabId);
                            const url = new URL(tab.url);
                            currentVideoIdForCheck = url.searchParams.get('v') || 'unknown_video_id_from_url';

                            const checkResponse = await chrome.tabs.sendMessage(tabId, {
                                action: "checkVideoAvailability"
                            });

                            if (checkResponse && checkResponse.status === "success") {
                                isCurrentVideoAvailable = checkResponse.isAvailable;
                                log(`üîí –†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–ª—è ${currentVideoIdForCheck}: ${isCurrentVideoAvailable ? '–î–æ—Å—Ç—É–ø–Ω–æ' : '–ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ'}`, { module: 'ParseRecommendation', level: isCurrentVideoAvailable ? 'info' : 'warn' });
                            } else {
                                const checkErrorMsg = checkResponse?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏";
                                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: ${checkErrorMsg}`, { module: 'ParseRecommendation', level: 'warn' });
                            }
                        } catch (urlOrCheckErr) {
                            log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏: ${urlOrCheckErr.message}`, { module: 'ParseRecommendation', level: 'warn' });
                        }
                    }

                    if (!isCurrentVideoAvailable) {
                        log(`üîí –¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ (${currentVideoIdForCheck}) –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ. –î–æ–±–∞–≤–ª—è–µ–º –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∏ –∑–∞–≤–µ—Ä—à–∞–µ–º –∏—Ç–µ—Ä–∞—Ü–∏—é.`, { module: 'ParseRecommendation', level: 'error' });
                        await addUnavailableVideoIds(currentVideoIdForCheck);
                        // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –¥–ª—è —ç—Ç–æ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏, –Ω–µ —É–≤–µ–ª–∏—á–∏–≤–∞—è successfulTransitions
                        break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ while(attempt...), —á—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –ø–µ—Ä–µ—Ö–æ–¥—É –∫ —Å–ª–µ–¥—É—é—â–µ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                    }

                    // --- 1. –°–∫—Ä–æ–ª–ª–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
                    log(`üîÑ –í—ã–∑–æ–≤ scrollPageNTimes...`, { module: 'ParseRecommendation' });
                    await scrollPageNTimes(context, scrollParams.count, scrollParams.delayMs, scrollParams.step);
                    log(`‚úÖ scrollPageNTimes –∑–∞–≤–µ—Ä—à–µ–Ω.`, { module: 'ParseRecommendation' });

                    // --- 2. –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ ---
                    await removeParserHighlights(context);
                    const parseResult = await parseAndHighlight(context);
                    const highlightedCount = parseResult.highlightedCount;
                    const scrapedData = parseResult.scrapedData || [];

                    log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–æ ${highlightedCount} –≤–∏–¥–µ–æ.`, { module: 'ParseRecommendation' });
                    log(`üìÑ –ü–æ–ª—É—á–µ–Ω–æ HTML-–∫–æ–¥–æ–≤ –∫–∞—Ä—Ç–æ—á–µ–∫: ${scrapedData?.length || 0}`, { module: 'ParseRecommendation' });

                    // --- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –∏—Ç–µ—Ä–∞—Ü–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É—Å–ø–µ—à–Ω–æ–π ---
                    if (scrapedData.length === 0) {
                        log(`üõë –ü–∞—Ä—Å–∏–Ω–≥ –Ω–µ –Ω–∞—à–µ–ª –¥–∞–Ω–Ω—ã—Ö. –ò—Ç–µ—Ä–∞—Ü–∏—è ${currentIterationNumber} –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞.`, { module: 'ParseRecommendation', level: 'warn' });
                        // –ù–µ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º successfulTransitions, –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º noTransitionStreak, —Ç–∞–∫ –∫–∞–∫ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–µ –±—ã–ª–æ
                        // –ü—Ä–æ—Å—Ç–æ –∑–∞–≤–µ—Ä—à–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
                        break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ while(attempt...)
                    }

                    // –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫–∏ –ø–æ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–∞–Ω–∞–ª–æ–≤
                    log(`üìä –†–∞—Å—á–µ—Ç –º–µ—Ç—Ä–∏–∫ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤...`, { module: 'ParseRecommendation' });
                    const indexSnapshot = getStateSnapshot();
                    const metricsResult = calculateNewChannelsInIteration(scrapedData, indexSnapshot.channelVideoCounts, log);

                    log(`üìà –ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ –≤ —ç—Ç–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏: ${metricsResult.newChannelCount}`, { module: 'ParseRecommendation', level: metricsResult.newChannelCount > 0 ? 'success' : 'info' });
                    if (metricsResult.newChannelCount > 0) {
                        log(`üá∑üá∫ –ê–Ω–∞–ª–∏–∑ "—Ä—É—Å—Å–∫–æ—Å—Ç–∏" –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤ (–ø–µ—Ä–≤–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è)...`, { module: 'ParseRecommendation' });
                        try {
                            // üëá –ü–ï–†–ï–î–ê–ï–ú –¢–û–õ–¨–ö–û newChannelNames –∏ scrapedData
                            const russianMetrics = calculateRussianChannelRatio(
                                metricsResult.newChannelNames,
                                scrapedData, // <-- –¢–æ–ª—å–∫–æ —Ç–µ–∫—É—â–∞—è –∏—Ç–µ—Ä–∞—Ü–∏—è
                                log // <-- –õ–æ–≥–≥–µ—Ä
                            );
                            log(`üá∑üá∫ –°—Ä–µ–¥–∏ ${russianMetrics.totalChannels} –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤, —Ä—É—Å—Å–∫–∏–º–∏ —è–≤–ª—è—é—Ç—Å—è ${russianMetrics.russianChannelCount} (${russianMetrics.ratio}%).`, { module: 'ParseRecommendation', level: 'success' });
                            updateRussianChannelMetric(russianMetrics.russianChannelCount, log);
                            if (russianMetrics.russianChannelList.length > 0) {
                                log(`üá∑üá∫ –°–ø–∏—Å–æ–∫ —Ä—É—Å—Å–∫–∏—Ö –∫–∞–Ω–∞–ª–æ–≤: ${russianMetrics.russianChannelList.join(', ')}`, { module: 'ParseRecommendation' });
                            }
                        } catch (russianErr) {
                            log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä—É—Å—Å–∫–æ—Å—Ç–∏ –∫–∞–Ω–∞–ª–æ–≤: ${russianErr.message}`, { module: 'ParseRecommendation', level: 'warn' });
                        }
                    }
                    else {
                        updateRussianChannelMetric(0, log);
                    }


                    // --- 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ IndexManager ---
                    log(`üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ IndexManager –¥–∞–Ω–Ω—ã–º–∏ –ø–æ ${scrapedData.length} –≤–∏–¥–µ–æ...`, { module: 'ParseRecommendation' });
                    try {
                        updateIndexManager(scrapedData);
                        log(`‚úÖ –ò–Ω–¥–µ–∫—Å—ã IndexManager —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.`, { module: 'ParseRecommendation' });
                    } catch (indexUpdateErr) {
                        log(`‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤ IndexManager: ${indexUpdateErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                    }



                    // --- 4. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É ---
                    log(`üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ${scrapedData.length} –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É...`, { module: 'ParseRecommendation' });
                    try {
                        const dataToSave = scrapedData.map(item => ({
                            ...item,
                            timestamp: item.timestamp || Date.now()
                        }));

                        if (typeof tableAdapter.addBatch === 'function') {
                            await tableAdapter.addBatch(dataToSave);
                            log(`‚úÖ ${dataToSave.length} –∑–∞–ø–∏—Å–µ–π —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É.`, { module: 'ParseRecommendation' });
                        } else if (typeof tableAdapter.add === 'function') {
                            log(`‚ö†Ô∏è tableAdapter.addBatch –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏...`, { module: 'ParseRecommendation', level: 'warn' });
                            let savedCount = 0;
                            for (const item of dataToSave) {
                                try {
                                    await tableAdapter.add(item);
                                    savedCount++;
                                } catch (addItemErr) {
                                    log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏: ${addItemErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                                }
                            }
                            log(`‚úÖ ${savedCount}/${dataToSave.length} –∑–∞–ø–∏—Å–µ–π —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É (–ø–æ –æ–¥–Ω–æ–π).`, { module: 'ParseRecommendation' });
                        } else {
                            throw new Error("–ê–¥–∞–ø—Ç–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ç–æ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è (add/addBatch)");
                        }
                    } catch (saveErr) {
                        log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É: ${saveErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                    }

                    // --- 5. –í—ã–±–æ—Ä —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ ---
                    let nextVideoId = null;
                    log(`ü§î –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ...`, { module: 'ParseRecommendation' });

                    // –ü–æ–ª—É—á–∞–µ–º ID —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ (–∏—Å—Ç–æ—á–Ω–∏–∫–∞)
                    let currentSourceVideoId = 'unknown_source';
                    if (typeof tabId === 'number' && tabId > 0) {
                        try {
                            const tab = await chrome.tabs.get(tabId);
                            const url = new URL(tab.url);
                            currentSourceVideoId = url.searchParams.get('v') || 'unknown_source_from_url';
                        } catch (urlErr) {
                            log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ videoId –∏–∑ URL: ${urlErr.message}`, { module: 'ParseRecommendation', level: 'warn' });
                        }
                    }
                    log(`üìç –¢–µ–∫—É—â–µ–µ –≤–∏–¥–µ–æ (–∏—Å—Ç–æ—á–Ω–∏–∫): ${currentSourceVideoId}`, { module: 'ParseRecommendation' });

                    // –ü–æ–ª—É—á–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ IndexManager
                    // const indexSnapshot = getStateSnapshot();
                    const dependencies = {
                        visitedSourceVideoIds: indexSnapshot.visitedVideoIds,
                        channelVideoCounts: indexSnapshot.channelVideoCounts,
                        channelToVideoIds: indexSnapshot.channelToVideoIds
                    };

                    // –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏ –≤ —Å–ª—É—á–∞–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ
                    let selectionAttempt = 1;
                    const maxSelectionRetries = 5; // –õ–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –≤—ã–±–æ—Ä–∞, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ
                    let selectionSuccessful = false;

                    while (selectionAttempt <= maxSelectionRetries && !selectionSuccessful) {
                        log(`üîç –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ ${selectionAttempt}/${maxSelectionRetries}...`, { module: 'ParseRecommendation' });

                        try {
                            const tempNextVideoId = await selectNextVideo(
                                dependencies,
                                currentSourceVideoId,
                                selectionModeInternal,
                                scrapedData,
                                context
                            );

                            if (!tempNextVideoId) {
                                log(`‚ö†Ô∏è selectNextVideo –Ω–µ –≤–µ—Ä–Ω—É–ª ID –≤–∏–¥–µ–æ.`, { module: 'ParseRecommendation', level: 'warn' });
                                break; // –ù–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤, –≤—ã—Ö–æ–¥–∏–º –∏–∑ —Ü–∏–∫–ª–∞ –≤—ã–±–æ—Ä–∞
                            }

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ
                            const unavailableIds = await getUnavailableVideoIds();
                            if (unavailableIds.has(tempNextVideoId)) {
                                log(`‚ö†Ô∏è –í—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ ${tempNextVideoId} –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ. –ü–æ–≤—Ç–æ—Ä—è–µ–º –≤—ã–±–æ—Ä.`, { module: 'ParseRecommendation', level: 'warn' });
                                selectionAttempt++;
                                if (selectionAttempt > maxSelectionRetries) {
                                    log(`‚ùå –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫ –≤—ã–±–æ—Ä–∞. –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ–µ –≤–∏–¥–µ–æ.`, { module: 'ParseRecommendation', level: 'error' });
                                }
                                continue; // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª –≤—ã–±–æ—Ä–∞
                            }

                            // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –¥–æ—Å—Ç—É–ø–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
                            nextVideoId = tempNextVideoId;
                            selectionSuccessful = true;
                            log(`üéâ –í—ã–±—Ä–∞–Ω–æ —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞: ${nextVideoId}`, { module: 'ParseRecommendation', level: 'success' });

                        } catch (selectErr) {
                            log(`‚ùå –û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ: ${selectErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                            break; // –ü—Ä–µ—Ä—ã–≤–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –≤—ã–±–æ—Ä–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                        }
                    }

                    if (!nextVideoId) {
                        log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–±—Ä–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ –ø–æ—Å–ª–µ ${maxSelectionRetries} –ø–æ–ø—ã—Ç–æ–∫.`, { module: 'ParseRecommendation', level: 'warn' });
                        // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏
                        break; // –í—ã—Ö–æ–¥–∏–º –∏–∑ while(attempt...)
                    }

                    // --- 6. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ ---
                    log(`üß≠ –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–∏–¥–µ–æ: ${nextVideoId}...`, { module: 'ParseRecommendation' });
                    try {
                        await navigateToVideo(context, nextVideoId);
                        log(`‚úÖ –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –≤–∏–¥–µ–æ ${nextVideoId} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞.`, { module: 'ParseRecommendation', level: 'success' });

                        // --- 7. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
                        log(`‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã...`, { module: 'ParseRecommendation' });
                        // --- –ù–û–í–û–ï: –£–º–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ ---
                        let pageLoaded = false;
                        const maxWaitTime = 5000; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è 15 —Å–µ–∫—É–Ω–¥
                        const checkInterval = 500; // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 500 –º—Å
                        const maxChecks = maxWaitTime / checkInterval;
                        let checks = 0;

                        while (checks < maxChecks && !pageLoaded) {
                            checks++;
                            log(`‚è≥ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ${checks}/${maxChecks}...`, { module: 'ParseRecommendation' });
                            try {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ YouTube
                                const checkResult = await chrome.tabs.sendMessage(tabId, {
                                    action: "checkPageLoaded"
                                });

                                if (checkResult && checkResult.status === "success" && checkResult.isLoaded) {
                                    pageLoaded = true;
                                    log(`‚úÖ –ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ ${checks}).`, { module: 'ParseRecommendation' });
                                } else {
                                    log(`‚è≥ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞ (–ø—Ä–æ–≤–µ—Ä–∫–∞ ${checks}).`, { module: 'ParseRecommendation' });
                                }
                            } catch (checkErr) {
                                log(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ ${checks}): ${checkErr.message}`, { module: 'ParseRecommendation', level: 'warn' });
                                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
                            }

                            if (!pageLoaded && checks < maxChecks) {
                                await new Promise(resolve => setTimeout(resolve, checkInterval));
                            }
                        }

                        if (!pageLoaded) {
                            log(`‚ö†Ô∏è –°—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å –∑–∞ ${maxWaitTime}–º—Å. –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π.`, { module: 'ParseRecommendation', level: 'warn' });
                        }
                        // --- –ö–æ–Ω–µ—Ü —É–º–Ω–æ–≥–æ –æ–∂–∏–¥–∞–Ω–∏—è ---

                        iterationCompletedWithTransition = true; // –ò—Ç–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º
                        successfulTransitions++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
                        noTransitionStreak = 0; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ "–±–µ–∑–¥–µ–π—Å—Ç–≤–∏—è"

                    } catch (navErr) {
                        log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ—Ö–æ–¥–∞ –Ω–∞ –≤–∏–¥–µ–æ ${nextVideoId}: ${navErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                        // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–µ —É–¥–∞–ª—Å—è, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞ (—Å–ª–µ–¥—É—é—â–∞—è –ø–æ–ø—ã—Ç–∫–∞)
                    }

                } catch (iterationErr) {
                    log(`‚ùå –û—à–∏–±–∫–∞ –≤ –∏—Ç–µ—Ä–∞—Ü–∏–∏ ${currentIterationNumber} (–ø–æ–ø—ã—Ç–∫–∞ ${attempt}): ${iterationErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                    console.error("[ParseRecommendation] Stack trace –æ—à–∏–±–∫–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏:", iterationErr);

                    if (attempt < maxRetriesPerIteration) {
                        log(`üîÅ –ü–æ–ø—ã—Ç–∫–∞ ${attempt} –Ω–µ —É–¥–∞–ª–∞—Å—å. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∏ –ø–æ–≤—Ç–æ—Ä...`, { module: 'ParseRecommendation', level: 'warn' });
                        try {
                            if (typeof tabId === 'number' && tabId > 0) {
                                await chrome.tabs.reload(tabId);
                                log(`üîÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω–∞. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏...`, { module: 'ParseRecommendation', level: 'info' });
                                // –ü–∞—É–∑–∞ –ø–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                                await new Promise(resolve => setTimeout(resolve, 3000));
                            }
                        } catch (reloadErr) {
                            log(`‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${reloadErr.message}`, { module: 'ParseRecommendation', level: 'error' });
                        }
                    } else {
                        log(`‚ùå –í—Å–µ ${maxRetriesPerIteration} –ø–æ–ø—ã—Ç–∫–∏ –∏—Ç–µ—Ä–∞—Ü–∏–∏ ${currentIterationNumber} –Ω–µ —É–¥–∞–ª–∏—Å—å.`, { module: 'ParseRecommendation', level: 'error' });
                    }
                    attempt++;
                }
            } // –ö–æ–Ω–µ—Ü —Ü–∏–∫–ª–∞ –ø–æ–ø—ã—Ç–æ–∫ –¥–ª—è –ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏

            if (!iterationCompletedWithTransition) {
                log(`‚ùå –ò—Ç–µ—Ä–∞—Ü–∏—è ${currentIterationNumber} –Ω–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ ${maxRetriesPerIteration} –ø–æ–ø—ã—Ç–æ–∫ –∏–ª–∏ –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –¥–∞–Ω–Ω—ã—Ö.`, { module: 'ParseRecommendation', level: 'error' });
                noTransitionStreak++; // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –Ω–µ—É–¥–∞—á
                if (noTransitionStreak >= maxNoTransitionStreak) {
                    log(`‚õî –î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç (${maxNoTransitionStreak}) –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, { module: 'ParseRecommendation', level: 'error' });
                    throw new Error(`–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∏—Ç–µ—Ä–∞—Ü–∏–π –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ (${maxNoTransitionStreak}).`);
                }
                // –ï—Å–ª–∏ –Ω–µ –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ª–æ–≥–∏—á–µ—Å–∫–æ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏
            } else {
                log(`‚úÖ === –ò–¢–ï–†–ê–¶–ò–Ø ${currentIterationNumber} –ó–ê–í–ï–†–®–ï–ù–ê –° –ü–ï–†–ï–•–û–î–û–ú ===`, { module: 'ParseRecommendation', level: 'success' });
            }

        } // –ö–æ–Ω–µ—Ü –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ –∏—Ç–µ—Ä–∞—Ü–∏–π

        log(`üéâ –°—Ü–µ–Ω–∞—Ä–∏–π "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π" –∑–∞–≤–µ—Ä—à—ë–Ω. –í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–æ–≤: ${successfulTransitions}/${totalRequestedIterations}.`, { module: 'ParseRecommendation', level: 'success' });
    }
};

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\parse-recommendation.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\test-countdown.js ===

// scenarios/test-countdown.js
import { logger } from '../background/background.js';
import { tableAdapter } from '../background/background.js';

// --- –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä—å –º–æ–¥—É–ª—è ---
/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã.
 * @param {number} length
 * @returns {string}
 */
function generateRandomString(length) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
 * @returns {string}
 */
function generateRandomViews() {
    const num = Math.floor(Math.random() * 1000000);
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toString();
}
// --- –ö–æ–Ω–µ—Ü –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π ---

/**
 * @type {import('../core/types/scenario.types.js').ScenarioDefinition}
 */
export const testCountdownScenario = {
    id: 'test-countdown',
    name: '–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç',
    description: '–°—á–∏—Ç–∞–µ—Ç –æ—Ç 1 –¥–æ N, –≥–¥–µ N - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º.',

    /**
     * @param {import('../core/types/scenario.types.js').ScenarioContext} context
     */
    async execute(context) {
        // 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const { log, abortSignal, params = {} } = context;

        // 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        // –í–ê–ñ–ù–û: –∫–ª—é—á–∏ params –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ popup/background
        const maxCount = parseInt(params.iterations, 10) || 10;
        // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è mode –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ª–æ–≥–æ–≤
        let selectionModeLabel = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º';
        if (params.mode === 'all_videos') {
            selectionModeLabel = '–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –≤–∏–¥–µ–æ';
        } else if (params.mode === 'current_recommendations') {
            selectionModeLabel = '–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥–±–æ—Ä–∫–∏';
        }
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ mode –¥–ª—è –ª–æ–≥–∏–∫–∏ (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ –±—É–¥—É—â–µ–º)
        const mode = params.mode || 'all_videos';
        const sourceVideoId = 'test_source_video_id'; // –î–ª—è —Ç–µ—Å—Ç–∞

        // 3. –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)
        log(`üöÄ –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω.`, { module: 'TestScenario' });
        log(`üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤: ${maxCount}`, { module: 'TestScenario' });
        log(`üß† –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞: ${selectionModeLabel}`, { module: 'TestScenario' });
        // 4. –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
        for (let i = 1; i <= maxCount; i++) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            await abortSignal();

            log(`‚è±Ô∏è –®–∞–≥ ${i}/${maxCount}`, { module: 'TestScenario' });

            // --- –ó–∞–ø–∏—Å—å —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É ---
            try {
                const randomVideoData = {
                    videoId: `test_video_${generateRandomString(8)}`,
                    title: `–¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ ${i}: ${generateRandomString(15)}`,
                    channelName: `–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª ${generateRandomString(5)}`,
                    views: generateRandomViews(),
                    sourceVideoId: sourceVideoId,
                    thumbnailUrl: `https://picsum.photos/seed/${i}/120/90`, // URL –∫ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ
                    timestamp: Date.now()
                };

                await tableAdapter.add(randomVideoData);
                log(`üíæ –î–∞–Ω–Ω—ã–µ —à–∞–≥–∞ ${i} –∑–∞–ø–∏—Å–∞–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É.`, { module: 'TestScenario' });
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–∞ ${i}: ${err.message}`, { module: 'TestScenario', level: 'error' });
            }
            // --- –ö–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö ---

            // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // 5. –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ —Å–Ω–æ–≤–∞ —É–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        log(`üéâ –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.`, { module: 'TestScenario' });
        log(`üß† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º: ${selectionModeLabel}`, { module: 'TestScenario' });
        log(`üî¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ —à–∞–≥–æ–≤: ${maxCount}`, { module: 'TestScenario' });
    }
};

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\test-countdown.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\logger.js ===



=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\logger.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\storage.js ===



=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\storage.js ===

--------------------------------------------------------------------------------
