
=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\manifest.json ===

{
    "manifest_version": 3,
    "name": "YouTube –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ü–∞—Ä—Å–µ—Ä OS",
    "version": "1.0.0",
    "description": "–ù–æ–≤—ã–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ YouTube.",
    "icons": {
        "16": "icons/icon16.png"
    },
    "action": {
        "default_popup": "popup/popup.html",
        "default_icon": {
            "16": "icons/icon16.png"
        }
    },
    "background": {
        "service_worker": "background/background.js",
        "type": "module"
    },
    "content_scripts": [
        {
            "matches": [
                "*://*.youtube.com/*"
            ],
            "js": [
                "content/modules/scroller.js",
                "content/content.js"
            ],
            "run_at": "document_idle"
        }
    ],
    "permissions": [
        "activeTab",
        "scripting",
        "storage",
        "tabs"
    ],
    "host_permissions": [
        "*://*.youtube.com/*"
    ]
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\manifest.json ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageLogAdapter.js ===

// adapters/ChromeStorageLogAdapter.js
import { Logger } from '../core/logger.js'; // –î–ª—è —Ç–∏–ø–æ–≤

/**
 * @typedef {import('../core/types/log.types.js').LogEntry} LogEntry
 * @typedef {import('../core/types/log.types.js').LogAdapter} LogAdapter
 */

export class ChromeStorageLogAdapter {
    /** @type {string} */
    #storageKey;
    /** @type {number} */
    #maxSize;

    /**
     * @param {Object} options
     * @param {string} [options.storageKey='appLogs']
     * @param {number} [options.maxSize=500]
     */
    constructor(options = {}) {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å chrome.storage.local
        if (typeof chrome === 'undefined' || !chrome.storage || !chrome.storage.local) {
            throw new Error('ChromeStorageLogAdapter: chrome.storage.local is not available.');
        }

        this.#storageKey = options.storageKey ?? 'appLogs';
        this.#maxSize = options.maxSize ?? 500;
    }

    /**
     * @param {LogEntry} entry
     * @returns {Promise<void>}
     */
    async write(entry) {
        try {
            const logs = await this.read();
            logs.push(entry);
            if (logs.length > this.#maxSize) {
                logs.splice(0, logs.length - this.#maxSize);
            }
            await chrome.storage.local.set({ [this.#storageKey]: logs });
        } catch (e) {
            console.error("[ChromeStorageLogAdapter] –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏:", e);
            // –í —Ä–µ–∞–ª—å–Ω–æ–º –∞–¥–∞–ø—Ç–µ—Ä–µ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Å—ã–≤–∞—Ç—å –æ—à–∏–±–∫—É –∏–ª–∏ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏–Ω–∞—á–µ
            // throw e;
        }
    }

    /**
     * @returns {Promise<LogEntry[]>}
     */
    async read() {
        try {
            const result = await chrome.storage.local.get([this.#storageKey]);
            return result[this.#storageKey] || [];
        } catch (e) {
            console.error("[ChromeStorageLogAdapter] –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è:", e);
            return [];
        }
    }

    /**
     * @returns {Promise<void>}
     */
    async clear() {
        try {
            await chrome.storage.local.remove([this.#storageKey]);
        } catch (e) {
            console.error("[ChromeStorageLogAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:", e);
        }
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageLogAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageTableAdapter.js ===

// adapters/ChromeStorageTableAdapter.js

/**
 * @typedef {import('../core/types/table.types.js').VideoData} VideoData
 * @typedef {import('../core/types/table.types.js').TableAdapter} TableAdapter
 */

export class ChromeStorageTableAdapter {
    /** @type {string} */
    #storageKey;
    /** @type {number} */
    #maxSize;

    /**
     * @param {Object} options
     * @param {string} [options.storageKey='parsedVideos']
     * @param {number} [options.maxSize=100000]
     */
    constructor(options = {}) {
        if (typeof chrome === 'undefined' || !chrome.storage || !chrome.storage.local) {
            throw new Error('ChromeStorageTableAdapter: chrome.storage.local is not available.');
        }

        this.#storageKey = options.storageKey ?? 'parsedVideos';
        this.#maxSize = options.maxSize ?? 100000; // –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
    }

    /**
     * @param {VideoData} videoData
     * @returns {Promise<void>}
     */
    async add(videoData) {
        try {
            const allData = await this.getAll();
            allData.push(videoData);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä, —É–¥–∞–ª—è—è —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å –Ω–∞—á–∞–ª–∞
            if (allData.length > this.#maxSize) {
                allData.splice(0, allData.length - this.#maxSize);
            }

            await chrome.storage.local.set({ [this.#storageKey]: allData });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º popup'–∞–º –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            this.#broadcastDataUpdate();
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏:", e);
            throw e;
        }
    }

    /**
     * @param {VideoData[]} videoDataArray
     * @returns {Promise<void>}
     */
    async addBatch(videoDataArray) {
        if (!Array.isArray(videoDataArray) || videoDataArray.length === 0) {
            return;
        }

        try {
            const allData = await this.getAll();
            allData.push(...videoDataArray);

            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä
            if (allData.length > this.#maxSize) {
                allData.splice(0, allData.length - this.#maxSize);
            }

            await chrome.storage.local.set({ [this.#storageKey]: allData });

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
            this.#broadcastDataUpdate();
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π:", e);
            throw e;
        }
    }

    /**
     * @returns {Promise<VideoData[]>}
     */
    async getAll() {
        try {
            const result = await chrome.storage.local.get([this.#storageKey]);
            return result[this.#storageKey] || [];
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–µ–π:", e);
            return [];
        }
    }

    /**
     * @returns {Promise<void>}
     */
    async clear() {
        try {
            await chrome.storage.local.remove([this.#storageKey]);
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—á–∏—Å—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö
            this.#broadcastDataCleared();
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏:", e);
            throw e;
        }
    }

    /**
     * @returns {Promise<number>}
     */
    async getCount() {
        try {
            const data = await this.getAll();
            return data.length;
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø–∏—Å–µ–π:", e);
            return 0;
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏, –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ UI.
     * @returns {Promise<import('../core/types/table.types.js').VideoData[]>}
     */
    async getFreshData() {
        try {
            const allData = await this.getAll();
            // –§–∏–ª—å—Ç—Ä—É–µ–º, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" –∑–∞–ø–∏—Å–∏
            return allData.filter(item => !item.isImported);
        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
            return [];
        }
    }

    /**
     * –û—á–∏—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏, –ø–æ–º–µ—á–µ–Ω–Ω—ã–µ –∫–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (isImported: true).
     * @returns {Promise<void>}
     */
    async clearImported() {
        try {
            console.log("[ChromeStorageTableAdapter] –ù–∞—á–∞–ª–æ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...");
            // 1. –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            const allData = await this.getAll();
            console.log(`[ChromeStorageTableAdapter] –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π –¥–æ –æ—á–∏—Å—Ç–∫–∏: ${allData.length}`);

            // 2. –§–∏–ª—å—Ç—Ä—É–µ–º, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ –ù–ï –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            const freshData = allData.filter(item => !item.isImported);
            console.log(`[ChromeStorageTableAdapter] –û—Å—Ç–∞–Ω–µ—Ç—Å—è –∑–∞–ø–∏—Å–µ–π –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏: ${freshData.length}`);

            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            if (freshData.length > this.#maxSize) {
                freshData.splice(0, freshData.length - this.#maxSize);
            }

            await chrome.storage.local.set({ [this.#storageKey]: freshData });
            console.log("[ChromeStorageTableAdapter] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.");

            // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö, —Ç–∞–∫ –∫–∞–∫ —Å–æ—Å—Ç–∞–≤ –∏–∑–º–µ–Ω–∏–ª—Å—è
            // –≠—Ç–æ –∑–∞—Å—Ç–∞–≤–∏—Ç popup –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å "—Å–≤–µ–∂–∏–µ" –¥–∞–Ω–Ω—ã–µ
            this.#broadcastDataUpdate();

        } catch (e) {
            console.error("[ChromeStorageTableAdapter] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", e);
            throw e;
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å.
     * @private
     */
    #broadcastDataUpdate() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ type: "dataUpdated" }).catch(err => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏, –µ—Å–ª–∏ popup –∑–∞–∫—Ä—ã—Ç
                if (!chrome.runtime.lastError) {
                    console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ dataUpdated:", err);
                }
            });
        }
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.
     * @private
     */
    #broadcastDataCleared() {
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({ type: "dataCleared" }).catch(err => {
                if (!chrome.runtime.lastError) {
                    console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ dataCleared:", err);
                }
            });
        }
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ChromeStorageTableAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ConsoleLogAdapter.js ===

// adapters/ConsoleLogAdapter.js

/**
 * @typedef {import('../core/types/log.types.js').LogEntry} LogEntry
 * @typedef {import('../core/types/log.types.js').LogAdapter} LogAdapter
 */

export class ConsoleLogAdapter {
    /**
     * @param {LogEntry} entry
     * @returns {Promise<void>}
     */
    async write(entry) {
        // –õ–æ–≥–∏–∫–∞ —É–∂–µ –µ—Å—Ç—å –≤ –æ—Å–Ω–æ–≤–Ω–æ–º –∫–ª–∞—Å—Å–µ, –Ω–æ –º–æ–∂–Ω–æ –∏ –∑–¥–µ—Å—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å
        // –Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏
        // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç—ã–º, —Ç–∞–∫ –∫–∞–∫ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ Logger
    }

    /**
     * @returns {Promise<LogEntry[]>}
     */
    async read() {
        console.warn("[ConsoleLogAdapter] –ß—Ç–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –∏–∑ –∫–æ–Ω—Å–æ–ª–∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ");
        return [];
    }

    /**
     * @returns {Promise<void>}
     */
    async clear() {
        console.clear(); // –§–∏–∑–∏—á–µ—Å–∫–∏ –æ—á–∏—â–∞–µ—Ç –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\adapters\ConsoleLogAdapter.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\background\background.js ===

// background/background.js
// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –º–æ–¥—É–ª–∏
import { Logger } from '../core/logger.js';
import { ChromeStorageLogAdapter } from '../adapters/ChromeStorageLogAdapter.js';
import { ChromeStorageTableAdapter } from '../adapters/ChromeStorageTableAdapter.js';
import { ScenarioEngine } from '../core/scenario-engine.js';
import { testCountdownScenario } from '../scenarios/test-countdown.js';
import { prepareImportedDataIndices } from '../core/data-processor.js';
import { parseRecommendationScenario } from '../scenarios/parse-recommendation.js';

// --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ ---
// 1. –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ª–æ–≥–≥–µ—Ä–∞
export const logger = new Logger({
    maxSize: 1000,
    enableConsole: true,
    defaultLevel: 'info'
});

export const tableAdapter = new ChromeStorageTableAdapter({
    maxSize: 100000 // –£—Å—Ç–∞–Ω–æ–≤–∏–º –±–æ–ª—å—à–æ–π –ª–∏–º–∏—Ç
});

export async function getImportedDataIndices() {
    try {
        const allData = await tableAdapter.getAll();
        // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        const importedData = allData.filter(item => item.isImported === true);
        logger.debug(`[Background] –ü–æ–ª—É—á–µ–Ω–æ ${importedData.length} –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏.`, { module: 'Background' });
        return prepareImportedDataIndices(importedData);
    } catch (error) {
        logger.error(`[Background] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏/–∏–Ω–¥–µ–∫—Å–∞—Ü–∏–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, { module: 'Background' });
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        return {
            visitedVideoIds: new Set(),
            channelVideoCounts: new Map(),
            channelToVideoIds: new Map()
        };
    }
}
// logger –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –¥–æ–±–∞–≤–∏–ª ChromeStorageLogAdapter, –Ω–æ –º—ã –º–æ–∂–µ–º –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë

// 2. –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–≤–∏–∂–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
export const scenarioEngine = new ScenarioEngine();

// 3. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π
scenarioEngine.registerScenario(testCountdownScenario);
scenarioEngine.registerScenario(parseRecommendationScenario);
// --- –ö–æ–Ω–µ—Ü –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ ---

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç popup ---
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {

    if (request.type === "contentLog") {
        console.log("[Background] –ü–æ–ª—É—á–µ–Ω –ª–æ–≥ –æ—Ç content script:", request);
        // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –ª–æ–≥ –≤ –Ω–∞—à logger
        logger.log(
            request.message,
            request.level || 'info',
            {
                module: request.module || 'ContentScript',
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ID –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                // tabId: sender.tab?.id
            }
        );
        // –ù–∞–º–µ—Ä–µ–Ω–Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º sendResponse, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –æ–¥–Ω–æ—Å—Ç–æ—Ä–æ–Ω–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        return false; // –ù–µ –Ω—É–∂–Ω–æ –∂–¥–∞—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
    }

    if (request.action === "stopAllScenarios") {
        logger.info("üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤", { module: 'Background' });
        (async () => {
            try {
                // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
                const runningScenarios = scenarioEngine.getRunningScenarios();
                if (runningScenarios.length === 0) {
                    logger.info("üì≠ –ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏", { module: 'Background' });
                    sendResponse({ status: "success", message: "–ù–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤" });
                    return;
                }

                logger.info(`‚èπÔ∏è –ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ ${runningScenarios.length} —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤`, { module: 'Background' });

                let stoppedCount = 0;
                let errorCount = 0;

                const stopPromises = runningScenarios.map(async (scenario) => {
                    try {
                        // ScenarioEngine.stop –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                        const wasStopped = scenarioEngine.stop(scenario.id);
                        if (wasStopped) {
                            stoppedCount++;
                            logger.info(`‚èπÔ∏è –°—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}" (ID: ${scenario.id}) –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω`, { module: 'Background' });
                        } else {
                            // –≠—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–ª—É—á–∏–ª–∏ —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö
                            logger.warn(`‚ö†Ô∏è –°—Ü–µ–Ω–∞—Ä–∏–π "${scenario.name}" (ID: ${scenario.id}) –Ω–µ –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω (—É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω?)`, { module: 'Background' });
                        }
                    } catch (err) {
                        errorCount++;
                        logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenario.name}" (ID: ${scenario.id}): ${err.message}`, { module: 'Background' });
                    }
                });

                // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                await Promise.allSettled(stopPromises);

                const resultMessage = `–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${stoppedCount}. –û—à–∏–±–æ–∫: ${errorCount}.`;
                logger.info(`üèÅ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ${resultMessage}`, { module: 'Background' });

                sendResponse({ status: "success", message: resultMessage });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "getScenarioStatus") {
        logger.debug("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤", { module: 'Background' });
        try {
            const runningScenarios = scenarioEngine.getRunningScenarios();
            const isRunning = runningScenarios.length > 0;
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            sendResponse({ status: "success", isRunning: isRunning, runningScenarios: runningScenarios });
            logger.debug(`üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: isRunning=${isRunning}`, { module: 'Background' });
        } catch (err) {
            logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${err.message}`, { module: 'Background' });
            sendResponse({ status: "error", message: err.message });
        }
        return true; // keep channel open for async response (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ getRunningScenarios —Å—Ç–∞–Ω–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º –≤ –±—É–¥—É—â–µ–º)
    }

    if (request.action === "runScenario") {
        const { scenarioId, params = {} } = request;
        logger.info(`üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –∑–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioId}"`, { module: 'Background', meta: params });

        (async () => {
            try {
                let activeTabId = null;
                try {
                    const [activeTab] = await chrome.tabs.query({ active: true, currentWindow: true });
                    activeTabId = activeTab?.id || null;
                } catch (e) {
                    logger.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è", { module: 'Background' });
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—Å–∫–∞—Ç—å
                let scenarioToRun;
                if (scenarioId === 'parse-recommendation') {
                    scenarioToRun = parseRecommendationScenario;
                } else if (scenarioId === 'test-countdown') {
                    scenarioToRun = testCountdownScenario;
                    // } else if (scenarioId === '...') {
                    //     scenarioToRun = ...;
                } else {
                    throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π ID —Å—Ü–µ–Ω–∞—Ä–∏—è: ${scenarioId}`);
                }

                // –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Å—Ü–µ–Ω–∞—Ä–∏–π —á–µ—Ä–µ–∑ context.params
                const instanceId = await scenarioEngine.run(scenarioToRun, params, activeTabId);
                logger.info(`üèÅ –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioId}" –∑–∞–ø—É—â–µ–Ω —Å ID: ${instanceId}`, { module: 'Background' });

                // üëá –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å ID –∏–Ω—Å—Ç–∞–Ω—Å–∞
                sendResponse({ status: "started", instanceId: instanceId });

                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ popup –æ –Ω–∞—á–∞–ª–µ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è)
                // chrome.runtime.sendMessage({ type: "scenarioStatus", status: "started", message: `–°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioId}" –Ω–∞—á–∞—Ç.`, level: "info" });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioId}": ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();

        return true; // keep channel open for async response
    }

    if (request.action === "clearImportedTableData") {
        (async () => {
            try {
                logger.info("üì• –ü–æ–ª—É—á–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö", { module: 'Background' });

                // –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –∞–¥–∞–ø—Ç–µ—Ä–∞
                await tableAdapter.clearImported();

                logger.info("‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã", { module: 'Background' });
                sendResponse({ status: "success" });

            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "getTableFreshData") {
        (async () => {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –∞–¥–∞–ø—Ç–µ—Ä–∞
                const data = await tableAdapter.getFreshData();
                sendResponse({ status: "success", data });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
    }

    if (request.action === "DEBUG_getImportedDataIndices") {
        (async () => {
            try {
                console.log("[DEBUG] –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–ø—Ä–æ—Å—É –∏–∑ popup/console...");
                const indices = await getImportedDataIndices(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è

                // Maps –∏ Sets –Ω—É–∂–Ω–æ —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                const serializableData = {
                    visitedVideoIds_size: indices.visitedVideoIds.size,
                    channelVideoCounts_size: indices.channelVideoCounts.size,
                    channelToVideoIds_size: indices.channelToVideoIds.size,

                    // –î–æ–±–∞–≤–∏–º –ø—Ä–∏–º–µ—Ä—ã –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
                    visitedVideoIds_sample: Array.from(indices.visitedVideoIds).slice(0, 5),
                    channelVideoCounts_sample: Object.fromEntries(
                        Array.from(indices.channelVideoCounts).slice(0, 5)
                    ),
                    channelToVideoIds_sample: Object.fromEntries(
                        Array.from(indices.channelToVideoIds, ([k, v]) => [k, Array.from(v).slice(0, 3)]).slice(0, 3)
                    )
                };

                console.log("[DEBUG] –ò–Ω–¥–µ–∫—Å—ã –ø–æ–ª—É—á–µ–Ω—ã:", serializableData);
                sendResponse({ status: "success", data: serializableData });
            } catch (err) {
                console.error("[DEBUG] –û—à–∏–±–∫–∞ –≤ getImportedDataIndices:", err);
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "importTableData") {
        (async () => {
            try {
                if (!request.data || !Array.isArray(request.data)) {
                    const errorMsg = "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞";
                    console.error("[Background] importTableData:", errorMsg);
                    sendResponse({ status: "error", message: errorMsg });
                    return;
                }

                const dataToImport = request.data;

                // 1. –ü–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
                let existingData = [];
                try {
                    existingData = await tableAdapter.getAll();
                } catch (getErr) {
                    console.warn("[Background] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ, –Ω–∞—á–∏–Ω–∞–µ–º —Å –ø—É—Å—Ç–æ–≥–æ –º–∞—Å—Å–∏–≤–∞:", getErr.message);
                }

                // 2. –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ (–º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏—Ç—å, –∏–ª–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ/–∑–∞–º–µ—â–µ–Ω–∏–µ)
                // –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã, –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü.
                const combinedData = [...existingData, ...dataToImport];

                // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä
                // tableAdapter.addBatch –æ–∂–∏–¥–∞–µ—Ç –º–∞—Å—Å–∏–≤ VideoData. –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —Ñ–æ—Ä–º–∞—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π.
                // addBatch –≤–Ω—É—Ç—Ä–∏ –∞–¥–∞–ø—Ç–µ—Ä–∞ —Ç–æ–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç getAll, –¥–æ–±–∞–≤–ª—è–µ—Ç –∏ set.
                // –ß—Ç–æ–±—ã —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∏ –∏–∑–±–µ–∂–∞—Ç—å –¥–≤–æ–π–Ω–æ–≥–æ getAll, –º–æ–∂–Ω–æ –Ω–∞–ø—Ä—è–º—É—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å set,
                // –Ω–æ –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å API –∞–¥–∞–ø—Ç–µ—Ä–∞. –†–µ–∞–ª–∏–∑—É–µ–º addBatch, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç.
                // –ü—Ä–æ–≤–µ—Ä–∏–º, –µ—Å—Ç—å –ª–∏ addBatch:
                if (typeof tableAdapter.addBatch === 'function') {
                    await tableAdapter.addBatch(dataToImport);
                } else if (typeof tableAdapter.add === 'function') {
                    // –ï—Å–ª–∏ addBatch –Ω–µ—Ç, –¥–æ–±–∞–≤–ª—è–µ–º –ø–æ –æ–¥–Ω–æ–π (–º–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ)
                    for (const item of dataToImport) {
                        await tableAdapter.add(item);
                    }
                } else {
                    const errorMsg = "–ê–¥–∞–ø—Ç–µ—Ä —Ç–∞–±–ª–∏—Ü—ã –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–µ—Ç–æ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è";
                    console.error("[Background] importTableData:", errorMsg);
                    sendResponse({ status: "error", message: errorMsg });
                    return;
                }

                logger.info(`üì• –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${dataToImport.length} –∑–∞–ø–∏—Å–µ–π –≤ —Ç–∞–±–ª–∏—Ü—É`, { module: 'Background' });

                sendResponse({ status: "success", count: dataToImport.length });

            } catch (err) {
                console.error("[Background] –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –¥–∞–Ω–Ω—ã—Ö:", err);
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // keep channel open for async response
    }

    if (request.action === "getImportedDataIndices") {
        (async () => {
            try {
                const indices = await getImportedDataIndices();
                // Maps –∏ Sets –Ω–µ–ª—å–∑—è –Ω–∞–ø—Ä—è–º—É—é —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤ JSON, –ø–æ—ç—Ç–æ–º—É –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º
                const serializableIndices = {
                    visitedVideoIds: Array.from(indices.visitedVideoIds),
                    channelVideoCounts: Object.fromEntries(indices.channelVideoCounts),
                    channelToVideoIds: {} // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map<channel, Set<id>> –≤ –æ–±—ä–µ–∫—Ç
                };
                for (const [channel, idSet] of indices.channelToVideoIds) {
                    serializableIndices.channelToVideoIds[channel] = Array.from(idSet);
                }
                sendResponse({ status: "success", data: serializableIndices });
            } catch (err) {
                logger.error(`[Background] –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–¥–µ–∫—Å–æ–≤: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // –î–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞
    }

    if (request.action === "getTableData") {
        (async () => {
            try {
                const data = await tableAdapter.getAll();
                sendResponse({ status: "success", data });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true; // –£–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
    }

    // üëá –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü—ã
    if (request.action === "clearTableData") {
        (async () => {
            try {
                await tableAdapter.clear();
                sendResponse({ status: "success" });
                logger.info("‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞", { module: 'Background' });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true;
    }

    // üëá –ù–û–í–û–ï: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã (–ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–æ—Ä–º–∞—Ç–µ TSV)
    if (request.action === "copyTableData") {
        (async () => {
            try {
                const data = await tableAdapter.getAll();
                // –§–∏–ª—å—Ç—Ä—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const freshData = data.filter(v => !v.isImported);

                const headers = ['–ù–∞–∑–≤–∞–Ω–∏–µ', 'ID', '–ü—Ä–æ—Å–º–æ—Ç—Ä—ã', '–ö–∞–Ω–∞–ª', '–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ', '–ú–∏–Ω–∏–∞—Ç—é—Ä–∞'];
                const rows = freshData.map(v => [
                    v.title || '', v.videoId || '', v.views || '', v.channelName || '', v.sourceVideoId || '', v.thumbnailUrl || ''
                ]);

                const tsvContent = [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
                sendResponse({ status: "success", data: tsvContent });
                logger.info(`üìã –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è (${freshData.length} —Å—Ç—Ä–æ–∫)`, { module: 'Background' });
            } catch (err) {
                logger.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ${err.message}`, { module: 'Background' });
                sendResponse({ status: "error", message: err.message });
            }
        })();
        return true;
    }

    // TODO: –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π (parseOnce, startAutoAnalysis –∏ —Ç.–¥.)
    // –∫–æ—Ç–æ—Ä—ã–µ –º—ã –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–º –Ω–∞ –Ω–æ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É.
    // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –∑–∞–≥–ª—É—à–∫—É –∏–ª–∏ —Å—Ç–∞—Ä—É—é –ª–æ–≥–∏–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å MVP.
});

logger.info("üöÄ Background service worker –∑–∞–ø—É—â–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.", { module: 'Background' });

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\background\background.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\content.js ===

// content/content.js
// window.performScrollNTimes –¥–æ—Å—Ç—É–ø–Ω–∞, —Ç–∞–∫ –∫–∞–∫ scroller.js –±—ã–ª –ø–æ–¥–∫–ª—é—á–µ–Ω —Ä–∞–Ω—å—à–µ

console.log("[Content Script] –ó–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.");

// –°–ª—É—à–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç background.js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
    console.log("[Content Script] –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:", request);

    if (request.action === "performSingleScroll") {
        console.log("[Content Script] –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –û–î–ù–û–ì–û —Å–∫—Ä–æ–ª–ª–∞:", request);

        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª, –≤—ã–∑—ã–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
        window.performSingleScroll(request.step)
            .then(() => {
                console.log("[Content Script] –û–¥–∏–Ω —Å–∫—Ä–æ–ª–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ.");
                sendResponse({ status: "success" });
            })
            .catch((err) => {
                console.error("[Content Script] –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞:", err);
                sendResponse({ status: "error", message: err.message });
            });

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º true, —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å, —á—Ç–æ –æ—Ç–≤–µ—Ç –±—É–¥–µ—Ç –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–º
        return true;
    }

    console.log("[Content Script] –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º.");
});

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\content.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\scroller.js ===

// content/modules/scroller.js

/**
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç –æ–¥–∏–Ω —à–∞–≥ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.
 * @param {number} step - –ù–∞ —Å–∫–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–µ–π —Å–∫—Ä–æ–ª–ª–∏—Ç—å.
 * @returns {Promise<void>}
 */
function performSingleScroll(step = 1000) {
    return new Promise((resolve) => {
        // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª
        window.scrollBy(0, step);
        // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞, —á—Ç–æ–±—ã –¥–∞—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–µ–º–Ω–æ–≥–æ –æ—Ç—Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å
        // –≠—Ç–æ –º–æ–∂–µ—Ç –ø–æ–º–æ—á—å, –µ—Å–ª–∏ YouTube –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –ª–µ–Ω–∏–≤–æ
        setTimeout(() => {
            console.log(`[Content Module Scroller] –í—ã–ø–æ–ª–Ω–µ–Ω –æ–¥–∏–Ω —Å–∫—Ä–æ–ª–ª –Ω–∞ ${step}px.`);
            resolve();
        }, 50); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ 50–º—Å
    });
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å –≤–∏–¥–∏–º–æ—Å—Ç–∏
// –¢–µ–ø–µ—Ä—å –æ–Ω–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –∫–∞–∫ window.performSingleScroll
window.performSingleScroll = performSingleScroll;

console.log("[Content Module Scroller] –ú–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤.");

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\content\modules\scroller.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\data-processor.js ===

// core/data-processor.js

/**
 * @typedef {import('./types/table.types.js').VideoData} VideoData
 */

/**
 * –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∏–Ω–¥–µ–∫—Å—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ –º–∞—Å—Å–∏–≤–∞ –≤–∏–¥–µ–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö).
 * @param {VideoData[]} videoDataArray - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–µ–æ.
 * @returns {Object} –û–±—ä–µ–∫—Ç —Å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞–º–∏.
 * @returns {Set<string>} .visitedVideoIds - –ú–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ, –ù–ê –ö–û–¢–û–†–´–ï –£–ñ–ï –ó–ê–•–û–î–ò–õ–ò (sourceVideoId).
 * @returns {Map<string, number>} .channelVideoCounts - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞.
 * @returns {Map<string, Set<string>>} .channelToVideoIds - –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (videoId).
 */
export function prepareImportedDataIndices(videoDataArray) {
    // 1. –°–µ—Ç –≤–∏–¥–µ–æ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ –∑–∞—Ö–æ–¥–∏–ª–∏ (sourceVideoId)
    // –≠—Ç–æ –≤–∏–¥–µ–æ, —Å –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥, —Ç.–µ. –æ–Ω–∏ —É–∂–µ –±—ã–ª–∏ "—Ç–µ–∫—É—â–∏–º–∏".
    const visitedVideoIds = new Set();

    // 2. –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–∏–¥–µ–æ –∏–∑ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞
    const channelVideoCounts = new Map();

    // 3. –°–ª–æ–≤–∞—Ä—å: –∫–∞–Ω–∞–ª -> –º–Ω–æ–∂–µ—Å—Ç–≤–æ ID –≤–∏–¥–µ–æ —ç—Ç–æ–≥–æ –∫–∞–Ω–∞–ª–∞ (videoId)
    const channelToVideoIds = new Map();

    if (!Array.isArray(videoDataArray)) {
        console.warn("[DataProcessor] –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º.");
        return { visitedVideoIds, channelVideoCounts, channelToVideoIds };
    }

    for (const video of videoDataArray) {
        // --- 1. –ó–∞–ø–æ–ª–Ω—è–µ–º visitedVideoIds ---
        // –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º sourceVideoId, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ ID –≤–∏–¥–µ–æ,
        // –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –º—ã "–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏—Å—å" –∏ —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–ª–∏.
        // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —ç—Ç–æ –∂–µ –≤–∏–¥–µ–æ.
        if (video.sourceVideoId) {
            visitedVideoIds.add(video.sourceVideoId);
        }
        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ —Ç–∞–∫–∂–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å videoId (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á—Ç–æ–±—ã –Ω–µ –¥–æ–±–∞–≤–ª—è—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã –≤–∏–¥–µ–æ –≤ —Ç–∞–±–ª–∏—Ü—É),
        // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä, allParsedVideoIds. –ù–æ –¥–ª—è visitedVideoIds - —ç—Ç–æ sourceVideoId.

        // --- 2. –ó–∞–ø–æ–ª–Ω—è–µ–º channelVideoCounts ---
        const channel = video.channelName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–Ω–∞–ª';
        const currentCount = channelVideoCounts.get(channel) || 0;
        channelVideoCounts.set(channel, currentCount + 1);

        // --- 3. –ó–∞–ø–æ–ª–Ω—è–µ–º channelToVideoIds ---
        // –ó–¥–µ—Å—å –∏—Å–ø–æ–ª—å–∑—É–µ–º videoId, —Ç–∞–∫ –∫–∞–∫ –º—ã —Ö–æ—Ç–∏–º –∑–Ω–∞—Ç—å, –∫–∞–∫–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –≤–∏–¥–µ–æ
        // –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç –∫–∞–Ω–∞–ª—É.
        if (!channelToVideoIds.has(channel)) {
            channelToVideoIds.set(channel, new Set());
        }
        if (video.videoId) {
            channelToVideoIds.get(channel).add(video.videoId);
        }
    }

    return {
        visitedVideoIds,
        channelVideoCounts,
        channelToVideoIds
    };
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\data-processor.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\logger.js ===

// core/logger.js
import { ChromeStorageLogAdapter } from '../adapters/ChromeStorageLogAdapter.js';

/**
 * @typedef {import('./types/log.types.js').LogEntry} LogEntry
 * @typedef {import('./types/log.types.js').LoggerConfig} LoggerConfig
 * @typedef {import('./types/log.types.js').LogAdapter} LogAdapter
 * @typedef {import('./types/log.types.js').LogSubscriber} LogSubscriber
 */

export class Logger {
    /** @type {LogAdapter[]} */
    #adapters = [];
    /** @type {LogSubscriber[]} */
    #subscribers = [];
    /** @type {LoggerConfig} */
    #config;

    /**
     * @param {LoggerConfig} config
     */
    constructor(config = {}) {
        this.#config = {
            maxSize: config.maxSize ?? 1000,
            enableConsole: config.enableConsole ?? true,
            defaultLevel: config.defaultLevel ?? 'info',
        };

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–æ–±–∞–≤–ª—è–µ–º –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è Chrome Storage
        this.addAdapter(new ChromeStorageLogAdapter({ maxSize: this.#config.maxSize }));
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è/–≤—ã–≤–æ–¥–∞ –ª–æ–≥–æ–≤.
     * @param {LogAdapter} adapter
     */
    addAdapter(adapter) {
        this.#adapters.push(adapter);
    }

    /**
     * –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –Ω–æ–≤—ã–µ –ª–æ–≥–∏ –∏ –∫–æ–º–∞–Ω–¥—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—á–∏—Å—Ç–∫–∞).
     * @param {LogSubscriber} callback
     */
    subscribe(callback) {
        this.#subscribers.push(callback);
    }

    /**
     * –û—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç –Ω–æ–≤—ã—Ö –ª–æ–≥–æ–≤.
     * @param {LogSubscriber} callback
     */
    unsubscribe(callback) {
        this.#subscribers = this.#subscribers.filter(cb => cb !== callback);
    }

    /**
     * –°–æ–∑–¥–∞–µ—Ç –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥-–∑–∞–ø–∏—Å—å.
     * @param {string} message
     * @param {'debug'|'info'|'success'|'warn'|'error'} [level]
     * @param {Object} [options]
     * @param {string} [options.module]
     * @param {string} [options.contextId]
     * @param {Object} [options.meta]
     */
    async log(message, level = this.#config.defaultLevel, options = {}) {
        const entry = {
            id: this.#generateId(),
            timestamp: Date.now(),
            level,
            message,
            module: options.module,
            contextId: options.contextId,
            meta: options.meta,
        };

        // 1. –ó–∞–ø–∏—Å—å —á–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä—ã
        const writePromises = this.#adapters.map(adapter => adapter.write(entry));
        await Promise.allSettled(writePromises); // –ù–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º—Å—è –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –æ–¥–Ω–æ–≥–æ –∞–¥–∞–ø—Ç–µ—Ä–∞

        // 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–Ω—Å–æ–ª—å (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ)
        if (this.#config.enableConsole) {
            this.#logToConsole(entry);
        }

        // 3. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤
        this.#notifySubscribers(entry);

        // 4. üëá –ù–û–í–û–ï: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ popup (–µ—Å–ª–∏ –≤ background)
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ Service Worker (background)
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä–µ–ª–æ—á–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ this
                chrome.runtime.sendMessage({
                    type: "newLog",
                    log: entry
                }).catch(err => {
                    // –≠—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ sendMessage
                    if (chrome.runtime.lastError) {
                        // –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –µ—Å–ª–∏ popup –∑–∞–∫—Ä—ã—Ç
                        // console.debug("Popup –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è sendMessage:", chrome.runtime.lastError.message);
                    } else {
                        console.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ª–æ–≥–∞ –≤ popup (–∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è):", err);
                    }
                });
            } catch (syncSendError) {
                // –≠—Ç–æ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—à–∏–±–∫–∏ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ sendMessage
                // –ú–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å, –µ—Å–ª–∏ API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (—Ä–µ–¥–∫–æ)
                console.debug("–°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ sendMessage:", syncSendError);
            }
        }
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –ª–æ–≥–∏ –∏–∑ –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–æ–≤ (–±–µ—Ä–µ—Ç –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ).
     * @returns {Promise<LogEntry[]>}
     */
    async getAllLogs() {
        for (const adapter of this.#adapters) {
            try {
                const logs = await adapter.read();
                return logs;
            } catch (e) {
                console.warn("[Logger] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏ –∏–∑ –∞–¥–∞–ø—Ç–µ—Ä–∞:", e);
            }
        }
        return []; // –ï—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –∞–¥–∞–ø—Ç–µ—Ä –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª
    }

    /**
     * –û—á–∏—â–∞–µ—Ç –ª–æ–≥–∏ –≤–æ –≤—Å–µ—Ö –∞–¥–∞–ø—Ç–µ—Ä–∞—Ö.
     * @returns {Promise<void>}
     */
    async clear() {
        const clearPromises = this.#adapters.map(adapter => adapter.clear());
        await Promise.allSettled(clearPromises);
        // –£–≤–µ–¥–æ–º–ª—è–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –æ–± –æ—á–∏—Å—Ç–∫–µ
        this.#notifySubscribers({ type: 'CLEAR_LOGS' });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---

    /**
     * –£–¥–æ–±–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —É—Ä–æ–≤–Ω–µ–π
     */
    debug(message, options = {}) { return this.log(message, 'debug', options); }
    info(message, options = {}) { return this.log(message, 'info', options); }
    success(message, options = {}) { return this.log(message, 'success', options); }
    warn(message, options = {}) { return this.log(message, 'warn', options); }
    error(message, options = {}) { return this.log(message, 'error', options); }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∑–∞–ø–∏—Å–∏.
     * @returns {string}
     */
    #generateId() {
        return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
    }

    /**
     * –í—ã–≤–æ–¥–∏—Ç –ª–æ–≥ –≤ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.
     * @param {LogEntry} entry
     */
    #logToConsole(entry) {
        const time = new Date(entry.timestamp).toLocaleTimeString();
        const prefix = `[${time}] [${entry.level.toUpperCase()}]`;
        const suffix = entry.module ? `[${entry.module}]` : '';
        const context = entry.contextId ? `(ctx:${entry.contextId})` : '';

        const consoleMethod = entry.level === 'error' ? console.error :
            entry.level === 'warn' ? console.warn :
                entry.level === 'debug' ? console.debug : console.log;

        consoleMethod(`${prefix} ${entry.message} ${suffix} ${context}`, entry.meta || '');
    }

    /**
     * –£–≤–µ–¥–æ–º–ª—è–µ—Ç –≤—Å–µ—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤.
     * @param {LogEntry | { type: 'CLEAR_LOGS' }} entry
     */
    #notifySubscribers(entry) {
        this.#subscribers.forEach(callback => {
            try {
                callback(entry);
            } catch (e) {
                console.error("[Logger] –û—à–∏–±–∫–∞ –≤ –ø–æ–¥–ø–∏—Å—á–∏–∫–µ:", e);
            }
        });
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\logger.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\scenario-engine.js ===


// core/scenario-engine.js
import { logger } from '../background/background.js'; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ª–æ–≥–≥–µ—Ä

/**
 * @typedef {import('./types/scenario.types.js').ScenarioDefinition} ScenarioDefinition
 * @typedef {import('./types/scenario.types.js').ScenarioContext} ScenarioContext
 */

export class ScenarioEngine {
    /** @type {Map<string, { definition: ScenarioDefinition, context: ScenarioContext, controller: AbortController }>} */
    #runningScenarios = new Map();

    /**
     * –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ –¥–≤–∏–∂–∫–µ.
     * @param {ScenarioDefinition} scenarioDefinition
     */
    registerScenario(scenarioDefinition) {
        // –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–ª—è UI/–≤—ã–±–æ—Ä–∞
        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        logger.debug(`[ScenarioEngine] –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π: ${scenarioDefinition.name}`, { module: 'ScenarioEngine' });
    }

    /**
     * –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å—Ü–µ–Ω–∞—Ä–∏–π.
     * @param {ScenarioDefinition} scenarioDefinition
     * @param {Object} [params={}] - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
     * @param {number} [tabId] - ID –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
     * @returns {Promise<string>} ID –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
     */

    async run(scenarioDefinition, params = {}, tabId = null) {
        const instanceId = this.#generateId();
        const controller = new AbortController();

        /** @type {ScenarioContext} */
        const context = {
            id: instanceId,
            tabId,
            params,
            log: (message, options = {}) => {
                logger.info(message, {
                    module: options.module || `Scenario:${scenarioDefinition.id}`,
                    contextId: instanceId,
                    ...options
                });
            },
            abortSignal: async () => {
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º Promise, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–∫–ª–æ–Ω—è–µ—Ç—Å—è, –µ—Å–ª–∏ controller.signal —Å—Ä–∞–±–æ—Ç–∞–µ—Ç.
                // –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª —É–∂–µ —Å—Ä–∞–±–æ—Ç–∞–ª (controller.abort() –±—ã–ª –≤—ã–∑–≤–∞–Ω), —Ç–æ promise1 —É–∂–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω.
                return new Promise((resolve, reject) => {
                    // 1. –ü—Ä–æ–≤–µ—Ä–∫–∞, –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª –ª–∏ —Å–∏–≥–Ω–∞–ª —É–∂–µ
                    if (controller.signal.aborted) {
                        // –ï—Å–ª–∏ —Å—Ä–∞–±–æ—Ç–∞–ª, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ–º –ø—Ä–æ–º–∏—Å
                        reject(new Error('–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.'));
                        return; // –í–∞–∂–Ω–æ –≤—ã–π—Ç–∏
                    }
                    // 2. –ï—Å–ª–∏ —Å–∏–≥–Ω–∞–ª –µ—â–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, —Å—Ç–∞–≤–∏–º —Å–ª—É—à–∞—Ç–µ–ª—å
                    // –ö–æ–≥–¥–∞ controller.abort() –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω, —Å—Ä–∞–±–æ—Ç–∞–µ—Ç 'abort' –Ω–∞ signal
                    controller.signal.addEventListener('abort', () => {
                        reject(new Error('–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.'));
                    }, { once: true }); // { once: true } –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —Å–ª—É—à–∞—Ç–µ–ª—å —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
                    // 3. –ï—Å–ª–∏ –¥–æ —ç—Ç–æ–≥–æ –Ω–∏–∫—Ç–æ –Ω–µ –≤—ã–∑–≤–∞–ª controller.abort(), –ø—Ä–æ–º–∏—Å –æ—Å—Ç–∞–µ—Ç—Å—è –Ω–µ—Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã–º
                    // –∏ —Ñ—É–Ω–∫—Ü–∏—è abortSignal "–∂–¥—ë—Ç". –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ.
                    // resolve() –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –Ω–∏–∫–æ–≥–¥–∞ –Ω–∞–ø—Ä—è–º—É—é –∑–¥–µ—Å—å, —Ç–æ–ª—å–∫–æ reject —á–µ—Ä–µ–∑ 'abort'.
                    // resolve() –Ω–µ –Ω—É–∂–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–¥–∞—á–∞ abortSignal - —Ç–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–∏—Ç—å –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ.
                });
            },
            // –ü–µ—Ä–µ–¥–∞–µ–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –∫ –Ω–µ–º—É –¥–æ—Å—Ç—É–ø –≤ finally
            controller: controller
        };

        this.#runningScenarios.set(instanceId, { definition: scenarioDefinition, context, controller });

        // üëá –£–≤–µ–¥–æ–º–ª—è–µ–º popup –æ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è
        if (typeof chrome !== 'undefined' && chrome.runtime) {
            chrome.runtime.sendMessage({
                type: "scenarioStatus",
                status: "started",
                message: `[ScenarioEngine] –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioDefinition.name}" (ID: ${instanceId})`,
                level: "info"
            }).catch(err => {
                console.debug("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ popup:", err);
            });
        }

        context.log(`[ScenarioEngine] –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioDefinition.name}" (ID: ${instanceId})`, { module: 'ScenarioEngine' });

        try {
            await scenarioDefinition.execute(context);
            context.log(`[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω.`, { module: 'ScenarioEngine' });
        } catch (error) {
            if (error.message === '–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.') {
                context.log(`[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.`, { module: 'ScenarioEngine', level: 'warn' });
            } else {
                context.log(`[ScenarioEngine] –û—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ "${scenarioDefinition.name}": ${error.message}`, { module: 'ScenarioEngine', level: 'error' });
                logger.error(`–û—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ "${scenarioDefinition.name}": ${error.stack}`, { module: 'ScenarioEngine', contextId: instanceId });
            }
        } finally {
            this.#runningScenarios.delete(instanceId);

            // üëá –£–≤–µ–¥–æ–º–ª—è–µ–º popup –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è
            // –¢–µ–ø–µ—Ä—å –º—ã –º–æ–∂–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ controller —á–µ—Ä–µ–∑ context
            const isAborted = context.controller.signal.aborted;
            const finalStatus = isAborted ? "stopped" : "finished";
            const finalMessage = isAborted ?
                `[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" (ID: ${instanceId}) –±—ã–ª –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.` :
                `[ScenarioEngine] –°—Ü–µ–Ω–∞—Ä–∏–π "${scenarioDefinition.name}" (ID: ${instanceId}) –∑–∞–≤–µ—Ä—à–µ–Ω.`;

            console.log(`[ScenarioEngine] –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ "${finalStatus}" –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ID: ${instanceId}`); // <-- –õ–æ–≥

            if (typeof chrome !== 'undefined' && chrome.runtime) {
                chrome.runtime.sendMessage({
                    type: "scenarioStatus",
                    status: finalStatus,
                    message: finalMessage,
                    level: "info"
                }).catch(err => {
                    console.debug("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Å—Ü–µ–Ω–∞—Ä–∏—è –≤ popup:", err);
                });
            }
            console.log(`[ScenarioEngine] –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å "${finalStatus}" –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏—è ID: ${instanceId} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω (–∏–ª–∏ –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∞).`); // <-- –õ–æ–≥
        }
        return instanceId;
    }

    /**
     * –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–∞–ø—É—â–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π.
     * @param {string} instanceId
     * @returns {boolean} true, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–π –±—ã–ª –Ω–∞–π–¥–µ–Ω –∏ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.
     */
    stop(instanceId) {
        const scenarioInstance = this.#runningScenarios.get(instanceId);
        if (scenarioInstance) {
            scenarioInstance.controller.abort();
            scenarioInstance.context.log(`[ScenarioEngine] –ó–∞–ø—Ä–æ—à–µ–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.`, { module: 'ScenarioEngine', level: 'warn' });
            return true;
        }
        logger.warn(`[ScenarioEngine] –ü–æ–ø—ã—Ç–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π (ID: ${instanceId})`, { module: 'ScenarioEngine' });
        return false;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤.
     * @returns {Array<{id: string, name: string}>}
     */
    getRunningScenarios() {
        return Array.from(this.#runningScenarios.entries()).map(([id, { definition }]) => ({
            id,
            name: definition.name
        }));
    }

    /**
     * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è.
     * @returns {string}
     */
    #generateId() {
        return `scenario_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
}



=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\scenario-engine.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\log.types.js ===

// core/types/log.types.js

/**
 * @typedef {Object} LogEntry
 * @property {string} id - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏.
 * @property {number} timestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ (–º—Å —Å 1970).
 * @property {string} level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞: 'debug', 'info', 'success', 'warn', 'error'.
 * @property {string} message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
 * @property {string} [module] - –ú–æ–¥—É–ª—å –∏–ª–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç, —Å–æ–∑–¥–∞–≤—à–∏–π –∑–∞–ø–∏—Å—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 'Parser', 'Selector').
 * @property {string} [contextId] - –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ID —Å–µ—Å—Å–∏–∏ –∞–Ω–∞–ª–∏–∑–∞).
 * @property {Object} [meta] - –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
 */

/**
 * @typedef {Object} LoggerConfig
 * @property {number} [maxSize=1000] - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ø–∞–º—è—Ç–∏/—Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
 * @property {boolean} [enableConsole=true] - –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –≤ console.
 * @property {string} [defaultLevel='info'] - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.
 */

/**
 * @callback LogSubscriber
 * @param {LogEntry | { type: 'CLEAR_LOGS' }} entry - –ó–∞–ø–∏—Å—å –ª–æ–≥–∞ –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –æ—á–∏—Å—Ç–∫–∏.
 * @returns {void}
 */

/**
 * @typedef {Object} LogAdapter
 * @property {function(LogEntry): Promise<void>} write - –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–≥.
 * @property {function(): Promise<LogEntry[]>} read - –ß–∏—Ç–∞–µ—Ç –≤—Å–µ –ª–æ–≥–∏.
 * @property {function(): Promise<void>} clear - –û—á–∏—â–∞–µ—Ç –ª–æ–≥–∏.
 */

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\log.types.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\scenario.types.js ===

// core/types/scenario.types.js

/**
 * @typedef {Object} ScenarioContext
 * @property {string} id - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {number} [tabId] - ID –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏, –µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ.
 * @property {Object} [params] - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã, –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏—é.
 * @property {function(string, Object): void} log - –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {function(): Promise<void>} abortSignal - –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É.
 */

/**
 * @typedef {Object} ScenarioDefinition
 * @property {string} id - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {string} name - –ß–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –∏–º—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {string} description - –û–ø–∏—Å–∞–Ω–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏—è.
 * @property {function(ScenarioContext): Promise<void>} execute - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è.
 */

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\scenario.types.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\table.types.js ===

// core/types/table.types.js

/**
 * @typedef {Object} VideoData
 * @property {string} videoId - –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –≤–∏–¥–µ–æ.
 * @property {string} title - –ù–∞–∑–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ.
 * @property {string} channelName - –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞.
 * @property {string} views - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ (–≤ –≤–∏–¥–µ —Å—Ç—Ä–æ–∫–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä, "1.2M").
 * @property {string} sourceVideoId - ID –≤–∏–¥–µ–æ, —Å –∫–æ—Ç–æ—Ä–æ–≥–æ –±—ã–ª —Å–æ–≤–µ—Ä—à–µ–Ω –ø–µ—Ä–µ—Ö–æ–¥.
 * @property {string} thumbnailUrl - URL –º–∏–Ω–∏–∞—Ç—é—Ä—ã.
 * @property {number} timestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏.
 * @property {boolean} [isImported] - –§–ª–∞–≥, —É–∫–∞–∑—ã–≤–∞—é—â–∏–π, —á—Ç–æ –∑–∞–ø–∏—Å—å –±—ã–ª–∞ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞.
 */

/**
 * @typedef {Object} TableAdapter
 * @property {function(VideoData): Promise<void>} add - –î–æ–±–∞–≤–ª—è–µ—Ç –æ–¥–Ω—É –∑–∞–ø–∏—Å—å.
 * @property {function(VideoData[]): Promise<void>} addBatch - –î–æ–±–∞–≤–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–µ–π.
 * @property {function(): Promise<VideoData[]>} getAll - –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–ø–∏—Å–∏.
 * @property {function(): Promise<void>} clear - –û—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É.
 * @property {function(): Promise<number>} getCount - –ü–æ–ª—É—á–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π.
 */

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\types\table.types.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\scroller.js ===

// core/utils/scroller.js

/**
 * –í—ã–ø–æ–ª–Ω—è–µ—Ç N —à–∞–≥–æ–≤ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∑–∞–¥–µ—Ä–∂–∫–∞–º–∏ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞.
 * @param {Object} context - –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è.
 * @param {number} [count=16] - –°–∫–æ–ª—å–∫–æ —Ä–∞–∑ —Å–∫—Ä–æ–ª–ª–∏—Ç—å.
 * @param {number} [delayMs=1500] - –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∫—Ä–æ–ª–ª–∞–º–∏ (–º—Å).
 * @param {number} [step=1000] - –ù–∞ —Å–∫–æ–ª—å–∫–æ –ø–∏–∫—Å–µ–ª–µ–π —Å–∫—Ä–æ–ª–ª–∏—Ç—å –∑–∞ —Ä–∞–∑.
 * @returns {Promise<void>}
 */
export async function scrollPageNTimes(context, count = 16, delayMs = 1500, step = 1000) {
    const { log, abortSignal } = context;
    log(`üîÑ –ù–∞—á–∏–Ω–∞–µ–º —Å–∫—Ä–æ–ª–ª–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã: ${count} —Ä–∞–∑(–∞), —à–∞–≥ ${step}px, –∑–∞–¥–µ—Ä–∂–∫–∞ ${delayMs}–º—Å`, { module: 'Scroller' });

    try {
        // --- –ü–†–û–í–ï–†–ö–ê tabId ---
        if (typeof context.tabId !== 'number' || context.tabId < 0) {
            const errorMsg = `–ù–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–π tabId –¥–ª—è sendMessage: ${context.tabId}. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω –Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–µ YouTube.`;
            log(`‚ùå ${errorMsg}`, { module: 'Scroller', level: 'error' });
            throw new Error(errorMsg);
        }
        // --- –ö–û–ù–ï–¶ –ü–†–û–í–ï–†–ö–ò tabId ---

        for (let i = 1; i <= count; i++) {
            // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É/–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ
            await abortSignal();

            // 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ content script –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –û–î–ù–û–ì–û —Å–∫—Ä–æ–ª–ª–∞
            log(`‚è≥ –í—ã–ø–æ–ª–Ω—è–µ–º —Å–∫—Ä–æ–ª–ª ${i}/${count}...`, { module: 'Scroller' });

            // --- –ü–û–ü–´–¢–ö–ê –° –ë–õ–û–ö–û–ú try/catch –î–õ–Ø sendMessage ---
            let response;
            try {
                response = await chrome.tabs.sendMessage(
                    context.tabId,
                    {
                        action: "performSingleScroll",
                        step: step
                    }
                );
            } catch (sendMsgErr) {
                log(`‚ùå –û—à–∏–±–∫–∞ sendMessage –¥–ª—è —Å–∫—Ä–æ–ª–ª–∞ ${i}/${count}: ${sendMsgErr.message}`, { module: 'Scroller', level: 'error' });
                throw new Error(`–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü–µ–π YouTube: ${sendMsgErr.message}`);
            }
            // --- –ö–û–ù–ï–¶ –ü–û–ü–´–¢–ö–ò ---

            if (response && response.status === "success") {
                log(`‚úÖ –°–∫—Ä–æ–ª–ª ${i}/${count} –≤—ã–ø–æ–ª–Ω–µ–Ω.`, { module: 'Scroller' });
            } else {
                const errorMsg = response?.message || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞";
                log(`‚ùå –û—à–∏–±–∫–∞ —Å–∫—Ä–æ–ª–ª–∞ ${i}/${count}: ${errorMsg}`, { module: 'Scroller', level: 'error' });
                throw new Error(errorMsg);
            }

            // 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–Ω–æ–≤–∞ –Ω–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–æ–ª–ª–∞
            await abortSignal();

            // 4. –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∫—Ä–æ–ª–ª, –¥–µ–ª–∞–µ–º –ø–∞—É–∑—É
            if (i < count) {
                log(`‚è±Ô∏è –û–∂–∏–¥–∞–Ω–∏–µ ${delayMs}–º—Å –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Å–∫—Ä–æ–ª–ª–æ–º (${i + 1}/${count})...`, { module: 'Scroller' });
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–∏—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–∞–∑—Ä–µ—à–∏—Ç—Å—è –ª–∏–±–æ –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ –≤—Ä–µ–º–µ–Ω–∏,
                // –ª–∏–±–æ –µ—Å–ª–∏ –±—É–¥–µ—Ç –≤—ã–∑–≤–∞–Ω abortSignal (–ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ)
                // –ü–†–ê–í–ò–õ–¨–ù–´–ô –°–ü–û–°–û–ë: –ò—Å–ø–æ–ª—å–∑—É–µ–º Promise.race
                const delayPromise = new Promise(resolve => setTimeout(resolve, delayMs));
                try {
                    // Promise.race "–≥–æ–Ω–∫–∞" –º–µ–∂–¥—É –∑–∞–¥–µ—Ä–∂–∫–æ–π –∏ —Å–∏–≥–Ω–∞–ª–æ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                    await Promise.race([delayPromise, context.abortSignal()]);
                    // –ï—Å–ª–∏ context.abortSignal() "–≤—ã–∏–≥—Ä–∞–µ—Ç" –≥–æ–Ω–∫—É (–æ—Ç–∫–ª–æ–Ω–∏—Ç—Å—è), await –±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ.
                    // –ï—Å–ª–∏ delayPromise "–≤—ã–∏–≥—Ä–∞–µ—Ç" (—Ä–∞–∑—Ä–µ—à–∏—Ç—Å—è), await –ø—Ä–æ–¥–æ–ª–∂–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.
                } catch (abortErr) {
                    // –ï—Å–ª–∏ abortSignal –æ—Ç–∫–ª–æ–Ω–∏–ª—Å—è, –º—ã –ø–æ–ø–∞–¥–∞–µ–º —Å—é–¥–∞
                    log(`‚èπÔ∏è –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –≤–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è.`, { module: 'Scroller', level: 'warn' });
                    throw abortErr; // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
                }
            }
        }

        // –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö —Å–∫—Ä–æ–ª–ª–æ–≤ –º–æ–∂–Ω–æ –æ—Ü–µ–Ω–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫
        try {
            const countResponse = await chrome.tabs.sendMessage(context.tabId, {
                action: "getEstimatedCardCount"
            });
            const cardCount = countResponse?.cardCount || 0;
            log(`‚úÖ –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω. –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –ø—Ä–∏–º–µ—Ä–Ω–æ ${cardCount} –∫–∞—Ä—Ç–æ—á–µ–∫.`, { module: 'Scroller' });
        } catch (countErr) {
            console.warn("[Core Scroller] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç–æ—á–µ–∫ –ø–æ—Å–ª–µ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞:", countErr);
            log(`‚úÖ –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω.`, { module: 'Scroller' });
        }

    } catch (err) {
        if (err.message === '–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.') {
            log(`‚èπÔ∏è –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.`, { module: 'Scroller', level: 'warn' });
        } else {
            log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞: ${err.message}`, { module: 'Scroller', level: 'error' });
        }
        throw err; // –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\core\utils\scroller.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.css ===

/* popup/popup.css */
:root {
    --primary: #4338ca;
    --primary-hover: #3730a3;
    --success: #16a34a;
    --success-hover: #15803d;
    --warning: #ca8a04;
    --warning-hover: #a16207;
    --danger: #dc2626;
    --danger-hover: #b91c1c;
    --info: #0284c7;
    --info-hover: #0369a1;
    --secondary: #64748b;
    --secondary-hover: #475569;
    --bg: #ffffff;
    --card: #f9fafb;
    --text: #111827;
    --border: #e5e7eb;
    --shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    padding: 16px;
    width: 800px;
    height: 720px;
    overflow: hidden;
}

.app-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    height: 100%;
    overflow: hidden;
}

.app-title {
    font-size: 20px;
    font-weight: 600;
    color: var(--primary);
    margin-bottom: 16px;
    text-align: center;
}

.section {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    box-shadow: var(--shadow);
    flex-shrink: 0;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
}

#logSection .section-header {
    margin-bottom: 8px;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
}

#logSection {
    /* –ü–æ–∑–≤–æ–ª—è–µ–º —Å–µ–∫—Ü–∏–∏ –∂—É—Ä–Ω–∞–ª–∞ —Ä–∞—Å—Ç–∏ –∏ —Å–∂–∏–º–∞—Ç—å—Å—è */
    flex: 1;
    /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è */
    min-height: 150px;
    /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞, —á—Ç–æ–±—ã –±—ã–ª –≤–∏–¥–µ–Ω —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ª–æ–≥ */
    /* max-height: 300px; */
    /* –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É */
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω—è—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å–∞–º–æ–π —Å–µ–∫—Ü–∏–∏ */
}



.toggle-btn {
    background: none;
    border: none;
    font-size: 16px;
    cursor: pointer;
    color: var(--secondary);
    padding: 4px 8px;
    border-radius: 6px;
}

.toggle-btn:hover {
    background: var(--border);
}

/* –°—Ç–∏–ª—å –¥–ª—è —Å–≤–µ—Ä–Ω—É—Ç–æ–≥–æ –±–ª–æ–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ */
.settings-section.collapsed #settingsContent {
    display: none;
}

.setting-item {
    margin-bottom: 16px;
}

.setting-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: var(--text);
}

.radio-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.radio-label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 4px 8px;
    border-radius: 6px;
}

.radio-label:hover {
    background: var(--border);
}

.input-field {
    width: 100%;
    max-width: 200px;
    padding: 8px 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 14px;
}

.import-textarea {
    width: 100%;
    min-height: 120px;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-family: monospace;
    font-size: 13px;
    resize: vertical;
    margin-bottom: 12px;
}

.button-group {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
}

.btn:hover {
    transform: translateY(-1px);
    box-shadow: var(--shadow);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-hover);
}

.btn-success {
    background: var(--success);
    color: white;
}

.btn-success:hover {
    background: var(--success-hover);
}

.btn-warning {
    background: var(--warning);
    color: white;
}

.btn-warning:hover {
    background: var(--warning-hover);
}

.btn-danger {
    background: var(--danger);
    color: white;
}

.btn-danger:hover {
    background: var(--danger-hover);
}

.btn-info {
    background: var(--info);
    color: white;
}

.btn-info:hover {
    background: var(--info-hover);
}

.btn-secondary {
    background: var(--secondary);
    color: white;
}

.btn-secondary:hover {
    background: var(--secondary-hover);
}

/* –ñ—É—Ä–Ω–∞–ª */
.log-container {
    padding: 12px;
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    min-height: 0;
    background: white;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 12px;
    line-height: 1.5;
}

.log-entry {
    padding: 6px 0;
    border-bottom: 1px solid var(--border);
    font-family: monospace;
}

.log-entry:last-child {
    border-bottom: none;
}

.log-level-info {
    color: var(--text);
}

.log-level-success {
    color: var(--success);
    font-weight: 500;
}

.log-level-warn {
    color: var(--warning);
}

.log-level-error {
    color: var(--danger);
    font-weight: 500;
}

/* Placeholder –¥–ª—è –∂—É—Ä–Ω–∞–ª–∞ */
.log-placeholder {
    color: var(--secondary);
    font-style: italic;
    text-align: center;
    padding: 20px 0;
}

#tableSection {
    /* –ü–æ–∑–≤–æ–ª—è–µ–º —Å–µ–∫—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–∂–µ —Ä–∞—Å—Ç–∏ –∏ —Å–∂–∏–º–∞—Ç—å—Å—è, –Ω–æ —Å –º–µ–Ω—å—à–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º */
    flex: 2;
    /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
    min-height: 150px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* –°–∫—Ä—ã–≤–∞–µ–º –ø–µ—Ä–µ–ø–æ–ª–Ω—è—é—â–∏–π –∫–æ–Ω—Ç–µ–Ω—Ç —Å–∞–º–æ–π —Å–µ–∫—Ü–∏–∏ */
}

#tableSection .section-header {
    margin-bottom: 8px;
}

/* –¢–∞–±–ª–∏—Ü–∞ */
.table-container {
    flex: 1;
    overflow: auto;
    min-height: 0;
    border: 1px solid var(--border);
    border-radius: 8px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12px;
    height: 100%;
}

.data-table th,
.data-table td {
    padding: 8px;
    text-align: left;
    border: 1px solid var(--border);
}

.data-table th {
    background-color: var(--card);
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
}

.data-table tr:nth-child(even) {
    background-color: #fafafa;
}

/* Placeholder –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
.table-placeholder td {
    text-align: center;
    color: var(--secondary);
    font-style: italic;
    padding: 40px 20px;
}

.data-table img {
    width: 60px;
    height: 34px;
    object-fit: cover;
    border-radius: 4px;
}

/* –°–∫—Ä–æ–ª–ª–±–∞—Ä—ã */
.log-container::-webkit-scrollbar,
.table-container::-webkit-scrollbar {
    width: 6px;
}

.log-container::-webkit-scrollbar-thumb,
.table-container::-webkit-scrollbar-thumb {
    background-color: var(--border);
    border-radius: 3px;
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.css ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.html ===

<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ü–∞—Ä—Å–µ—Ä</title>
    <link rel="stylesheet" href="popup.css">
</head>

<body>
    <div class="app-container">
        <header class="app-header">
            <h1 class="app-title">üìπ YouTube –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ü–∞—Ä—Å–µ—Ä</h1>
        </header>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (Collapsible) -->
        <section id="settingsSection" class="section settings-section">
            <div class="section-header">
                <h2 class="section-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button id="toggleSettingsBtn" class="toggle-btn">‚ñ≤</button>
            </div>
            <div id="settingsContent" class="section-content">
                <!-- –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ -->
                <div class="setting-item">
                    <label class="setting-label">–ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≤–∏–¥–µ–æ:</label>
                    <div class="radio-group">
                        <!-- –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∏ value -->
                        <label class="radio-label">
                            <input type="radio" name="selectionMode" value="all_videos" checked>
                            –ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –≤–∏–¥–µ–æ
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="selectionMode" value="current_recommendations">
                            –ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥–±–æ—Ä–∫–∏
                        </label>
                    </div>
                </div>

                <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π -->
                <div class="setting-item">
                    <label class="setting-label" for="iterationsInput">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π:</label>
                    <input type="number" id="iterationsInput" class="input-field" value="10" min="1" max="1000">
                </div>

                <!-- –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö -->
                <div class="setting-item">
                    <label class="setting-label">–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (CSV/TSV):</label>
                    <textarea id="importTextarea" class="import-textarea"
                        placeholder="–í—Å—Ç–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ... –ù–∞–∑–≤–∞–Ω–∏–µ,ID,–ü—Ä–æ—Å–º–æ—Ç—Ä—ã,–ö–∞–Ω–∞–ª,–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ,–ú–∏–Ω–∏–∞—Ç—é—Ä–∞"></textarea>
                    <div class="button-group">
                        <button id="importDataBtn" class="btn btn-primary">üìÇ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                        <button id="clearImportedBtn" class="btn btn-secondary">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
        <section id="controlSection" class="section control-section">
            <div class="section-header">
                <h2 class="section-title">üéõÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            </div>
            <div class="control-group">
                <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ -->
                <div class="setting-item">
                    <label class="setting-label" for="scenarioSelector">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ü–µ–Ω–∞—Ä–∏–π:</label>
                    <select id="scenarioSelector" class="input-field">
                        <option value="parse-recommendation">–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</option>
                        <option value="test-countdown">–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç</option>
                        <!-- –í –±—É–¥—É—â–µ–º –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –æ–ø—Ü–∏–π -->
                    </select>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
                <div class="button-group">
                    <!-- –ò–∑–º–µ–Ω—è–µ–º ID –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—É—Å–∫–∞ -->
                    <button id="runScenarioBtn" class="btn btn-success">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
                    <!-- –ö–Ω–æ–ø–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏, –∫–∞–∫ –∏ —Ä–∞–Ω—å—à–µ -->
                    <button id="stopBtn" class="btn btn-warning" disabled>‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
                    <button id="copyTableBtn" class="btn btn-info">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
                    <button id="clearTableBtn" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
                    <button id="clearLogBtn" class="btn btn-secondary">üßπ –û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
                </div>
            </div>
        </section>

        <!-- –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π -->
        <section id="logSection" class="section log-section">
            <div class="section-header">
                <h2 class="section-title">üìã –ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h2>
            </div>
            <div id="logContainer" class="log-container">
                <!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                <div class="log-placeholder">–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç</div>
            </div>
        </section>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
        <section id="tableSection" class="section table-section">
            <div class="section-header">
                <h2 class="section-title">üìä –°–ø–∞—Ä—Å–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h2>
            </div>
            <div class="table-container">
                <table id="dataTable" class="data-table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                            <th>ID</th>
                            <th>–ü—Ä–æ—Å–º–æ—Ç—Ä—ã</th>
                            <th>–ö–∞–Ω–∞–ª</th>
                            <th>–ò—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ</th>
                            <th>–ú–∏–Ω–∏–∞—Ç—é—Ä–∞</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –≤—Å—Ç–∞–≤–ª—è—Ç—å—Å—è —Å—é–¥–∞ -->
                        <tr class="table-placeholder">
                            <td colspan="6">–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script type="module" src="./popup.js"></script>
</body>

</html>

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.html ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.js ===


// popup/popup.js
import { SettingsSection } from './components/SettingsSection.js';
import { ControlSection } from './components/ControlSection.js';
import { LogSection } from './components/LogSection.js';
import { TableSection } from './components/TableSection.js';

class PopupApp {
    constructor() {
        this.initElements();
        this.initComponents(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        this.bindEvents(); // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è popup-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        this.loadState(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ UI
        this.updateScenarioControlButtons(false);
        this.checkScenarioStatusOnLoad();
        this.isScenarioLaunchInProgress = false;
    }

    initElements() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –Ω–∞ DOM —ç–ª–µ–º–µ–Ω—Ç—ã, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—â–∏–µ popup –Ω–∞–ø—Ä—è–º—É—é
        this.settingsSection = document.getElementById('settingsSection');
        this.settingsContent = document.getElementById('settingsContent');
        this.toggleSettingsBtn = document.getElementById('toggleSettingsBtn');

        this.selectionModeRadios = document.querySelectorAll('input[name="selectionMode"]');
        this.iterationsInput = document.getElementById('iterationsInput');
        this.importTextarea = document.getElementById('importTextarea');
        this.importDataBtn = document.getElementById('importDataBtn');
        this.clearImportedBtn = document.getElementById('clearImportedBtn');

        this.runScenarioBtn = document.getElementById('runScenarioBtn');
        this.stopBtn = document.getElementById('stopBtn');
        this.copyTableBtn = document.getElementById('copyTableBtn');
        this.clearTableBtn = document.getElementById('clearTableBtn');
        this.clearLogBtn = document.getElementById('clearLogBtn');

        // –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

        this.scenarioSelector = document.getElementById('scenarioSelector');

        document.addEventListener('importData', (e) => {
            this.handleImportData(e.detail); // –ü–µ—Ä–µ–¥–∞—ë–º detail –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç
        });
    }

    initComponents() {
        // –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤. –û–Ω–∏ —Å–∞–º–∏ –ø—Ä–∏–≤—è–∂—É—Ç —Å–≤–æ–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∏ DOM.
        this.settings = new SettingsSection();
        this.control = new ControlSection();
        this.logs = new LogSection();
        this.table = new TableSection();

        // –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º –∑–∞–≥—Ä—É–∑–∫—É –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
        // –≠—Ç–æ –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ updateLogs –∏ updateTable
        this.logs.loadInitialLogs();
        this.table.loadInitialData();
    }

    bindEvents() {
        // --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ UI popup-–∞ ---
        this.selectionModeRadios.forEach(radio => {
            radio.addEventListener('change', () => this.saveSettings());
        });
        this.iterationsInput.addEventListener('change', () => this.saveSettings());
        this.importDataBtn.addEventListener('click', () => this.handleImport());
        this.clearImportedBtn.addEventListener('click', () => this.handleClearImported());

        this.runScenarioBtn.addEventListener('click', () => this.handleRunScenario());
        this.stopBtn.addEventListener('click', () => this.handleStop());
        this.copyTableBtn.addEventListener('click', () => this.handleCopyTable());
        this.clearTableBtn.addEventListener('click', () => this.handleClearTable());
        this.clearLogBtn.addEventListener('click', () => this.handleClearLog());

        this.runScenarioBtn.addEventListener('click', () => this.handleRunScenario());

        // --- –°–ª—É—à–∞—Ç–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç background ---
        this.addMessageListener();
    }

    saveSettings() {
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        const isSettingsCollapsed = this.settingsSection.classList.contains('collapsed');

        const state = {
            isSettingsCollapsed: isSettingsCollapsed,
            selectionMode: document.querySelector('input[name="selectionMode"]:checked')?.value || 'smart',
            iterations: this.iterationsInput.value,
        };


        try {
            localStorage.setItem('popupSettings', JSON.stringify(state));
        } catch (e) {
            console.error("saveSettings: –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ localStorage:", e);
        }
    }

    loadState() {

        const savedStateJson = localStorage.getItem('popupSettings');
        if (savedStateJson) {
            try {
                const state = JSON.parse(savedStateJson);
                if (state.isSettingsCollapsed === true) {
                    this.settingsSection.classList.add('collapsed');
                    this.toggleSettingsBtn.textContent = 'üîΩ';
                } else {
                    this.settingsSection.classList.remove('collapsed');
                    this.toggleSettingsBtn.textContent = '‚ñ≤';
                }

                // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if (state.selectionMode) {
                    const radio = document.querySelector(`input[name="selectionMode"][value="${state.selectionMode}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                }

                if (state.iterations) {
                    this.iterationsInput.value = state.iterations;
                }
            } catch (e) {
                console.error("loadState: –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", e);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                // –∏ –ø–µ—Ä–µ—Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ö
            }
        } else {
            this.settingsSection.classList.remove('collapsed'); // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç–æ
            this.toggleSettingsBtn.textContent = '‚ñ≤';
            // –î—Ä—É–≥–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —É–∂–µ –∑–∞–¥–∞–Ω—ã –≤ HTML
        }
    }

    // --- Message Listener ---
    addMessageListener() {
        this.messageListener = (request, sender, sendResponse) => {
            if (request.type === 'scenarioStatus') {
                console.log("PopupApp: Received scenarioStatus message", request);
                if (request.status === 'started') {
                    this.updateScenarioControlButtons(true);
                } else if (request.status === 'stopped' || request.status === 'finished') {
                    console.log("PopupApp: Updating buttons to STOPPED state based on scenarioStatus"); // <-- –õ–æ–≥
                    this.updateScenarioControlButtons(false);
                }
                // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å—Ü–µ–Ω–∞—Ä–∏—è, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
                if (request.message) {
                    document.dispatchEvent(new CustomEvent('log', { detail: { message: request.message, level: request.level || 'info' } }));
                }
                return;
            }

            if (request.type === 'dataUpdated') {
                this.table.loadInitialData();
            }

            if (request.type === 'dataCleared') {
                document.dispatchEvent(new CustomEvent('clearTable'));
            }

            if (request.type === 'newLog' && request.log) {
                document.dispatchEvent(new CustomEvent('log', { detail: request.log }));
            }

            if (request.type === 'logsCleared') {
                document.dispatchEvent(new CustomEvent('clearLog'));
            }

            if (request.type === 'dataCleared') {
                document.dispatchEvent(new CustomEvent('clearTable'));
            }

            // TODO: –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
            // if (request.type === 'analysisStatus') { ... }
            // if (request.type === 'dataUpdated') { 
            //    document.dispatchEvent(new CustomEvent('updateTable', { detail: newDataArray }));
            // }
        };

        chrome.runtime.onMessage.addListener(this.messageListener);
    }

    // --- Button Handlers (–∏–º–∏—Ç–∞—Ü–∏—è / –∑–∞–≥–ª—É—à–∫–∏) ---
    // –≠—Ç–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç CustomEvent –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏
    // –∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞—é—Ç chrome.runtime.sendMessage

    handleImport() {
        const text = this.importTextarea.value.trim();
        if (!text) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', level: 'error' } }));
            return;
        }
        document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö (–∏–º–∏—Ç–∞—Ü–∏—è): ${text.split('\n').length - 1} —Å—Ç—Ä–æ–∫`, level: 'success' } }));
        this.importTextarea.value = '';
        // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç sendMessage –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ background
        // –∏ –∑–∞—Ç–µ–º —Å–æ–±—ã—Ç–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        setTimeout(() => {
            this.table.loadInitialData(); // –ò–º–∏—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
        }, 500);
    }

    handleClearImported() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã (–∏–º–∏—Ç–∞—Ü–∏—è)', level: 'success' } }));
        // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∑–¥–µ—Å—å –±—É–¥–µ—Ç sendMessage –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –≤ background
    }

    async handleRunScenario() {
        if (this.isScenarioLaunchInProgress) {
            console.warn("[PopupApp] –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è —É–∂–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫.");
            return;
        }
        this.isScenarioLaunchInProgress = true; // <-- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥
        // 1. –ü–æ–ª—É—á–∞–µ–º ID –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä–∏—è
        const selectedScenarioId = this.scenarioSelector.value;
        if (!selectedScenarioId) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –ù–µ –≤—ã–±—Ä–∞–Ω —Å—Ü–µ–Ω–∞—Ä–∏–π –¥–ª—è –∑–∞–ø—É—Å–∫–∞', level: 'error' } }));
            return;
        }

        // 2. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ UI
        const iterations = parseInt(this.iterationsInput.value) || 10;
        const mode = document.querySelector('input[name="selectionMode"]:checked')?.value || 'all_videos';

        // 3. –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ
        const scenarioName = this.scenarioSelector.options[this.scenarioSelector.selectedIndex].text;
        document.dispatchEvent(new CustomEvent('log', { detail: { message: `üì§ –ó–∞–ø—É—Å–∫ —Å—Ü–µ–Ω–∞—Ä–∏—è "${scenarioName}": ${iterations} –∏—Ç–µ—Ä–∞—Ü–∏–π, —Ä–µ–∂–∏–º: ${mode}`, level: 'info' } }));

        try {
            // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
            const response = await chrome.runtime.sendMessage({
                action: "runScenario",
                scenarioId: selectedScenarioId,
                params: {
                    iterations,
                    mode,
                    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞ (–º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –ø–æ–∑–∂–µ)
                    count: 5,
                    delayMs: 1500,
                    step: 1000
                }
            });

            if (response && response.status === "started") {
                console.log("[PopupApp] –°—Ü–µ–Ω–∞—Ä–∏–π —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –≤ background, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫.");
                // 5. –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                this.updateScenarioControlButtons(true);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ –°—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω. ID: ${response.instanceId}`, level: 'success' } }));
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ';
                console.error("[PopupApp] –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è: ${errorMsg}`, level: 'error' } }));
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
                this.updateScenarioControlButtons(false);
            }

        } catch (err) {
            console.error("[PopupApp] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏—è:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏—è: ${err.message}`, level: 'error' } }));
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            this.updateScenarioControlButtons(false);
        } finally {
            // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ, –ø–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–ø—É—Å–∫–∞
            this.isScenarioLaunchInProgress = false; // <-- –°–±—Ä–æ—Å–∏—Ç—å —Ñ–ª–∞–≥
        }
    }

    async handleStop() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤...', level: 'info' } }));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
            const response = await chrome.runtime.sendMessage({
                action: "stopAllScenarios"
            });

            if (response && response.status === "success") {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ ${response.message}`, level: 'warn' } }));
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
                this.updateScenarioControlButtons(false);
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ';
                console.error("[PopupApp] –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${errorMsg}`, level: 'error' } }));
                // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–∑–∞–ø—É—â–µ–Ω–æ", —Ç–∞–∫ –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
            }
        } catch (err) {
            console.error("[PopupApp] –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${err.message}`, level: 'error' } }));
            // –û—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "–∑–∞–ø—É—â–µ–Ω–æ", —Ç–∞–∫ –∫–∞–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å
        }
    }

    async handleCopyTable() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è...', level: 'info' } }));
        try {
            const response = await chrome.runtime.sendMessage({ action: "copyTableData" });
            if (response.status === "success") {
                await navigator.clipboard.writeText(response.data);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', level: 'success' } }));
            } else {
                throw new Error(response.message);
            }
        } catch (err) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, level: 'error' } }));
        }
    }

    async handleClearTable() {
        document.dispatchEvent(new CustomEvent('log', { detail: { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—á–∏—Å—Ç–∫—É —Ç–∞–±–ª–∏—Ü—ã...', level: 'info' } }));
        try {
            const response = await chrome.runtime.sendMessage({ action: "clearTableData" });
            if (response.status === "success") {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –¢–∞–±–ª–∏—Ü–∞ –æ—á–∏—â–µ–Ω–∞', level: 'success' } }));
                // –°–æ–æ–±—â–∞–µ–º TableSection –æ–± –æ—á–∏—Å—Ç–∫–µ
                document.dispatchEvent(new CustomEvent('clearTable'));
            } else {
                throw new Error(response.message);
            }
        } catch (err) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${err.message}`, level: 'error' } }));
        }
    }

    async handleClearLog() {
        // –í —Ä–µ–∞–ª—å–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏ popup –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
        // –∏ background –ø–æ—Ç–æ–º –ø—Ä–∏—Å–ª–∞–µ—Ç 'logsCleared' –∏–ª–∏ popup —Å–∞–º –æ–±–Ω–æ–≤–∏—Ç UI
        try {
            await chrome.storage.local.remove(['appLogs']);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚úÖ –ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', level: 'success' } }));
            // –°–æ–æ–±—â–∞–µ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—É –∂—É—Ä–Ω–∞–ª–∞ –æ–± –æ—á–∏—Å—Ç–∫–µ
            document.dispatchEvent(new CustomEvent('clearLog'));
        } catch (err) {
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –∂—É—Ä–Ω–∞–ª–∞: ${err.message}`, level: 'error' } }));
        }
    }

    async handleImportData(eventDetail) {
        const dataToImport = eventDetail && eventDetail.data;

        if (!dataToImport || !Array.isArray(dataToImport)) {
            console.error("[PopupApp] handleImportData: –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º", dataToImport);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: '‚ùå –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', level: 'error' } }));
            return;
        }

        document.dispatchEvent(new CustomEvent('log', { detail: { message: `üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ ${dataToImport.length} –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞...`, level: 'info' } }));

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ background –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            const response = await chrome.runtime.sendMessage({
                action: "importTableData", // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∞
                data: dataToImport // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –Ω–∞–ø—Ä—è–º—É—é
            });

            if (response && response.status === "success") {
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚úÖ ${response.count} –∑–∞–ø–∏—Å–µ–π —É—Å–ø–µ—à–Ω–æ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã`, level: 'success' } }));
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ popup
                this.table.loadInitialData();
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error("[PopupApp] –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –≤ background:", errorMsg);
                document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${errorMsg}`, level: 'error' } }));
            }
        } catch (err) {
            console.error("[PopupApp] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ background:", err);
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å background: ${err.message}`, level: 'error' } }));
        }
    }

    /**
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏—è–º–∏.
     * @param {boolean} isRunning - –ó–∞–ø—É—â–µ–Ω –ª–∏ —Å–µ–π—á–∞—Å –∫–∞–∫–æ–π-–ª–∏–±–æ —Å—Ü–µ–Ω–∞—Ä–∏–π.
     */
    updateScenarioControlButtons(isRunning) {
        if (this.runScenarioBtn && this.stopBtn) {
            this.runScenarioBtn.disabled = isRunning;
            this.stopBtn.disabled = !isRunning;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ popup.
     * –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ.
     */
    async checkScenarioStatusOnLoad() {
        console.log("[PopupApp] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ...");
        try {
            const response = await chrome.runtime.sendMessage({
                action: "getScenarioStatus"
            });

            if (response && response.status === "success") {
                const isRunning = response.isRunning;
                console.log(`[PopupApp] –°—Ç–∞—Ç—É—Å —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ: isRunning=${isRunning}`);
                this.updateScenarioControlButtons(isRunning);

                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è
                if (isRunning) {
                    const count = response.runningScenarios?.length || 1;
                    document.dispatchEvent(new CustomEvent('log', {
                        detail: {
                            message: `‚ÑπÔ∏è –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ popup –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–∞–ø—É—â–µ–Ω–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤: ${count}. –ö–Ω–æ–ø–∫–∞ "–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å" –∞–∫—Ç–∏–≤–Ω–∞.`,
                            level: 'info'
                        }
                    }));
                }
            } else {
                console.warn("[PopupApp] –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", response?.message);
                // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–Ω–µ –∑–∞–ø—É—â–µ–Ω–æ)
                this.updateScenarioControlButtons(false);
            }
        } catch (err) {
            console.error("[PopupApp] –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:", err);
            // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –≤ –Ω–∞—á–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (–Ω–µ –∑–∞–ø—É—â–µ–Ω–æ)
            this.updateScenarioControlButtons(false);
        }
    }
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
document.addEventListener('DOMContentLoaded', () => {
    new PopupApp();
});


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\popup.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\ControlSection.js ===

export class ControlSection {
    constructor() {
        // –û–±–Ω–æ–≤–ª—è–µ–º ID —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å popup.html
        this.runScenarioBtn = document.getElementById('runScenarioBtn'); // <-- –ò–∑–º–µ–Ω–µ–Ω–æ
        this.stopBtn = document.getElementById('stopBtn');
        this.copyTableBtn = document.getElementById('copyTableBtn');
        this.clearTableBtn = document.getElementById('clearTableBtn');
        this.clearLogBtn = document.getElementById('clearLogBtn');

        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
        this.scenarioSelector = document.getElementById('scenarioSelector'); // <-- –ù–æ–≤–æ–µ

        this.init();
    }

    init() {
        // –°–ª—É—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –æ—Ç popup –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
        document.addEventListener('control:enableStart', () => this.enableStart());
        document.addEventListener('control:disableStart', () => this.disableStart());

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π UI

        this.stopBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('stopAnalysis')); // –≠—Ç–æ —Å–æ–±—ã—Ç–∏–µ —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è
        });

        this.copyTableBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('copyTable'));
        });

        this.clearTableBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('clearTable'));
        });

        this.clearLogBtn.addEventListener('click', () => {
            document.dispatchEvent(new CustomEvent('clearLog'));
        });
    }

    handleStart() {
        const iterations = parseInt(document.getElementById('iterationsInput').value) || 10;
        const mode = document.querySelector('input[name="selectionMode"]:checked')?.value || 'smart';

        this.dispatchEvent('startAnalysis', { iterations, mode });
        this.startBtn.disabled = true;
        this.stopBtn.disabled = false;
    }

    handleStop() {
        this.dispatchEvent('stopAnalysis');
        this.startBtn.disabled = false;
        this.stopBtn.disabled = true;
    }

    handleCopyTable() {
        this.dispatchEvent('copyTable');
    }

    handleClearTable() {
        this.dispatchEvent('clearTable');
    }

    handleClearLog() {
        this.dispatchEvent('clearLog');
    }

    enableStart() {
        // –õ–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ PopupApp.updateScenarioControlButtons
        if (this.runScenarioBtn) this.runScenarioBtn.disabled = false;
        if (this.stopBtn) this.stopBtn.disabled = true;
    }

    disableStart() {
        // –õ–æ–≥–∏–∫–∞ –≤–∫–ª—é—á–µ–Ω–∞ –≤ PopupApp.updateScenarioControlButtons
        if (this.runScenarioBtn) this.runScenarioBtn.disabled = true;
        if (this.stopBtn) this.stopBtn.disabled = false;
    }

    dispatchEvent(type, detail) {
        document.dispatchEvent(new CustomEvent(type, { detail }));
    }
}


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\ControlSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\LogSection.js ===

// popup/components/LogSection.js
export class LogSection {
    constructor() {
        this.container = document.getElementById('logContainer');
        this.init();
    }

    init() {
        // –°–ª—É—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤
        document.addEventListener('log', (e) => {
            this.addLog(e.detail);
        });
        document.addEventListener('clearLog', () => this.clear());
        // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏
        this.loadInitialLogs();
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
     */
    async loadInitialLogs() {
        try {
            // –ü–æ–ª—É—á–∞–µ–º –ª–æ–≥–∏ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ chrome.storage.local
            // –í –±—É–¥—É—â–µ–º —ç—Ç–æ –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –≤—ã–∑–æ–≤ –Ω–æ–≤–æ–≥–æ Logger API
            const result = await chrome.storage.local.get(['appLogs']);
            const logs = result.appLogs || [];

            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —É–±–∏—Ä–∞–µ–º placeholder
            this.container.innerHTML = '';

            if (logs.length === 0) {
                // –ï—Å–ª–∏ –ª–æ–≥–æ–≤ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
                this.#showPlaceholder();
            } else {
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N –ª–æ–≥–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100
                const logsToShow = logs.slice(-100);
                logsToShow.forEach(logEntry => {
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥ addLog, –Ω–æ –±–µ–∑ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                    this.#renderLogEntry(logEntry);
                });
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ—Ö –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤
                this.container.scrollTop = this.container.scrollHeight;
            }
        } catch (error) {
            console.error("LogSection: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤:", error);
            // –î–∞–∂–µ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
            this.#showPlaceholder();
            // –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –≤ UI
            this.addLog({ message: `‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∂—É—Ä–Ω–∞–ª–∞: ${error.message}`, level: 'error' });
        }
    }

    /**
     * –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –≤ –∂—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π, —É—á–∏—Ç—ã–≤–∞—è –ø–æ–∑–∏—Ü–∏—é –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
     * @param {Object} logEntry - –û–±—ä–µ–∫—Ç –∑–∞–ø–∏—Å–∏ –ª–æ–≥–∞.
     * @param {string} logEntry.message - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.
     * @param {string} logEntry.level - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∞ ('info', 'success', 'warn', 'error').
     * @param {number} logEntry.timestamp - –í—Ä–µ–º–µ–Ω–Ω–∞—è –º–µ—Ç–∫–∞.
     */
    addLog({ message, level = 'info', timestamp = Date.now() }) {
        // –£–¥–∞–ª—è–µ–º placeholder, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        const placeholder = this.container.querySelector('.log-placeholder');
        if (placeholder) {
            placeholder.remove();
        }

        const entry = document.createElement('div');
        entry.className = `log-entry log-level-${level}`;
        const time = new Date(timestamp).toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;

        // --- –õ–æ–≥–∏–∫–∞ —É–º–Ω–æ–π –ø—Ä–æ–∫—Ä—É—Ç–∫–∏ ---
        const container = this.container;
        const isScrolledToBottom = (container.scrollHeight - container.clientHeight) <= (container.scrollTop + 1);
        container.appendChild(entry);
        if (isScrolledToBottom) {
            container.scrollTop = container.scrollHeight;
        }
        // ---
    }

    /**
     * –û—á–∏—â–∞–µ—Ç –∂—É—Ä–Ω–∞–ª –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder.
     */
    clear() {
        this.container.innerHTML = '';
        this.#showPlaceholder();
        // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–∫—Ç –æ—á–∏—Å—Ç–∫–∏
        // this.addLog({ message: 'üßπ –ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', level: 'info' });
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---

    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder "–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç".
     */
    #showPlaceholder() {
        const placeholder = document.createElement('div');
        placeholder.className = 'log-placeholder';
        placeholder.textContent = '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç';
        this.container.appendChild(placeholder);
    }

    /**
     * –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏ –±–µ–∑ –ª–æ–≥–∏–∫–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏.
     * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –ª–æ–≥–æ–≤.
     * @private
     */
    #renderLogEntry({ message, level = 'info', timestamp = Date.now() }) {
        // Placeholder —É–¥–∞–ª—è–µ—Ç—Å—è –ø–µ—Ä–≤–æ–π –∑–∞–ø–∏—Å—å—é
        const placeholder = this.container.querySelector('.log-placeholder');
        if (placeholder) {
            placeholder.remove();
        }

        const entry = document.createElement('div');
        entry.className = `log-entry log-level-${level}`;
        const time = new Date(timestamp).toLocaleTimeString();
        entry.textContent = `[${time}] ${message}`;
        this.container.appendChild(entry);
        // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ù–ï –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–¥–µ—Å—å
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\LogSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\SettingsSection.js ===

export class SettingsSection {
    constructor() {
        this.element = document.getElementById('settingsSection');
        this.toggleBtn = document.getElementById('toggleSettingsBtn');
        this.selectionModeRadios = document.querySelectorAll('input[name="selectionMode"]');
        this.iterationsInput = document.getElementById('iterationsInput');
        this.importTextarea = document.getElementById('importTextarea');
        this.importDataBtn = document.getElementById('importDataBtn');
        this.clearImportedBtn = document.getElementById('clearImportedBtn');

        this.init();
    }

    init() {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage
        this.restoreState();

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
        this.toggleBtn.addEventListener('click', () => this.toggle());
        this.selectionModeRadios.forEach(radio => {
            radio.addEventListener('change', () => this.saveState());
        });
        this.iterationsInput.addEventListener('change', () => this.saveState());
        this.importDataBtn.addEventListener('click', () => this.handleImport());
        this.clearImportedBtn.addEventListener('click', () => this.handleClearImported());

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        this.iterationsInput.addEventListener('blur', () => this.saveState());
    }

    toggle() {
        const isCollapsed = this.element.classList.contains('collapsed');
        if (isCollapsed) {
            this.expand();
        } else {
            this.collapse();
        }
        this.saveState();
    }

    collapse() {
        this.element.classList.add('collapsed');
        this.toggleBtn.textContent = 'üîΩ';
    }

    expand() {
        this.element.classList.remove('collapsed');
        this.toggleBtn.textContent = '‚ñ≤';
    }

    saveState() {
        const state = {
            isCollapsed: this.element.classList.contains('collapsed'),
            selectionMode: document.querySelector('input[name="selectionMode"]:checked')?.value || 'smart',
            iterations: this.iterationsInput.value,
        };
        localStorage.setItem('settingsState', JSON.stringify(state));
    }

    restoreState() {
        const saved = localStorage.getItem('settingsState');
        if (saved) {
            const state = JSON.parse(saved);
            if (state.isCollapsed) {
                this.collapse();
            } else {
                this.expand();
            }
            if (state.selectionMode) {
                const radio = document.querySelector(`input[name="selectionMode"][value="${state.selectionMode}"]`);
                if (radio) radio.checked = true;
            }
            if (state.iterations) {
                this.iterationsInput.value = state.iterations;
            }
        }
    }

    handleImport() {
        const text = this.importTextarea.value.trim();

        if (!text) {
            this.dispatchEvent('log', { message: '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', level: 'error' });
            return;
        }

        try {
            const data = this.parseCSV(text);

            if (data.length === 0) {
                this.dispatchEvent('log', { message: '‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞', level: 'error' });
                return;
            }

            const dataWithFlag = data.map((item, index) => {
                const newItem = {
                    ...item,
                    isImported: true, // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥
                    timestamp: item.timestamp || Date.now() // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ timestamp –µ—Å—Ç—å
                };
                return newItem;
            });

            this.dispatchEvent('importData', { data: dataWithFlag }); // –í–ê–ñ–ù–û: –∫–ª—é—á 'data'
            this.importTextarea.value = '';
            this.dispatchEvent('log', { message: `‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${dataWithFlag.length} –∑–∞–ø–∏—Å–µ–π`, level: 'success' });
        } catch (err) {
            console.error("[SettingsSection] –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞:", err);
            this.dispatchEvent('log', { message: `‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: ${err.message}`, level: 'error' });
        }
    }

    async handleClearImported() {
        console.log("[SettingsSection] –ù–∞—á–∞–ª–æ handleClearImported");
        this.dispatchEvent('log', { message: 'üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ –æ—á–∏—Å—Ç–∫—É –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...', level: 'info' });

        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background
            const response = await chrome.runtime.sendMessage({
                action: "clearImportedTableData"
            });

            if (response && response.status === "success") {
                console.log("[SettingsSection] –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã –≤ background");
                this.dispatchEvent('log', { message: '‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã', level: 'success' });
                // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ, –µ—Å–ª–∏ –¥—Ä—É–≥–∏–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å
                // this.dispatchEvent('importedDataCleared');
            } else {
                const errorMsg = response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
                console.error("[SettingsSection] –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –≤ background:", errorMsg);
                this.dispatchEvent('log', { message: `‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏: ${errorMsg}`, level: 'error' });
            }
        } catch (err) {
            console.error("[SettingsSection] –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥—ã –≤ background:", err);
            this.dispatchEvent('log', { message: `‚ùå –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏: ${err.message}`, level: 'error' });
        }
    }

    parseCSV(text) {
        const lines = text.split(/\r?\n/);
        if (lines.length === 0) {
            throw new Error('–ü—É—Å—Ç–æ–π —Ñ–∞–π–ª');
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º ';', –∑–∞—Ç–µ–º ','
        let delimiter = ';';
        if (lines[0].includes(',') && !lines[0].includes(';')) {
            delimiter = ',';
        }

        const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase());

        const required = ['–Ω–∞–∑–≤–∞–Ω–∏–µ', 'id', '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã', '–∫–∞–Ω–∞–ª', '–∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ', '–º–∏–Ω–∏–∞—Ç—é—Ä–∞'];
        const fieldMap = {
            '–Ω–∞–∑–≤–∞–Ω–∏–µ': 'title',
            'id': 'videoId',
            '–ø—Ä–æ—Å–º–æ—Ç—Ä—ã': 'views',
            '–∫–∞–Ω–∞–ª': 'channelName',
            '–∏—Å—Ö–æ–¥–Ω–æ–µ –≤–∏–¥–µ–æ': 'sourceVideoId',
            '–º–∏–Ω–∏–∞—Ç—é—Ä–∞': 'thumbnailUrl'
        };

        const indices = {};
        required.forEach(field => {
            const index = headers.findIndex(h => h === field);
            if (index === -1) {
                console.error("[SettingsSection] –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞:", field);
                throw new Error(`–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞: ${field}`);
            }
            indices[field] = index;
        });

        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) {
                continue;
            }
            const cells = line.split(delimiter).map(cell => {
                // –£–±–∏—Ä–∞–µ–º –æ–∫—Ä—É–∂–∞—é—â–∏–µ –∫–∞–≤—ã—á–∫–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
                let trimmed = cell.trim();
                if (trimmed.startsWith('"') && trimmed.endsWith('"')) {
                    trimmed = trimmed.substring(1, trimmed.length - 1);
                }
                return trimmed;
            });

            if (cells.length < headers.length) {
                console.warn(`[SettingsSection] –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —è—á–µ–µ–∫ –≤ —Å—Ç—Ä–æ–∫–µ ${i}, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º`);
                continue; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —è—á–µ–µ–∫
            }

            const item = {};
            required.forEach(field => {
                const index = indices[field];
                item[fieldMap[field]] = cells[index] ? cells[index] : '';
            });
            data.push(item);
        }
        return data;
    }

    dispatchEvent(type, detail) {
        document.dispatchEvent(new CustomEvent(type, { detail }));
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\SettingsSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\TableSection.js ===

// popup/components/TableSection.js

export class TableSection {
    constructor() {
        this.tableBody = document.getElementById('tableBody');
        this.init();
    }

    init() {
        // –°–ª—É—à–∞–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        document.addEventListener('updateTable', (e) => this.render(e.detail));
        document.addEventListener('clearTable', () => this.clear());
        // –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ä–∞–∑—É –∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        this.loadInitialData();
    }

    /**
     * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
     * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ "—Å–≤–µ–∂–∏–µ" (–Ω–µ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ) –¥–∞–Ω–Ω—ã–µ.
     */
    async loadInitialData() {
        console.log("TableSection: –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ —Å–≤–µ–∂–∏–µ)...");
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ background –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¢–û–õ–¨–ö–û —Å–≤–µ–∂–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            const response = await chrome.runtime.sendMessage({ action: "getTableFreshData" });
            const data = response?.data || [];
            console.log(`TableSection: –ü–æ–ª—É—á–µ–Ω–æ ${data.length} —Å–≤–µ–∂–∏—Ö –∑–∞–ø–∏—Å–µ–π.`);
            this.render(data);
        } catch (error) {
            console.error("TableSection: –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–∞—á–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:", error);
            this.clear();
            document.dispatchEvent(new CustomEvent('log', { detail: { message: `‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã: ${error.message}`, level: 'error' } }));
        }
    }

    /**
     * –†–µ–Ω–¥–µ—Ä–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–±–ª–∏—Ü—É.
     * @param {Array<Object>} data - –ú–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–∏–¥–µ–æ.
     */
    render(data = []) {
        this.tableBody.innerHTML = '';
        if (data.length === 0) {
            this.#showPlaceholder();
            return;
        }

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const dataToShow = data.slice(-50); // –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50

        dataToShow.forEach(video => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${this.#escapeHtml(video.title || '')}</td>
                <td>${this.#escapeHtml(video.videoId || '')}</td>
                <td>${this.#escapeHtml(video.views || '')}</td>
                <td>${this.#escapeHtml(video.channelName || '')}</td>
                <td>${this.#escapeHtml(video.sourceVideoId || '')}</td>
                <td>
                    ${video.thumbnailUrl ?
                    `<img src="${video.thumbnailUrl}" alt="Thumbnail" onerror="this.parentElement.innerHTML='‚Äî'">` :
                    '‚Äî'}
                </td>
            `;
            this.tableBody.appendChild(row);
        });
    }

    /**
     * –û—á–∏—â–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder.
     */
    clear() {
        this.tableBody.innerHTML = '';
        this.#showPlaceholder();
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---

    /**
     * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç placeholder "–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞".
     * @private
     */
    #showPlaceholder() {
        const placeholderRow = document.createElement('tr');
        placeholderRow.className = 'table-placeholder';
        placeholderRow.innerHTML = `<td colspan="6">–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞</td>`;
        this.tableBody.appendChild(placeholderRow);
    }

    /**
     * –≠–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML-—Å—É—â–Ω–æ—Å—Ç–∏.
     * @param {string} text - –¢–µ–∫—Å—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
     * @returns {string} - –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç.
     * @private
     */
    #escapeHtml(text) {
        if (typeof text !== 'string') return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "<")
            .replace(/>/g, ">")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
}

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\popup\components\TableSection.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\parse-recommendation.js ===


// scenarios/parse-recommendation.js
import { scrollPageNTimes } from '../core/utils/scroller.js';
// import { logger } from '../background/background.js'; // –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ context.log

/**
 * @type {import('../core/types/scenario.types.js').ScenarioDefinition}
 */
export const parseRecommendationScenario = {
    id: 'parse-recommendation',
    name: '–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π',
    description: '–ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –∏ –≥–æ—Ç–æ–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞.',

    /**
     * @param {import('../core/types/scenario.types.js').ScenarioContext} context
     */
    async execute(context) {
        const { log, params = {}, tabId, abortSignal } = context;

        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∫–∞–∫ —É–∫–∞–∑–∞–Ω–æ –≤ –∑–∞–¥–∞—á–µ
        const scrollParams = {
            count: parseInt(params.count, 10) || 16,
            delayMs: parseInt(params.delayMs, 10) || 1500,
            step: parseInt(params.step, 10) || 1000
        };

        log(`üöÄ –°—Ü–µ–Ω–∞—Ä–∏–π "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π" –∑–∞–ø—É—â–µ–Ω.`, { module: 'ParseRecommendation' });
        log(`üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫—Ä–æ–ª–ª–∏–Ω–≥–∞: ${JSON.stringify(scrollParams)}`, { module: 'ParseRecommendation' });

        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª–æ –ª–∏ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É –¥–æ –Ω–∞—á–∞–ª–∞
            await abortSignal();

            // --- 1. –°–∫—Ä–æ–ª–ª–∏–Ω–≥ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
            await scrollPageNTimes(context, scrollParams.count, scrollParams.delayMs, scrollParams.step);

            // --- 2. TODO: –ü–∞—Ä—Å–∏–Ω–≥ –∏ –ø–æ–¥—Å–≤–µ—Ç–∫–∞ (–≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ) ---
            // const parsedCards = await parseAndHighlight(context);
            // log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∏ –ø–æ–¥—Å–≤–µ—á–µ–Ω–æ ${parsedCards.length} –≤–∏–¥–µ–æ.`, { module: 'ParseRecommendation' });

            // --- 3. TODO: –°–∫—Ä–∞–ø–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö (–≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ) ---
            // const scrapedData = await scrapeCards(context, parsedCards);
            // log(`üíæ –°–∫—Ä–∞–ø–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω. –ü–æ–ª—É—á–µ–Ω–æ –¥–∞–Ω–Ω—ã—Ö –ø–æ ${scrapedData.length} –≤–∏–¥–µ–æ.`, { module: 'ParseRecommendation' });

            // --- 4. TODO: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–≤ —Å–ª–µ–¥—É—é—â–µ–º —à–∞–≥–µ) ---
            // await saveData(context, scrapedData);

            log(`üéâ –°—Ü–µ–Ω–∞—Ä–∏–π "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π" —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω.`, { module: 'ParseRecommendation' });

        } catch (error) {
            if (error.message === '–°—Ü–µ–Ω–∞—Ä–∏–π –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.') {
                log(`‚èπÔ∏è –°—Ü–µ–Ω–∞—Ä–∏–π "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π" –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.`, { module: 'ParseRecommendation', level: 'warn' });
            } else {
                log(`‚ùå –û—à–∏–±–∫–∞ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ "–ü–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π": ${error.message}`, { module: 'ParseRecommendation', level: 'error' });
                throw error; // –ü–µ—Ä–µ–±—Ä–∞—Å—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ ScenarioEngine
            }
        }
    }
};


=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\parse-recommendation.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\test-countdown.js ===

// scenarios/test-countdown.js
import { logger } from '../background/background.js';
import { tableAdapter } from '../background/background.js';

// --- –ü–µ—Ä–µ–Ω–æ—Å–∏–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–Ω—É—Ç—Ä—å –º–æ–¥—É–ª—è ---
/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é —Å—Ç—Ä–æ–∫—É –∑–∞–¥–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã.
 * @param {number} length
 * @returns {string}
 */
function generateRandomString(length) {
    const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
    }
    return result;
}

/**
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤.
 * @returns {string}
 */
function generateRandomViews() {
    const num = Math.floor(Math.random() * 1000000);
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toString();
}
// --- –ö–æ–Ω–µ—Ü –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π ---

/**
 * @type {import('../core/types/scenario.types.js').ScenarioDefinition}
 */
export const testCountdownScenario = {
    id: 'test-countdown',
    name: '–¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –û–±—Ä–∞—Ç–Ω—ã–π –æ—Ç—Å—á–µ—Ç',
    description: '–°—á–∏—Ç–∞–µ—Ç –æ—Ç 1 –¥–æ N, –≥–¥–µ N - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫. –õ–æ–≥–∏—Ä—É–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º.',

    /**
     * @param {import('../core/types/scenario.types.js').ScenarioContext} context
     */
    async execute(context) {
        // 1. –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        const { log, abortSignal, params = {} } = context;

        // 2. –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        // –í–ê–ñ–ù–û: –∫–ª—é—á–∏ params –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å —Ç–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∏–∑ popup/background
        const maxCount = parseInt(params.iterations, 10) || 10;
        // –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è mode –≤ —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ª–æ–≥–æ–≤
        let selectionModeLabel = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º';
        if (params.mode === 'all_videos') {
            selectionModeLabel = '–ê–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –≤–∏–¥–µ–æ';
        } else if (params.mode === 'current_recommendations') {
            selectionModeLabel = '–ê–Ω–∞–ª–∏–∑ –≤–∏–¥–µ–æ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–æ–¥–±–æ—Ä–∫–∏';
        }
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ mode –¥–ª—è –ª–æ–≥–∏–∫–∏ (–µ—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –≤ –±—É–¥—É—â–µ–º)
        const mode = params.mode || 'all_videos';
        const sourceVideoId = 'test_source_video_id'; // –î–ª—è —Ç–µ—Å—Ç–∞

        // 3. –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ)
        log(`üöÄ –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–ø—É—â–µ–Ω.`, { module: 'TestScenario' });
        log(`üî¢ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤: ${maxCount}`, { module: 'TestScenario' });
        log(`üß† –ê–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞: ${selectionModeLabel}`, { module: 'TestScenario' });
        // 4. –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
        for (let i = 1; i <= maxCount; i++) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –±—ã–ª –ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            await abortSignal();

            log(`‚è±Ô∏è –®–∞–≥ ${i}/${maxCount}`, { module: 'TestScenario' });

            // --- –ó–∞–ø–∏—Å—å —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É ---
            try {
                const randomVideoData = {
                    videoId: `test_video_${generateRandomString(8)}`,
                    title: `–¢–µ—Å—Ç–æ–≤–æ–µ –≤–∏–¥–µ–æ ${i}: ${generateRandomString(15)}`,
                    channelName: `–¢–µ—Å—Ç–æ–≤—ã–π –∫–∞–Ω–∞–ª ${generateRandomString(5)}`,
                    views: generateRandomViews(),
                    sourceVideoId: sourceVideoId,
                    thumbnailUrl: `https://picsum.photos/seed/${i}/120/90`, // URL –∫ —Å–ª—É—á–∞–π–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω–∫–µ
                    timestamp: Date.now()
                };

                await tableAdapter.add(randomVideoData);
                log(`üíæ –î–∞–Ω–Ω—ã–µ —à–∞–≥–∞ ${i} –∑–∞–ø–∏—Å–∞–Ω—ã –≤ —Ç–∞–±–ª–∏—Ü—É.`, { module: 'TestScenario' });
            } catch (err) {
                log(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö —à–∞–≥–∞ ${i}: ${err.message}`, { module: 'TestScenario', level: 'error' });
            }
            // --- –ö–æ–Ω–µ—Ü –∑–∞–ø–∏—Å–∏ –¥–∞–Ω–Ω—ã—Ö ---

            // –ñ–¥–µ–º 1 —Å–µ–∫—É–Ω–¥—É
            await new Promise(resolve => setTimeout(resolve, 1000));
        }

        // 5. –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∏ —Å–Ω–æ–≤–∞ —É–∫–∞–∑—ã–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        log(`üéâ –¢–µ—Å—Ç–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω.`, { module: 'TestScenario' });
        log(`üß† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º: ${selectionModeLabel}`, { module: 'TestScenario' });
        log(`üî¢ –í—ã–ø–æ–ª–Ω–µ–Ω–æ —à–∞–≥–æ–≤: ${maxCount}`, { module: 'TestScenario' });
    }
};

=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\scenarios\test-countdown.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\logger.js ===



=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\logger.js ===

--------------------------------------------------------------------------------

=== START FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\storage.js ===



=== END FILE: D:\—Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞\youtube-parser-os\shared\storage.js ===

--------------------------------------------------------------------------------
